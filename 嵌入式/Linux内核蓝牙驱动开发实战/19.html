<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙连接管理 - Linux内核蓝牙驱动开发实战</title>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --accent: #FFC107;
            --light: #E8F5E9;
            --dark: #1B5E20;
            --text: #333333;
            --white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: linear-gradient(135deg, var(--light) 0%, #B3E5FC 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--primary);
            color: var(--white);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        h2 {
            color: var(--dark);
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--accent);
        }
        
        h3 {
            color: var(--secondary);
            margin: 1.5rem 0 0.5rem;
        }
        
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .section {
            margin-bottom: 3rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #E0E0E0;
        }
        
        th {
            background-color: var(--secondary);
            color: var(--white);
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #F5F5F5;
        }
        
        pre {
            background: #263238;
            color: #EEFFFF;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Consolas', 'Monaco', monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        code {
            background: #E3F2FD;
            color: var(--dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .svg-container {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .step-list {
            list-style-type: none;
            counter-reset: step-counter;
        }
        
        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 1rem;
            padding-left: 3rem;
            position: relative;
        }
        
        .step-list li:before {
            content: counter(step-counter);
            background: var(--primary);
            color: var(--white);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            top: 0;
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: var(--dark);
            font-weight: bold;
            border-top: 2px solid var(--accent);
        }
        
        .highlight {
            background: linear-gradient(120deg, var(--accent) 0%, var(--accent) 100%);
            background-repeat: no-repeat;
            background-size: 100% 0.3em;
            background-position: 0 88%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蓝牙连接管理</h1>
            <p>设备配对流程、连接建立维护、连接断开处理</p>
        </header>
        
        <div class="section">
            <div class="card">
                <h2>概述</h2>
                <p>蓝牙连接管理是蓝牙协议栈中的核心功能，负责设备间的配对、连接建立、维护和断开处理。在Linux内核中，蓝牙子系统通过多个层次协同工作，实现完整的连接管理功能。</p>
            </div>
        </div>
        
        <div class="section">
            <h2>设备配对流程</h2>
            <div class="card">
                <h3>配对概述</h3>
                <p>蓝牙配对是建立安全连接的关键步骤，涉及身份验证和密钥交换。Linux内核支持多种配对方法，包括传统配对和安全简单配对（SSP）。</p>
                
                <h3>配对方法对比</h3>
                <table>
                    <thead>
                        <tr>
                            <th>配对方法</th>
                            <th>安全性</th>
                            <th>复杂度</th>
                            <th>适用场景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>传统配对</td>
                            <td>低</td>
                            <td>简单</td>
                            <td>蓝牙2.0及以下设备</td>
                        </tr>
                        <tr>
                            <td>安全简单配对（SSP）</td>
                            <td>高</td>
                            <td>中等</td>
                            <td>蓝牙2.1及以上设备</td>
                        </tr>
                        <tr>
                            <td>LE安全连接</td>
                            <td>最高</td>
                            <td>复杂</td>
                            <td>蓝牙4.2及以上BLE设备</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>配对流程步骤</h3>
                <ol class="step-list">
                    <li><strong>配对请求</strong>：主设备向从设备发送配对请求，包含支持的配对方法和IO能力。</li>
                    <li><strong>IO能力交换</strong>：设备间交换输入输出能力，确定使用的配对方法。</li>
                    <li><strong>认证阶段</strong>：根据选择的配对方法进行身份验证（如PIN码输入、数字比较等）。</li>
                    <li><strong>短期密钥生成</strong>：生成用于加密连接的短期密钥（STK）。</li>
                    <li><strong>链路加密</strong>：使用生成的密钥对通信链路进行加密。</li>
                    <li><strong>长期密钥分发</strong>（可选）：分发长期密钥用于后续快速重连。</li>
                </ol>
                
                <h3>内核配对代码示例</h3>
                <pre><code>static int hci_pair_device(struct hci_dev *hdev, bdaddr_t *bdaddr, u8 sec_level)
{
    struct hci_conn *conn;
    int err;

    /* 查找或创建连接 */
    conn = hci_conn_hash_lookup_ba(hdev, ACL_LINK, bdaddr);
    if (!conn) {
        conn = hci_conn_add(hdev, ACL_LINK, bdaddr, HCI_ROLE_MASTER);
        if (!conn)
            return -ENOMEM;
    }

    /* 设置安全级别 */
    conn->pending_sec_level = sec_level;

    /* 启动认证过程 */
    err = hci_conn_auth(conn, sec_level, HCI_AT_NO_BONDING);
    if (err) {
        bt_dev_err(hdev, "authentication failed: %d", err);
        hci_conn_del(conn);
        return err;
    }

    return 0;
}</code></pre>
            </div>
        </div>
        
        <div class="section">
            <h2>连接建立与维护</h2>
            <div class="card">
                <h3>连接建立流程</h3>
                <p>蓝牙连接建立包括设备发现、连接请求、参数协商和链路建立等步骤。</p>
                
                <div class="svg-container">
                    <svg width="100%" height="200" viewBox="0 0 800 200">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                    refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#2196F3"/>
                            </marker>
                        </defs>
                        
                        <rect x="50" y="80" width="120" height="40" rx="5" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                        <text x="110" y="105" text-anchor="middle" fill="white" font-weight="bold">设备发现</text>
                        
                        <rect x="220" y="80" width="120" height="40" rx="5" fill="#2196F3" stroke="#1565C0" stroke-width="2"/>
                        <text x="280" y="105" text-anchor="middle" fill="white" font-weight="bold">连接请求</text>
                        
                        <rect x="390" y="80" width="120" height="40" rx="5" fill="#FF9800" stroke="#EF6C00" stroke-width="2"/>
                        <text x="450" y="105" text-anchor="middle" fill="white" font-weight="bold">参数协商</text>
                        
                        <rect x="560" y="80" width="120" height="40" rx="5" fill="#9C27B0" stroke="#6A1B9A" stroke-width="2"/>
                        <text x="620" y="105" text-anchor="middle" fill="white" font-weight="bold">链路建立</text>
                        
                        <line x1="170" y1="100" x2="220" y2="100" stroke="#2196F3" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="340" y1="100" x2="390" y2="100" stroke="#2196F3" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="510" y1="100" x2="560" y2="100" stroke="#2196F3" stroke-width="2" marker-end="url(#arrowhead)"/>
                    </svg>
                </div>
                
                <h3>连接参数</h3>
                <table>
                    <thead>
                        <tr>
                            <th>参数</th>
                            <th>描述</th>
                            <th>典型值</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>连接间隔</td>
                            <td>主从设备通信的时间间隔</td>
                            <td>7.5ms - 4s</td>
                        </tr>
                        <tr>
                            <td>从设备延迟</td>
                            <td>从设备可以跳过的连接事件数</td>
                            <td>0 - 499</td>
                        </tr>
                        <tr>
                            <td>监控超时</td>
                            <td>连接超时时间</td>
                            <td>100ms - 32s</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>连接维护机制</h3>
                <ul>
                    <li><strong>链路监控</strong>：定期检查连接状态，检测连接丢失</li>
                    <li><strong>参数更新</strong>：动态调整连接参数以适应应用需求</li>
                    <li><strong>重传机制</strong>：处理数据包丢失，确保可靠传输</li>
                    <li><strong>流量控制</strong>：管理数据流，防止缓冲区溢出</li>
                </ul>
                
                <h3>连接建立代码示例</h3>
                <pre><code>/* 创建ACL连接 */
struct hci_conn *hci_connect_acl(struct hci_dev *hdev, bdaddr_t *dst,
                                 u8 sec_level, u8 auth_type)
{
    struct hci_conn *acl;
    
    /* 检查设备是否已连接 */
    acl = hci_conn_hash_lookup_ba(hdev, ACL_LINK, dst);
    if (acl) {
        if (acl->state == BT_CONNECTED)
            return acl;
        hci_conn_del(acl);
    }
    
    /* 创建新的ACL连接 */
    acl = hci_conn_add(hdev, ACL_LINK, dst, HCI_ROLE_MASTER);
    if (!acl)
        return ERR_PTR(-ENOMEM);
    
    /* 设置安全参数 */
    acl->sec_level = sec_level;
    acl->auth_type = auth_type;
    acl->pending_sec_level = sec_level;
    
    /* 启动连接过程 */
    hci_conn_hold(acl);
    acl->state = BT_CONNECT;
    
    /* 发送连接请求 */
    hci_send_cmd(hdev, HCI_OP_CREATE_CONN, sizeof(*dst), dst);
    
    return acl;
}</code></pre>
            </div>
        </div>
        
        <div class="section">
            <h2>连接断开处理</h2>
            <div class="card">
                <h3>断开原因分类</h3>
                <table>
                    <thead>
                        <tr>
                            <th>断开原因</th>
                            <th>描述</th>
                            <th>处理方式</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>用户主动断开</td>
                            <td>用户或应用程序主动终止连接</td>
                            <td>清理资源，通知应用层</td>
                        </tr>
                        <tr>
                            <td>链路质量差</td>
                            <td>信号弱、干扰导致的连接丢失</td>
                            <td>尝试重连，优化参数</td>
                        </tr>
                        <tr>
                            <td>设备超出范围</td>
                            <td>设备距离过远导致连接中断</td>
                            <td>等待设备返回或主动扫描</td>
                        </tr>
                        <tr>
                            <td>资源不足</td>
                            <td>内存、电量等资源耗尽</td>
                            <td>释放资源，降低功耗</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>断开处理流程</h3>
                <div class="svg-container">
                    <svg width="100%" height="300" viewBox="0 0 800 300">
                        <defs>
                            <marker id="arrowhead2" markerWidth="10" markerHeight="7" 
                                    refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#F44336"/>
                            </marker>
                        </defs>
                        
                        <rect x="100" y="50" width="200" height="40" rx="5" fill="#F44336" stroke="#C62828" stroke-width="2"/>
                        <text x="200" y="75" text-anchor="middle" fill="white" font-weight="bold">检测连接断开</text>
                        
                        <rect x="100" y="120" width="200" height="40" rx="5" fill="#FF9800" stroke="#EF6C00" stroke-width="2"/>
                        <text x="200" y="145" text-anchor="middle" fill="white" font-weight="bold">分析断开原因</text>
                        
                        <rect x="100" y="190" width="200" height="40" rx="5" fill="#2196F3" stroke="#1565C0" stroke-width="2"/>
                        <text x="200" y="215" text-anchor="middle" fill="white" font-weight="bold">执行清理操作</text>
                        
                        <rect x="500" y="120" width="200" height="40" rx="5" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                        <text x="600" y="145" text-anchor="middle" fill="white" font-weight="bold">通知应用层</text>
                        
                        <line x1="200" y1="90" x2="200" y2="120" stroke="#F44336" stroke-width="2" marker-end="url(#arrowhead2)"/>
                        <line x1="200" y1="160" x2="200" y2="190" stroke="#F44336" stroke-width="2" marker-end="url(#arrowhead2)"/>
                        <line x1="300" y1="210" x2="500" y2="140" stroke="#F44336" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    </svg>
                </div>
                
                <h3>断开处理策略</h3>
                <ul>
                    <li><strong>优雅断开</strong>：发送断开请求，等待确认后再清理资源</li>
                    <li><strong>强制断开</strong>：立即终止连接，适用于紧急情况</li>
                    <li><strong>自动重连</strong>：根据策略尝试重新建立连接</li>
                    <li><strong>状态同步</strong>：确保所有层次的状态一致性</li>
                </ul>
                
                <h3>连接断开代码示例</h3>
                <pre><code>/* 处理连接断开 */
void hci_disconn_complete_evt(struct hci_dev *hdev, struct sk_buff *skb)
{
    struct hci_ev_disconn_complete *ev = (void *) skb->data;
    struct hci_conn *conn;

    BT_DBG("%s status %d", hdev->name, ev->status);

    hci_dev_lock(hdev);

    /* 查找对应的连接 */
    conn = hci_conn_hash_lookup_handle(hdev, __le16_to_cpu(ev->handle));
    if (!conn)
        goto unlock;

    /* 更新连接状态 */
    conn->state = BT_CLOSED;

    /* 根据断开原因采取不同处理 */
    switch (ev->reason) {
    case HCI_ERROR_REMOTE_USER_TERM:
        bt_dev_info(hdev, "Connection closed by remote user");
        break;
    case HCI_ERROR_REMOTE_LOW_RESOURCES:
        bt_dev_info(hdev, "Remote device out of resources");
        break;
    case HCI_ERROR_REMOTE_POWER_OFF:
        bt_dev_info(hdev, "Remote device powered off");
        break;
    default:
        bt_dev_info(hdev, "Disconnected for reason %d", ev->reason);
    }

    /* 清理连接资源 */
    hci_conn_del(conn);

unlock:
    hci_dev_unlock(hdev);
}</code></pre>
            </div>
        </div>
        
        <div class="section">
            <div class="card">
                <h2>总结</h2>
                <p>蓝牙连接管理是蓝牙通信的基础，涉及复杂的协议交互和状态管理。在Linux内核中，蓝牙子系统通过精心设计的架构和算法，实现了高效可靠的连接管理功能。</p>
                <p>关键要点：</p>
                <ul>
                    <li>配对过程确保连接的安全性</li>
                    <li>连接建立需要考虑多种参数和场景</li>
                    <li>连接维护需要持续监控和优化</li>
                    <li>断开处理需要保证资源正确释放和状态同步</li>
                </ul>
            </div>
        </div>
        
        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>