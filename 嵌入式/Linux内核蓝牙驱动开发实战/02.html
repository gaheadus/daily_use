<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux内核蓝牙驱动开发实战 - 内核驱动基础</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #0288d1;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: #0288d1;
            padding: 15px;
        }

        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
        }

        nav li {
            margin: 0 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        section {
            margin-bottom: 40px;
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #4fc3f7;
        }

        h2 {
            color: #0288d1;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #b3e5fc;
        }

        h3 {
            color: #0097a7;
            margin: 15px 0 10px 0;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th {
            background: #4fc3f7;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0f7fa;
        }

        tr:nth-child(even) {
            background: #f5fdff;
        }

        pre {
            background: #f5fdff;
            border-left: 4px solid #4fc3f7;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.4;
        }

        code {
            background: #e1f5fe;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .svg-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .highlight {
            background: #fff9c4;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd54f;
            margin: 15px 0;
        }

        footer {
            background: #0288d1;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            font-size: 1.1em;
        }

        .card {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .card-item {
            flex: 1;
            min-width: 250px;
            background: #e1f5fe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .card-item h4 {
            color: #0288d1;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Linux内核蓝牙驱动开发实战</h1>
            <p class="subtitle">第二章：Linux内核驱动基础</p>
        </header>

        <nav>
            <ul>
                <li><a href="#module">内核模块机制</a></li>
                <li><a href="#char-device">字符设备驱动</a></li>
                <li><a href="#device-tree">设备树基础</a></li>
            </ul>
        </nav>

        <div class="content">
            <section id="module">
                <h2>Linux内核模块机制</h2>
                <p>Linux内核模块是一种可以在运行时动态加载到内核中的代码，它们扩展了内核的功能而无需重新编译整个内核或重启系统。</p>
                
                <div class="card">
                    <div class="card-item">
                        <h4>模块的优势</h4>
                        <ul>
                            <li>减小内核镜像大小</li>
                            <li>灵活加载和卸载</li>
                            <li>便于调试和开发</li>
                            <li>降低系统资源占用</li>
                        </ul>
                    </div>
                    <div class="card-item">
                        <h4>模块的组成</h4>
                        <ul>
                            <li>模块初始化函数</li>
                            <li>模块退出函数</li>
                            <li>模块信息声明</li>
                            <li>模块许可证声明</li>
                        </ul>
                    </div>
                </div>

                <h3>模块基本结构</h3>
                <pre><code>#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;

// 模块初始化函数
static int __init hello_init(void)
{
    printk(KERN_INFO "Hello, Linux kernel module!\n");
    return 0;
}

// 模块退出函数
static void __exit hello_exit(void)
{
    printk(KERN_INFO "Goodbye, Linux kernel module!\n");
}

// 注册模块初始化和退出函数
module_init(hello_init);
module_exit(hello_exit);

// 模块信息
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("A simple Linux kernel module");</code></pre>

                <h3>模块操作命令</h3>
                <table>
                    <tr>
                        <th>命令</th>
                        <th>功能</th>
                        <th>示例</th>
                    </tr>
                    <tr>
                        <td>insmod</td>
                        <td>加载模块到内核</td>
                        <td>insmod hello.ko</td>
                    </tr>
                    <tr>
                        <td>rmmod</td>
                        <td>从内核卸载模块</td>
                        <td>rmmod hello</td>
                    </tr>
                    <tr>
                        <td>modprobe</td>
                        <td>智能加载模块（处理依赖）</td>
                        <td>modprobe hello</td>
                    </tr>
                    <tr>
                        <td>lsmod</td>
                        <td>列出已加载的模块</td>
                        <td>lsmod | grep hello</td>
                    </tr>
                    <tr>
                        <td>modinfo</td>
                        <td>显示模块信息</td>
                        <td>modinfo hello.ko</td>
                    </tr>
                </table>

                <div class="svg-container">
                    <svg width="600" height="200" viewBox="0 0 600 200">
                        <rect x="50" y="50" width="100" height="60" fill="#4fc3f7" stroke="#0288d1" stroke-width="2"/>
                        <text x="100" y="85" text-anchor="middle" fill="white" font-weight="bold">用户空间</text>
                        
                        <rect x="200" y="50" width="100" height="60" fill="#81c784" stroke="#388e3c" stroke-width="2"/>
                        <text x="250" y="85" text-anchor="middle" fill="white" font-weight="bold">insmod</text>
                        
                        <rect x="350" y="50" width="100" height="60" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                        <text x="400" y="85" text-anchor="middle" fill="white" font-weight="bold">内核空间</text>
                        
                        <rect x="450" y="50" width="100" height="60" fill="#e57373" stroke="#d32f2f" stroke-width="2"/>
                        <text x="500" y="85" text-anchor="middle" fill="white" font-weight="bold">模块</text>
                        
                        <path d="M150 80 L200 80" stroke="#0288d1" stroke-width="2" fill="none"/>
                        <path d="M300 80 L350 80" stroke="#0288d1" stroke-width="2" fill="none"/>
                        <path d="M450 80 L500 80" stroke="#0288d1" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                        
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#0288d1"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </section>

            <section id="char-device">
                <h2>字符设备驱动框架</h2>
                <p>字符设备是Linux设备驱动中最基本的一类设备，它们以字节流的方式进行数据传输，如键盘、鼠标、串口等。</p>
                
                <h3>字符设备驱动核心结构</h3>
                <div class="card">
                    <div class="card-item">
                        <h4>file_operations</h4>
                        <p>定义设备文件操作函数指针的结构体，包含open、read、write、ioctl等操作。</p>
                    </div>
                    <div class="card-item">
                        <h4>cdev</h4>
                        <p>字符设备结构体，用于管理字符设备的注册和操作。</p>
                    </div>
                    <div class="card-item">
                        <h4>设备号</h4>
                        <p>主设备号标识设备类型，次设备号标识具体设备实例。</p>
                    </div>
                </div>

                <h3>字符设备驱动开发步骤</h3>
                <ol>
                    <li>分配设备号（静态或动态）</li>
                    <li>初始化cdev结构体</li>
                    <li>实现file_operations操作函数</li>
                    <li>注册字符设备到系统</li>
                    <li>创建设备文件节点</li>
                </ol>

                <h3>字符设备驱动示例</h3>
                <pre><code>#include &lt;linux/module.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/cdev.h&gt;
#include &lt;linux/device.h&gt;

#define DEVICE_NAME "my_char_dev"
#define CLASS_NAME "my_char_class"

static int major_num;
static struct class* char_class = NULL;
static struct device* char_device = NULL;
static struct cdev my_cdev;

// 设备打开函数
static int dev_open(struct inode *inodep, struct file *filep)
{
    printk(KERN_INFO "My char device opened\n");
    return 0;
}

// 设备读取函数
static ssize_t dev_read(struct file *filep, char *buffer, size_t len, loff_t *offset)
{
    printk(KERN_INFO "My char device read\n");
    return 0;
}

// 设备写入函数
static ssize_t dev_write(struct file *filep, const char *buffer, size_t len, loff_t *offset)
{
    printk(KERN_INFO "My char device write\n");
    return len;
}

// 文件操作结构体
static struct file_operations fops = {
    .open = dev_open,
    .read = dev_read,
    .write = dev_write,
};

// 模块初始化函数
static int __init char_dev_init(void)
{
    printk(KERN_INFO "Initializing my char device\n");
    
    // 动态分配主设备号
    major_num = register_chrdev(0, DEVICE_NAME, &fops);
    if (major_num < 0) {
        printk(KERN_ALERT "Failed to register char device\n");
        return major_num;
    }
    
    // 创建设备类
    char_class = class_create(THIS_MODULE, CLASS_NAME);
    if (IS_ERR(char_class)) {
        unregister_chrdev(major_num, DEVICE_NAME);
        printk(KERN_ALERT "Failed to create device class\n");
        return PTR_ERR(char_class);
    }
    
    // 创建设备节点
    char_device = device_create(char_class, NULL, MKDEV(major_num, 0), NULL, DEVICE_NAME);
    if (IS_ERR(char_device)) {
        class_destroy(char_class);
        unregister_chrdev(major_num, DEVICE_NAME);
        printk(KERN_ALERT "Failed to create device\n");
        return PTR_ERR(char_device);
    }
    
    printk(KERN_INFO "My char device registered with major number %d\n", major_num);
    return 0;
}

// 模块退出函数
static void __exit char_dev_exit(void)
{
    device_destroy(char_class, MKDEV(major_num, 0));
    class_unregister(char_class);
    class_destroy(char_class);
    unregister_chrdev(major_num, DEVICE_NAME);
    printk(KERN_INFO "My char device unregistered\n");
}

module_init(char_dev_init);
module_exit(char_dev_exit);</code></pre>

                <div class="svg-container">
                    <svg width="700" height="300" viewBox="0 0 700 300">
                        <!-- 用户空间 -->
                        <rect x="50" y="50" width="600" height="60" fill="#e3f2fd" stroke="#90caf9" stroke-width="2"/>
                        <text x="350" y="85" text-anchor="middle" fill="#1565c0" font-weight="bold">用户空间 (User Space)</text>
                        
                        <!-- 系统调用接口 -->
                        <rect x="50" y="120" width="600" height="40" fill="#f3e5f5" stroke="#ce93d8" stroke-width="2"/>
                        <text x="350" y="145" text-anchor="middle" fill="#7b1fa2" font-weight="bold">系统调用接口 (System Call Interface)</text>
                        
                        <!-- VFS层 -->
                        <rect x="50" y="170" width="600" height="40" fill="#e8f5e8" stroke="#a5d6a7" stroke-width="2"/>
                        <text x="350" y="195" text-anchor="middle" fill="#2e7d32" font-weight="bold">虚拟文件系统 (VFS)</text>
                        
                        <!-- 字符设备驱动 -->
                        <rect x="50" y="220" width="600" height="40" fill="#fff3e0" stroke="#ffcc80" stroke-width="2"/>
                        <text x="350" y="245" text-anchor="middle" fill="#ef6c00" font-weight="bold">字符设备驱动 (Character Device Driver)</text>
                        
                        <!-- 连接线 -->
                        <path d="M350 110 L350 120" stroke="#90caf9" stroke-width="2" fill="none"/>
                        <path d="M350 160 L350 170" stroke="#90caf9" stroke-width="2" fill="none"/>
                        <path d="M350 210 L350 220" stroke="#90caf9" stroke-width="2" fill="none"/>
                        
                        <!-- 箭头 -->
                        <path d="M340 115 L350 125 L360 115" fill="#90caf9"/>
                        <path d="M340 165 L350 175 L360 165" fill="#90caf9"/>
                        <path d="M340 215 L350 225 L360 215" fill="#90caf9"/>
                    </svg>
                </div>
            </section>

            <section id="device-tree">
                <h2>设备树基础概念</h2>
                <p>设备树（Device Tree）是一种描述硬件资源的数据结构，用于将硬件的配置信息从内核代码中分离出来，实现驱动代码与硬件平台的解耦。</p>
                
                <div class="highlight">
                    <p><strong>设备树的主要作用：</strong>解决ARM架构下板级支持包（BSP）代码冗余问题，提供一种标准的硬件描述方法。</p>
                </div>

                <h3>设备树组成结构</h3>
                <table>
                    <tr>
                        <th>组成部分</th>
                        <th>描述</th>
                        <th>示例</th>
                    </tr>
                    <tr>
                        <td>节点 (Node)</td>
                        <td>描述设备或总线的容器</td>
                        <td>uart0: serial@101f0000 { ... }</td>
                    </tr>
                    <tr>
                        <td>属性 (Property)</td>
                        <td>描述节点的特征和配置</td>
                        <td>compatible = "ns16550a";</td>
                    </tr>
                    <tr>
                        <td>兼容性 (Compatible)</td>
                        <td>用于驱动与设备匹配的关键属性</td>
                        <td>compatible = "vendor,device";</td>
                    </tr>
                    <tr>
                        <td>寄存器 (Reg)</td>
                        <td>描述设备寄存器地址和大小</td>
                        <td>reg = &lt;0x101f0000 0x1000&gt;;</td>
                    </tr>
                    <tr>
                        <td>中断 (Interrupts)</td>
                        <td>描述设备中断信息</td>
                        <td>interrupts = &lt;0 12 4&gt;;</td>
                    </tr>
                </table>

                <h3>设备树示例</h3>
                <pre><code>// 设备树源文件示例 (dts)
/dts-v1/;

/ {
    model = "My Board";
    compatible = "mycompany,myboard";
    
    // CPU节点
    cpus {
        #address-cells = <1>;
        #size-cells = <0>;
        
        cpu@0 {
            device_type = "cpu";
            compatible = "arm,cortex-a53";
            reg = <0>;
        };
    };
    
    // 内存节点
    memory {
        device_type = "memory";
        reg = <0x80000000 0x20000000>;
    };
    
    // 外设总线
    soc {
        #address-cells = <1>;
        #size-cells = <1>;
        compatible = "simple-bus";
        ranges;
        
        // 串口设备
        uart0: serial@101f0000 {
            compatible = "ns16550a";
            reg = <0x101f0000 0x1000>;
            interrupts = <0 12 4>;
            clock-frequency = <1843200>;
            status = "okay";
        };
        
        // 蓝牙设备
        bluetooth {
            compatible = "broadcom,bcm43438-bt";
            max-speed = <2000000>;
            shutdown-gpios = <&gpio 45 0>;
            device-wakeup-gpios = <&gpio 47 0>;
            host-wakeup-gpios = <&gpio 46 0>;
            status = "okay";
        };
    };
};</code></pre>

                <h3>设备树与驱动匹配</h3>
                <div class="svg-container">
                    <svg width="650" height="250" viewBox="0 0 650 250">
                        <!-- 设备树 -->
                        <rect x="50" y="50" width="250" height="80" fill="#e1f5fe" stroke="#4fc3f7" stroke-width="2" rx="10"/>
                        <text x="175" y="85" text-anchor="middle" fill="#0288d1" font-weight="bold">设备树 (.dts)</text>
                        <text x="175" y="105" text-anchor="middle" fill="#0288d1">硬件描述</text>
                        
                        <!-- 编译过程 -->
                        <rect x="320" y="70" width="60" height="40" fill="#fff9c4" stroke="#ffd54f" stroke-width="2" rx="5"/>
                        <text x="350" y="95" text-anchor="middle" fill="#f57f17">DTC</text>
                        
                        <!-- 设备树Blob -->
                        <rect x="400" y="50" width="200" height="80" fill="#f3e5f5" stroke="#ce93d8" stroke-width="2" rx="10"/>
                        <text x="500" y="85" text-anchor="middle" fill="#7b1fa2" font-weight="bold">设备树Blob (.dtb)</text>
                        <text x="500" y="105" text-anchor="middle" fill="#7b1fa2">二进制格式</text>
                        
                        <!-- 内核 -->
                        <rect x="50" y="150" width="550" height="80" fill="#e8f5e8" stroke="#81c784" stroke-width="2" rx="10"/>
                        <text x="325" y="185" text-anchor="middle" fill="#2e7d32" font-weight="bold">Linux内核</text>
                        <text x="325" y="205" text-anchor="middle" fill="#2e7d32">驱动匹配与设备注册</text>
                        
                        <!-- 箭头 -->
                        <path d="M300 90 L320 90" stroke="#0288d1" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
                        <path d="M380 90 L400 90" stroke="#0288d1" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
                        <path d="M325 130 L325 150" stroke="#0288d1" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
                        
                        <defs>
                            <marker id="arrow2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#0288d1"/>
                            </marker>
                        </defs>
                    </svg>
                </div>

                <h3>设备树在驱动中的使用</h3>
                <pre><code>#include &lt;linux/module.h&gt;
#include &lt;linux/of.h&gt;
#include &lt;linux/platform_device.h&gt;

// 设备树匹配表
static const struct of_device_id my_driver_of_match[] = {
    { .compatible = "broadcom,bcm43438-bt" },
    { /* sentinel */ }
};
MODULE_DEVICE_TABLE(of, my_driver_of_match);

// 平台驱动结构体
static struct platform_driver my_bluetooth_driver = {
    .probe = my_bluetooth_probe,
    .remove = my_bluetooth_remove,
    .driver = {
        .name = "my-bluetooth",
        .of_match_table = my_driver_of_match,
    },
};

// 探测函数
static int my_bluetooth_probe(struct platform_device *pdev)
{
    struct device *dev = &pdev->dev;
    struct device_node *node = dev->of_node;
    
    // 从设备树获取GPIO
    int shutdown_gpio = of_get_named_gpio(node, "shutdown-gpios", 0);
    int device_wakeup_gpio = of_get_named_gpio(node, "device-wakeup-gpios", 0);
    int host_wakeup_gpio = of_get_named_gpio(node, "host-wakeup-gpios", 0);
    
    // 检查GPIO是否有效
    if (!gpio_is_valid(shutdown_gpio) || 
        !gpio_is_valid(device_wakeup_gpio) || 
        !gpio_is_valid(host_wakeup_gpio)) {
        dev_err(dev, "Invalid GPIO specified\n");
        return -EINVAL;
    }
    
    // 配置GPIO
    gpio_request(shutdown_gpio, "bt_shutdown");
    gpio_direction_output(shutdown_gpio, 0);
    
    // ... 其他初始化代码
    
    dev_info(dev, "Bluetooth device probed successfully\n");
    return 0;
}

// 驱动注册
module_platform_driver(my_bluetooth_driver);</code></pre>
            </section>

            <section>
                <h2>总结</h2>
                <div class="card">
                    <div class="card-item">
                        <h4>内核模块机制</h4>
                        <p>提供了动态扩展内核功能的机制，是驱动开发的基础。</p>
                    </div>
                    <div class="card-item">
                        <h4>字符设备驱动</h4>
                        <p>实现了用户空间与内核空间的数据交互，是大多数设备驱动的实现方式。</p>
                    </div>
                    <div class="card-item">
                        <h4>设备树</h4>
                        <p>实现了硬件描述与驱动代码的分离，提高了代码的可移植性和可维护性。</p>
                    </div>
                </div>
                <p>掌握这三个基础概念对于深入理解Linux内核驱动开发至关重要，特别是在蓝牙驱动开发中，这些知识将帮助我们更好地理解设备注册、数据传输和硬件控制等核心机制。</p>
            </section>
        </div>

        <footer>
            <p>蓝海资料掘金营</p>
        </footer>
    </div>
</body>
</html>