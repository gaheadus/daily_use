<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙HID协议驱动开发实战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(45deg, #4fc3f7, #81c784);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 30px;
            margin: 25px 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #4fc3f7;
        }

        h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #81c784;
        }

        h3 {
            color: #388e3c;
            margin: 20px 0 15px 0;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #f8fdf8;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #c8e6c9;
        }

        th {
            background-color: #81c784;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f1f8e9;
        }

        pre {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid #4fc3f7;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        code {
            background: #f0f4f8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }

        .architecture {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .svg-container {
            max-width: 800px;
            margin: 0 auto;
        }

        footer {
            text-align: center;
            padding: 30px;
            margin-top: 40px;
            color: #666;
            font-size: 1.1em;
            border-top: 2px solid #81c784;
        }

        .highlight {
            background: linear-gradient(120deg, #e1f5fe 0%, #e1f5fe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .note {
            background: #fff9c4;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd54f;
            margin: 15px 0;
        }

        .tip {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #66bb6a;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蓝牙HID协议驱动开发实战</h1>
            <div class="subtitle">HID描述符解析、HID报告传输、HID事件处理</div>
        </header>

        <div class="section">
            <h2>课程概述</h2>
            <p>本课程深入讲解Linux内核中蓝牙HID（Human Interface Device）协议驱动的开发实践。HID协议是蓝牙设备中用于人机交互设备（如键盘、鼠标、游戏手柄等）的重要协议。我们将从HID描述符解析开始，逐步深入到HID报告传输和事件处理机制。</p>
            
            <div class="tip">
                <strong>学习目标：</strong>掌握蓝牙HID协议的核心概念，理解Linux内核中HID驱动的实现原理，能够独立开发和调试蓝牙HID设备驱动。
            </div>
        </div>

        <div class="section">
            <h2>HID描述符解析</h2>
            <p>HID描述符是HID设备的核心数据结构，它定义了设备的功能特性和数据格式。在Linux内核中，HID描述符解析主要由<code>hid-core.c</code>模块负责。</p>
            
            <h3>HID描述符结构</h3>
            <table>
                <thead>
                    <tr>
                        <th>字段</th>
                        <th>大小(字节)</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>bLength</td>
                        <td>1</td>
                        <td>描述符总长度</td>
                    </tr>
                    <tr>
                        <td>bDescriptorType</td>
                        <td>1</td>
                        <td>描述符类型(HID)</td>
                    </tr>
                    <tr>
                        <td>bcdHID</td>
                        <td>2</td>
                        <td>HID规范版本号</td>
                    </tr>
                    <tr>
                        <td>bCountryCode</td>
                        <td>1</td>
                        <td>国家/地区代码</td>
                    </tr>
                    <tr>
                        <td>bNumDescriptors</td>
                        <td>1</td>
                        <td>下级描述符数量</td>
                    </tr>
                    <tr>
                        <td>bReportDescriptorType</td>
                        <td>1</td>
                        <td>报告描述符类型</td>
                    </tr>
                    <tr>
                        <td>wReportDescriptorLength</td>
                        <td>2</td>
                        <td>报告描述符长度</td>
                    </tr>
                </tbody>
            </table>

            <h3>报告描述符解析示例</h3>
            <pre><code>// HID报告描述符解析函数示例
static int hid_parse_report_descriptor(struct hid_device *hid, 
                                      __u8 *rdesc, unsigned int rsize)
{
    struct hid_parser *parser;
    struct hid_item item;
    int ret;
    
    parser = hid_parser_create(hid);
    if (!parser)
        return -ENOMEM;
    
    // 解析报告描述符
    while ((ret = hid_parser_get_item(parser, &item)) > 0) {
        switch (item.tag) {
        case HID_MAIN_ITEM_TAG_INPUT:
            // 处理输入项
            hid_parser_process_input(hid, parser, &item);
            break;
        case HID_MAIN_ITEM_TAG_OUTPUT:
            // 处理输出项
            hid_parser_process_output(hid, parser, &item);
            break;
        case HID_MAIN_ITEM_TAG_FEATURE:
            // 处理特性项
            hid_parser_process_feature(hid, parser, &item);
            break;
        case HID_MAIN_ITEM_TAG_COLLECTION:
            // 处理集合
            hid_parser_process_collection(hid, parser, &item);
            break;
        case HID_MAIN_ITEM_TAG_END_COLLECTION:
            // 结束集合
            hid_parser_process_end_collection(hid, parser, &item);
            break;
        }
    }
    
    hid_parser_destroy(parser);
    return ret;
}</code></pre>

            <div class="note">
                <strong>注意：</strong>HID报告描述符使用了一种紧凑的二进制格式，包含了一系列的项目（items），这些项目描述了设备的数据字段和它们的用途。
            </div>
        </div>

        <div class="section">
            <h2>HID报告传输</h2>
            <p>HID报告是HID设备与主机之间交换数据的单位。报告传输包括输入报告（设备到主机）、输出报告（主机到设备）和特性报告（双向）。</p>
            
            <h3>报告传输类型</h3>
            <table>
                <thead>
                    <tr>
                        <th>传输类型</th>
                        <th>方向</th>
                        <th>典型应用</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>输入报告(Input Report)</td>
                        <td>设备 → 主机</td>
                        <td>键盘按键、鼠标移动</td>
                    </tr>
                    <tr>
                        <td>输出报告(Output Report)</td>
                        <td>主机 → 设备</td>
                        <td>LED状态、力反馈</td>
                    </tr>
                    <tr>
                        <td>特性报告(Feature Report)</td>
                        <td>双向</td>
                        <td>设备配置、校准数据</td>
                    </tr>
                </tbody>
            </table>

            <h3>报告传输代码示例</h3>
            <pre><code>// HID报告接收处理
static void hid_input_report(struct hid_device *hid, int type, 
                            u8 *data, int size, int interrupt)
{
    struct hid_report *report;
    struct hid_field *field;
    int i, j;
    
    // 查找匹配的报告
    list_for_each_entry(report, &hid->report_enum[type].report_list, list) {
        if (report->size == size * 8) {
            // 处理报告数据
            for (i = 0; i < report->maxfield; i++) {
                field = report->field[i];
                for (j = 0; j < field->maxusage; j++) {
                    // 提取字段值
                    int value = hid_field_extract(hid, data, 
                                                field->report_offset + j, 
                                                field->report_size);
                    // 更新字段值
                    hid_input_field(hid, field, value);
                }
            }
            
            // 上报输入事件
            if (hid->claimed & HID_CLAIMED_INPUT)
                hidinput_hid_event(hid, report);
        }
    }
}

// 发送输出报告
int hid_output_report(struct hid_report *report, __u8 *data)
{
    struct hid_device *hid = report->device;
    int ret;
    
    // 准备报告数据
    memset(data, 0, (report->size + 7) / 8);
    hid_report_data(report, data);
    
    // 通过HID传输层发送
    ret = hid_hw_output_report(hid, data, (report->size + 7) / 8);
    if (ret < 0)
        dev_err(&hid->dev, "output report failed: %d\n", ret);
    
    return ret;
}</code></pre>
        </div>

        <div class="section">
            <h2>HID事件处理</h2>
            <p>HID事件处理是将原始的HID报告数据转换为标准的输入子系统事件的过程。Linux内核通过输入子系统（Input Subsystem）来统一处理各种输入设备的事件。</p>
            
            <h3>事件处理流程</h3>
            <ol>
                <li><strong>报告接收：</strong>蓝牙HID驱动接收来自设备的HID报告</li>
                <li><strong>数据解析：</strong>根据HID描述符解析报告数据</li>
                <li><strong>事件转换：</strong>将HID数据转换为输入事件</li>
                <li><strong>事件上报：</strong>通过输入子系统上报事件</li>
                <li><strong>用户空间处理：</strong>应用程序通过evdev接口读取事件</li>
            </ol>

            <h3>事件处理代码示例</h3>
            <pre><code>// HID输入事件处理
static void hidinput_hid_event(struct hid_device *hid, struct hid_report *report)
{
    struct hid_input *hidinput;
    struct input_dev *input;
    int i, j;
    
    list_for_each_entry(hidinput, &hid->inputs, list) {
        input = hidinput->input;
        
        for (i = 0; i < report->maxfield; i++) {
            struct hid_field *field = report->field[i];
            
            for (j = 0; j < field->maxusage; j++) {
                struct hid_usage *usage = &field->usage[j];
                unsigned value = field->value[j];
                
                if (usage->type == EV_KEY) {
                    // 按键事件
                    input_event(input, EV_KEY, usage->code, value);
                } else if (usage->type == EV_REL) {
                    // 相对坐标事件（鼠标移动）
                    input_event(input, EV_REL, usage->code, value);
                } else if (usage->type == EV_ABS) {
                    // 绝对坐标事件（触摸屏）
                    input_event(input, EV_ABS, usage->code, value);
                }
            }
        }
        
        // 同步事件，表示一组事件结束
        input_sync(input);
    }
}

// 键盘特定事件处理
static void hidinput_keyboard_event(struct hid_device *hid, 
                                   struct hid_field *field, 
                                   struct hid_usage *usage, 
                                   __s32 value)
{
    struct input_dev *input;
    struct hid_input *hidinput;
    
    list_for_each_entry(hidinput, &hid->inputs, list) {
        input = hidinput->input;
        
        if (usage->type == EV_KEY && 
            (usage->hat_code < 0xf0 || usage->hat_code > 0xf3)) {
            // 处理普通按键
            input_event(input, usage->type, usage->code, value);
        } else if (usage->type == EV_LED) {
            // 处理LED状态
            input_event(input, usage->type, usage->code, value);
        }
    }
}</code></pre>
        </div>

        <div class="architecture">
            <h2>蓝牙HID驱动软件架构</h2>
            <div class="svg-container">
                <svg width="800" height="400" viewBox="0 0 800 400">
                    <!-- 背景 -->
                    <rect width="800" height="400" fill="#f9fbe7" rx="10"/>
                    
                    <!-- 应用层 -->
                    <rect x="50" y="50" width="700" height="60" fill="#4fc3f7" rx="8"/>
                    <text x="400" y="85" text-anchor="middle" fill="white" font-size="16" font-weight="bold">用户空间应用程序</text>
                    
                    <!-- 输入子系统 -->
                    <rect x="50" y="130" width="700" height="60" fill="#81c784" rx="8"/>
                    <text x="400" y="165" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Linux输入子系统 (Input Subsystem)</text>
                    
                    <!-- HID核心层 -->
                    <rect x="50" y="210" width="700" height="60" fill="#ffb74d" rx="8"/>
                    <text x="400" y="245" text-anchor="middle" fill="white" font-size="16" font-weight="bold">HID核心层 (hid-core)</text>
                    
                    <!-- 蓝牙HID驱动 -->
                    <rect x="50" y="290" width="700" height="60" fill="#ba68c8" rx="8"/>
                    <text x="400" y="325" text-anchor="middle" fill="white" font-size="16" font-weight="bold">蓝牙HID协议驱动 (Bluetooth HIDP)</text>
                    
                    <!-- 连接箭头 -->
                    <line x1="400" y1="110" x2="400" y2="130" stroke="#666" stroke-width="2"/>
                    <line x1="400" y1="190" x2="400" y2="210" stroke="#666" stroke-width="2"/>
                    <line x1="400" y1="270" x2="400" y2="290" stroke="#666" stroke-width="2"/>
                    
                    <!-- 箭头头部 -->
                    <polygon points="395,130 405,130 400,120" fill="#666"/>
                    <polygon points="395,210 405,210 400,200" fill="#666"/>
                    <polygon points="395,290 405,290 400,280" fill="#666"/>
                </svg>
            </div>
        </div>

        <div class="section">
            <h2>实践要点与调试技巧</h2>
            
            <h3>开发注意事项</h3>
            <ul>
                <li><strong>描述符兼容性：</strong>确保HID描述符符合HID规范，不同设备厂商的实现可能有差异</li>
                <li><strong>报告大小对齐：</strong>注意报告大小的字节对齐问题，避免数据传输错误</li>
                <li><strong>电源管理：</strong>合理处理设备的挂起和恢复，确保低功耗运行</li>
                <li><strong>错误处理：</strong>完善错误处理机制，提高驱动稳定性</li>
            </ul>
            
            <h3>调试技巧</h3>
            <table>
                <thead>
                    <tr>
                        <th>调试方法</th>
                        <th>命令/工具</th>
                        <th>用途</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>内核日志</td>
                        <td><code>dmesg | grep hid</code></td>
                        <td>查看HID驱动加载和运行日志</td>
                    </tr>
                    <tr>
                        <td>HID设备信息</td>
                        <td><code>cat /sys/kernel/debug/hid/*/rdesc</code></td>
                        <td>查看HID报告描述符</td>
                    </tr>
                    <tr>
                        <td>输入设备测试</td>
                        <td><code>evtest</code></td>
                        <td>测试输入设备事件</td>
                    </tr>
                    <tr>
                        <td>蓝牙监控</td>
                        <td><code>hcidump</code></td>
                        <td>监控蓝牙HCI数据包</td>
                    </tr>
                    <tr>
                        <td>HID工具</td>
                        <td><code>hid-recorder</code></td>
                        <td>记录和分析HID报告</td>
                    </tr>
                </tbody>
            </table>

            <div class="tip">
                <strong>调试提示：</strong>使用<code>CONFIG_HID_DEBUG</code>配置选项启用HID调试支持，可以获得更详细的调试信息。
            </div>
        </div>

        <footer>
            <p>蓝海资料掘金营</p>
        </footer>
    </div>
</body>
</html>