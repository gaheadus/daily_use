<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙驱动维护实战指南</title>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #FFC107;
            --accent: #2196F3;
            --light: #E8F5E9;
            --dark: #2E7D32;
            --text: #333333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--light) 0%, #E3F2FD 100%);
            color: var(--text);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        section {
            background: white;
            margin: 30px 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 5px solid var(--secondary);
        }
        
        h2 {
            color: var(--dark);
            border-bottom: 2px dashed var(--secondary);
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        h3 {
            color: var(--accent);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f8e9;
        }
        
        .code-block {
            background: #f5f5f5;
            border-left: 4px solid var(--accent);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        
        .svg-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .step-list {
            counter-reset: step-counter;
            list-style-type: none;
            padding-left: 0;
        }
        
        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 20px;
            padding-left: 60px;
            position: relative;
        }
        
        .step-list li:before {
            content: counter(step-counter);
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            top: 0;
        }
        
        footer {
            text-align: center;
            padding: 30px;
            margin-top: 50px;
            background: linear-gradient(45deg, var(--dark), var(--primary));
            color: white;
            border-radius: 20px 20px 0 0;
            font-size: 1.2rem;
        }
        
        .highlight {
            background-color: var(--secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .tip-box {
            background-color: #E3F2FD;
            border-left: 4px solid var(--accent);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>蓝牙驱动维护实战指南</h1>
            <div class="subtitle">版本兼容性、Bug修复流程、社区贡献指南</div>
        </div>
    </header>
    
    <div class="container">
        <section>
            <h2>课程简介</h2>
            <p>本课程深入探讨Linux内核蓝牙驱动的维护实践，涵盖版本兼容性管理、Bug修复流程以及如何向开源社区贡献代码。通过本课程，您将掌握蓝牙驱动维护的核心技能，成为Linux蓝牙开发领域的专家。</p>
            
            <div class="svg-container">
                <svg width="600" height="200" viewBox="0 0 600 200">
                    <rect x="50" y="50" width="100" height="100" rx="10" fill="#4CAF50" opacity="0.8"/>
                    <text x="100" y="110" text-anchor="middle" fill="white" font-weight="bold">版本兼容性</text>
                    
                    <rect x="200" y="50" width="100" height="100" rx="10" fill="#FFC107" opacity="0.8"/>
                    <text x="250" y="110" text-anchor="middle" fill="white" font-weight="bold">Bug修复</text>
                    
                    <rect x="350" y="50" width="100" height="100" rx="10" fill="#2196F3" opacity="0.8"/>
                    <text x="400" y="110" text-anchor="middle" fill="white" font-weight="bold">社区贡献</text>
                    
                    <line x1="150" y1="100" x2="200" y2="100" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <line x1="300" y1="100" x2="350" y2="100" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>
        
        <section>
            <h2>版本兼容性管理</h2>
            <p>Linux内核蓝牙子系统不断发展，保持版本兼容性是驱动维护的关键挑战。</p>
            
            <h3>内核API变化跟踪</h3>
            <p>蓝牙驱动需要适应不同内核版本的API变化。以下是一些常见的兼容性处理技巧：</p>
            
            <div class="code-block">
<pre>
#ifdef LINUX_VERSION_CODE
#if LINUX_VERSION_CODE < KERNEL_VERSION(5, 10, 0)
    /* 旧版本内核代码 */
    struct hci_dev *hdev = hci_alloc_dev();
#else
    /* 新版本内核代码 */
    struct hci_dev *hdev = hci_alloc_dev_priv(sizeof(struct my_priv_data));
#endif
#endif
</pre>
            </div>
            
            <h3>蓝牙协议版本兼容性</h3>
            <table>
                <thead>
                    <tr>
                        <th>蓝牙版本</th>
                        <th>内核支持版本</th>
                        <th>主要特性</th>
                        <th>兼容性注意事项</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Bluetooth 4.0 (BLE)</td>
                        <td>Linux 3.5+</td>
                        <td>低功耗、GATT</td>
                        <td>需要CONFIG_BT_LE配置</td>
                    </tr>
                    <tr>
                        <td>Bluetooth 4.2</td>
                        <td>Linux 4.1+</td>
                        <td>LE安全连接、数据长度扩展</td>
                        <td>注意加密算法变化</td>
                    </tr>
                    <tr>
                        <td>Bluetooth 5.0</td>
                        <td>Linux 4.10+</td>
                        <td>2M PHY、LE广告扩展</td>
                        <td>需要更新hci_core.c</td>
                    </tr>
                    <tr>
                        <td>Bluetooth 5.1</td>
                        <td>Linux 5.0+</td>
                        <td>寻向功能</td>
                        <td>需要硬件支持</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="tip-box">
                <strong>提示：</strong> 使用<code>git log --oneline drivers/bluetooth/</code>命令跟踪蓝牙驱动的变化，了解API演进历史。
            </div>
        </section>
        
        <section>
            <h2>Bug修复流程</h2>
            <p>系统化的Bug修复流程是保证驱动质量的关键。</p>
            
            <h3>Bug修复标准流程</h3>
            <ol class="step-list">
                <li>
                    <strong>问题重现</strong>
                    <p>创建最小化测试环境，确保能够稳定重现问题。记录重现步骤、内核版本、硬件信息等。</p>
                </li>
                <li>
                    <strong>问题分析</strong>
                    <p>使用内核调试工具（如ftrace、kprobe）定位问题根源。分析内核日志和堆栈跟踪。</p>
                </li>
                <li>
                    <strong>修复方案设计</strong>
                    <p>设计最小化修复方案，确保不引入回归问题。考虑向后兼容性和性能影响。</p>
                </li>
                <li>
                    <strong>代码实现与测试</strong>
                    <p>实现修复代码，编写测试用例验证修复效果。进行回归测试确保不影响现有功能。</p>
                </li>
                <li>
                    <strong>提交修复</strong>
                    <p>按照内核提交规范创建补丁，发送到相应的邮件列表进行审查。</p>
                </li>
            </ol>
            
            <h3>常见蓝牙驱动Bug类型</h3>
            <table>
                <thead>
                    <tr>
                        <th>Bug类型</th>
                        <th>症状</th>
                        <th>调试方法</th>
                        <th>修复策略</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>内存泄漏</td>
                        <td>系统内存逐渐减少，最终OOM</td>
                        <td>kmemleak, slabinfo</td>
                        <td>检查sk_buff、hci_dev等资源释放</td>
                    </tr>
                    <tr>
                        <td>竞态条件</td>
                        <td>随机性崩溃、数据损坏</td>
                        <td>lockdep, KCSAN</td>
                        <td>正确使用锁机制，避免死锁</td>
                    </tr>
                    <tr>
                        <td>电源管理</td>
                        <td>唤醒失败、功耗异常</td>
                        <td>powertop, pm_debug</td>
                        <td>正确实现suspend/resume回调</td>
                    </tr>
                    <tr>
                        <td>HCI命令超时</td>
                        <td>设备无响应、连接失败</td>
                        <td>hcidump, btmon</td>
                        <td>增加超时处理，重置控制器</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>调试示例：HCI命令超时修复</h3>
            <div class="code-block">
<pre>
static int btusb_submit_bulk_urb(struct hci_dev *hdev, gfp_t mem_flags)
{
    struct btusb_data *data = hci_get_drvdata(hdev);
    struct urb *urb;
    unsigned char *buf;
    unsigned int pipe;
    int err;
    
    /* 修复: 增加超时检查 */
    if (test_bit(BTUSB_DISCONNECTING, &data->flags)) {
        bt_dev_err(hdev, "Device disconnecting, skip submit URB");
        return -ENODEV;
    }
    
    urb = usb_alloc_urb(0, mem_flags);
    if (!urb)
        return -ENOMEM;
    
    /* ... 其余代码保持不变 ... */
    
    /* 修复: 设置合理的超时时间 */
    usb_fill_bulk_urb(urb, data->udev, pipe, buf, size,
                      btusb_bulk_complete, hdev);
    urb->transfer_flags = URB_FREE_BUFFER;
    urb->timeout = msecs_to_jiffies(5000);  /* 5秒超时 */
    
    usb_anchor_urb(urb, &data->bulk_anchor);
    err = usb_submit_urb(urb, mem_flags);
    if (err < 0) {
        bt_dev_err(hdev, "Failed to submit bulk URB: %d", err);
        usb_unanchor_urb(urb);
    }
    
    usb_free_urb(urb);
    return err;
}
</pre>
            </div>
        </section>
        
        <section>
            <h2>社区贡献指南</h2>
            <p>向Linux内核社区贡献代码需要遵循特定的流程和规范。</p>
            
            <h3>贡献流程</h3>
            <div class="svg-container">
                <svg width="600" height="300" viewBox="0 0 600 300">
                    <!-- 流程箭头 -->
                    <path d="M 50,50 L 150,50 L 150,100 L 50,100 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="100" y="75" text-anchor="middle" fill="#2196F3">1. 发现问题</text>
                    
                    <path d="M 200,50 L 300,50 L 300,100 L 200,100 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="250" y="75" text-anchor="middle" fill="#2196F3">2. 开发修复</text>
                    
                    <path d="M 350,50 L 450,50 L 450,100 L 350,100 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="400" y="75" text-anchor="middle" fill="#2196F3">3. 测试验证</text>
                    
                    <path d="M 50,150 L 150,150 L 150,200 L 50,200 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="100" y="175" text-anchor="middle" fill="#2196F3">4. 准备补丁</text>
                    
                    <path d="M 200,150 L 300,150 L 300,200 L 200,200 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="250" y="175" text-anchor="middle" fill="#2196F3">5. 发送审查</text>
                    
                    <path d="M 350,150 L 450,150 L 450,200 L 350,200 Z" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="400" y="175" text-anchor="middle" fill="#2196F3">6. 回应反馈</text>
                    
                    <!-- 连接线 -->
                    <line x1="150" y1="75" x2="200" y2="75" stroke="#2196F3" stroke-width="2"/>
                    <line x1="300" y1="75" x2="350" y2="75" stroke="#2196F3" stroke-width="2"/>
                    <line x1="150" y1="100" x2="100" y2="150" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="300" y1="100" x2="250" y2="150" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="450" y1="100" x2="400" y2="150" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="150" y1="175" x2="200" y2="175" stroke="#2196F3" stroke-width="2"/>
                    <line x1="300" y1="175" x2="350" y2="175" stroke="#2196F3" stroke-width="2"/>
                </svg>
            </div>
            
            <h3>补丁提交规范</h3>
            <div class="code-block">
<pre>
From: Zhang San <zhangsan@example.com>
Subject: [PATCH] Bluetooth: btusb: fix HCI command timeout handling

When the Bluetooth controller fails to respond to HCI commands,
the driver should properly handle the timeout condition instead
of waiting indefinitely.

This patch adds a timeout mechanism to the HCI command submission
and ensures proper cleanup when a timeout occurs.

Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=123456
Fixes: a1b2c3d4e5f6 ("Bluetooth: btusb: add support for XYZ controller")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Zhang San <zhangsan@example.com>
---
 drivers/bluetooth/btusb.c | 25 +++++++++++++++++++++++--
 1 file changed, 23 insertions(+), 2 deletions(-)

diff --git a/drivers/bluetooth/btusb.c b/drivers/bluetooth/btusb.c
index a1b2c3d..e5f6a1b 100644
--- a/drivers/bluetooth/btusb.c
+++ b/drivers/bluetooth/btusb.c
@@ -1234,8 +1234,29 @@ static int btusb_submit_bulk_urb(struct hci_dev *hdev, gfp_t mem_flags)
        if (!urb)
                return -ENOMEM;
 
-       /* ... original code ... */
+       /* 修复代码开始 */
+       if (test_bit(BTUSB_DISCONNECTING, &data->flags)) {
+               bt_dev_err(hdev, "Device disconnecting, skip submit URB");
+               usb_free_urb(urb);
+               return -ENODEV;
+       }
+       /* 修复代码结束 */
+
+       /* ... 其余代码 ... */
 }
</pre>
            </div>
            
            <h3>邮件列表与审查流程</h3>
            <table>
                <thead>
                    <tr>
                        <th>邮件列表</th>
                        <th>用途</th>
                        <th>订阅地址</th>
                        <th>注意事项</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>linux-bluetooth</td>
                        <td>蓝牙子系统开发讨论</td>
                        <td>vger.kernel.org</td>
                        <td>主要开发列表，发送补丁首选</td>
                    </tr>
                    <tr>
                        <td>netdev</td>
                        <td>网络子系统（包含蓝牙）</td>
                        <td>vger.kernel.org</td>
                        <td>涉及网络栈的蓝牙补丁</td>
                    </tr>
                    <tr>
                        <td>kernel-janitors</td>
                        <td>代码清理和小修复</td>
                        <td>vger.kernel.org</td>
                        <td>适合初学者贡献</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="tip-box">
                <strong>最佳实践：</strong> 
                <ul>
                    <li>使用<code>git send-email</code>发送补丁，避免邮件客户端格式问题</li>
                    <li>补丁系列应包含清晰的封面信说明修改目的</li>
                    <li>及时回应审查意见，保持礼貌和专业</li>
                    <li>测试补丁在多个内核版本和硬件平台的兼容性</li>
                </ul>
            </div>
        </section>
        
        <section>
            <h2>总结</h2>
            <p>蓝牙驱动维护是一项需要持续学习和实践的工作。通过掌握版本兼容性处理、系统化Bug修复流程和社区贡献规范，您将能够：</p>
            <ul>
                <li>构建稳定可靠的蓝牙驱动</li>
                <li>快速定位和修复复杂问题</li>
                <li>为Linux内核社区做出有价值贡献</li>
                <li>推动蓝牙技术在各领域的应用</li>
            </ul>
            <p>记住，开源社区的力量在于协作和共享。每一次代码贡献都在让整个生态系统变得更好！</p>
        </section>
    </div>
    
    <footer>
        <div class="container">
            蓝海资料掘金营
        </div>
    </footer>
</body>
</html>