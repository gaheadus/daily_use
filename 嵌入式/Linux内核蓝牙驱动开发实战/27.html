<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“ç‰™AVRCPåè®®é©±åŠ¨å¼€å‘å®æˆ˜</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #FFC107;
            --accent-color: #2196F3;
            --background-color: #E8F5E9;
            --text-color: #333;
            --card-bg: #FFFFFF;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
        }
        
        h3 {
            color: var(--accent-color);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid var(--accent-color);
        }
        
        code {
            font-family: 'Courier New', monospace;
        }
        
        .architecture {
            background-color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
        
        footer {
            text-align: center;
            padding: 2rem 0;
            margin-top: 2rem;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: white;
            border-radius: 10px;
        }
        
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }
        
        .command-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .command-item {
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è“ç‰™AVRCPåè®®é©±åŠ¨å¼€å‘å®æˆ˜</h1>
            <p>ç¬¬27è¯¾ï¼šAVRCPå‘½ä»¤é›†ã€æ’­æ”¾æ§åˆ¶ä¸å…ƒæ•°æ®ä¼ è¾“</p>
        </header>

        <div class="card">
            <h2>AVRCPåè®®æ¦‚è¿°</h2>
            <p>AVRCPï¼ˆAudio/Video Remote Control Profileï¼‰æ˜¯è“ç‰™åè®®æ ˆä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºåœ¨è“ç‰™è®¾å¤‡ä¹‹é—´ä¼ è¾“è¿œç¨‹æ§åˆ¶å‘½ä»¤ã€‚å®ƒå…è®¸ä¸€ä¸ªè®¾å¤‡ï¼ˆå¦‚æ‰‹æœºæˆ–ç”µè„‘ï¼‰æ§åˆ¶å¦ä¸€ä¸ªè®¾å¤‡ï¼ˆå¦‚éŸ³ç®±æˆ–è€³æœºï¼‰çš„åª’ä½“æ’­æ”¾ã€‚</p>
            
            <div class="svg-container">
                <svg width="600" height="200" viewBox="0 0 600 200">
                    <rect x="50" y="50" width="150" height="100" rx="10" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="125" y="110" text-anchor="middle" fill="white" font-size="16">æ§åˆ¶è®¾å¤‡</text>
                    <text x="125" y="130" text-anchor="middle" fill="white" font-size="12">(æ‰‹æœº/ç”µè„‘)</text>
                    
                    <rect x="400" y="50" width="150" height="100" rx="10" fill="#2196F3" stroke="#1565C0" stroke-width="2"/>
                    <text x="475" y="110" text-anchor="middle" fill="white" font-size="16">ç›®æ ‡è®¾å¤‡</text>
                    <text x="475" y="130" text-anchor="middle" fill="white" font-size="12">(éŸ³ç®±/è€³æœº)</text>
                    
                    <path d="M 200 100 L 400 100" stroke="#FFC107" stroke-width="3" stroke-dasharray="5,5"/>
                    <text x="300" y="95" text-anchor="middle" fill="#FF9800" font-size="14">AVRCPåè®®</text>
                </svg>
            </div>
        </div>

        <div class="card">
            <h2>AVRCPå‘½ä»¤é›†</h2>
            <p>AVRCPå®šä¹‰äº†ä¸°å¯Œçš„å‘½ä»¤é›†ï¼Œç”¨äºå®ç°å„ç§åª’ä½“æ§åˆ¶åŠŸèƒ½ï¼š</p>
            
            <div class="command-list">
                <div class="command-item">
                    <h3>ğŸš€ æ’­æ”¾æ§åˆ¶å‘½ä»¤</h3>
                    <ul>
                        <li>PLAY</li>
                        <li>PAUSE</li>
                        <li>STOP</li>
                        <li>NEXT</li>
                        <li>PREVIOUS</li>
                    </ul>
                </div>
                
                <div class="command-item">
                    <h3>ğŸ“Š çŠ¶æ€æŸ¥è¯¢å‘½ä»¤</h3>
                    <ul>
                        <li>GET_PLAY_STATUS</li>
                        <li>GET_ELEMENT_ATTRIBUTES</li>
                        <li>GET_CAPABILITIES</li>
                    </ul>
                </div>
                
                <div class="command-item">
                    <h3>ğŸµ éŸ³é‡æ§åˆ¶å‘½ä»¤</h3>
                    <ul>
                        <li>VOLUME_UP</li>
                        <li>VOLUME_DOWN</li>
                        <li>ABSOLUTE_VOLUME</li>
                    </ul>
                </div>
                
                <div class="command-item">
                    <h3>ğŸ” æµè§ˆå‘½ä»¤</h3>
                    <ul>
                        <li>CHANGE_PATH</li>
                        <li>GET_FOLDER_ITEMS</li>
                        <li>GET_ITEM_ATTRIBUTES</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>AVRCPè½¯ä»¶æ¶æ„</h2>
            <div class="architecture">
                <svg width="600" height="400" viewBox="0 0 600 400">
                    <!-- åº”ç”¨å±‚ -->
                    <rect x="50" y="50" width="500" height="60" rx="5" fill="#E3F2FD" stroke="#90CAF9" stroke-width="2"/>
                    <text x="300" y="85" text-anchor="middle" fill="#1565C0" font-size="16" font-weight="bold">åº”ç”¨å±‚ (Application)</text>
                    
                    <!-- AVRCPåè®®å±‚ -->
                    <rect x="100" y="130" width="400" height="60" rx="5" fill="#E8F5E9" stroke="#81C784" stroke-width="2"/>
                    <text x="300" y="165" text-anchor="middle" fill="#2E7D32" font-size="16" font-weight="bold">AVRCPåè®®å±‚</text>
                    
                    <!-- å­å±‚ -->
                    <rect x="120" y="200" width="110" height="40" rx="3" fill="#FFF3E0" stroke="#FFB74D" stroke-width="1"/>
                    <text x="175" y="225" text-anchor="middle" fill="#E65100" font-size="12">æ§åˆ¶å±‚(CT)</text>
                    
                    <rect x="245" y="200" width="110" height="40" rx="3" fill="#FFF3E0" stroke="#FFB74D" stroke-width="1"/>
                    <text x="300" y="225" text-anchor="middle" fill="#E65100" font-size="12">æµè§ˆå±‚(BRW)</text>
                    
                    <rect x="370" y="200" width="110" height="40" rx="3" fill="#FFF3E0" stroke="#FFB74D" stroke-width="1"/>
                    <text x="425" y="225" text-anchor="middle" fill="#E65100" font-size="12">ç›‘æ§å±‚</text>
                    
                    <!-- AVCTPå±‚ -->
                    <rect x="150" y="270" width="300" height="60" rx="5" fill="#F3E5F5" stroke="#BA68C8" stroke-width="2"/>
                    <text x="300" y="305" text-anchor="middle" fill="#7B1FA2" font-size="16" font-weight="bold">AVCTPä¼ è¾“å±‚</text>
                    
                    <!-- L2CAPå±‚ -->
                    <rect x="200" y="350" width="200" height="60" rx="5" fill="#FFF8E1" stroke="#FFD54F" stroke-width="2"/>
                    <text x="300" y="385" text-anchor="middle" fill="#FF8F00" font-size="16" font-weight="bold">L2CAPå±‚</text>
                    
                    <!-- è¿æ¥çº¿ -->
                    <path d="M 300 110 L 300 130" stroke="#78909C" stroke-width="2"/>
                    <path d="M 300 190 L 300 200" stroke="#78909C" stroke-width="2"/>
                    <path d="M 300 240 L 300 270" stroke="#78909C" stroke-width="2"/>
                    <path d="M 300 330 L 300 350" stroke="#78909C" stroke-width="2"/>
                </svg>
            </div>
        </div>

        <div class="card">
            <h2>æ’­æ”¾æ§åˆ¶å®ç°</h2>
            <p>åœ¨Linuxå†…æ ¸ä¸­ï¼ŒAVRCPæ’­æ”¾æ§åˆ¶ä¸»è¦é€šè¿‡BlueZè“ç‰™åè®®æ ˆå®ç°ï¼š</p>
            
            <h3>å…³é”®æ•°æ®ç»“æ„</h3>
            <pre><code>struct avrcp_player {
    uint16_t control_timer;
    uint8_t volume;
    uint8_t play_status;
    uint64_t position;
    uint64_t duration;
    struct avrcp_metadata *metadata;
};

struct avrcp_metadata {
    char title[128];
    char artist[128];
    char album[128];
    char genre[64];
    uint32_t track_num;
    uint32_t total_tracks;
};</code></pre>
            
            <h3>æ’­æ”¾çŠ¶æ€å¤„ç†å‡½æ•°</h3>
            <pre><code>static int avrcp_handle_play_cmd(struct avrcp_session *session)
{
    struct avrcp_player *player = session->player;
    
    if (player->play_status == AVRCP_PLAY_STATUS_PAUSED) {
        player->play_status = AVRCP_PLAY_STATUS_PLAYING;
        /* é€šçŸ¥åº”ç”¨å±‚å¼€å§‹æ’­æ”¾ */
        avrcp_notify_playback_status(session);
        return 0;
    }
    
    return -EINVAL;
}

static int avrcp_handle_pause_cmd(struct avrcp_session *session)
{
    struct avrcp_player *player = session->player;
    
    if (player->play_status == AVRCP_PLAY_STATUS_PLAYING) {
        player->play_status = AVRCP_PLAY_STATUS_PAUSED;
        /* é€šçŸ¥åº”ç”¨å±‚æš‚åœæ’­æ”¾ */
        avrcp_notify_playback_status(session);
        return 0;
    }
    
    return -EINVAL;
}</code></pre>
        </div>

        <div class="card">
            <h2>å…ƒæ•°æ®ä¼ è¾“</h2>
            <p>AVRCPæ”¯æŒä¼ è¾“ä¸°å¯Œçš„åª’ä½“å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ­Œæ›²ä¿¡æ¯ã€è‰ºæœ¯å®¶ã€ä¸“è¾‘ç­‰ï¼š</p>
            
            <table>
                <thead>
                    <tr>
                        <th>å±æ€§ID</th>
                        <th>å±æ€§åç§°</th>
                        <th>æ•°æ®ç±»å‹</th>
                        <th>æè¿°</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>0x01</td>
                        <td>æ ‡é¢˜</td>
                        <td>å­—ç¬¦ä¸²</td>
                        <td>åª’ä½“å†…å®¹çš„æ ‡é¢˜</td>
                    </tr>
                    <tr>
                        <td>0x02</td>
                        <td>è‰ºæœ¯å®¶</td>
                        <td>å­—ç¬¦ä¸²</td>
                        <td>è‰ºæœ¯å®¶æˆ–è¡¨æ¼”è€…åç§°</td>
                    </tr>
                    <tr>
                        <td>0x03</td>
                        <td>ä¸“è¾‘</td>
                        <td>å­—ç¬¦ä¸²</td>
                        <td>ä¸“è¾‘åç§°</td>
                    </tr>
                    <tr>
                        <td>0x04</td>
                        <td>æ›²ç›®ç¼–å·</td>
                        <td>æ•°å€¼</td>
                        <td>æ›²ç›®åœ¨ä¸“è¾‘ä¸­çš„ä½ç½®</td>
                    </tr>
                    <tr>
                        <td>0x05</td>
                        <td>æ›²ç›®æ€»æ•°</td>
                        <td>æ•°å€¼</td>
                        <td>ä¸“è¾‘ä¸­çš„æ€»æ›²ç›®æ•°</td>
                    </tr>
                    <tr>
                        <td>0x06</td>
                        <td>æµæ´¾</td>
                        <td>å­—ç¬¦ä¸²</td>
                        <td>éŸ³ä¹æˆ–åª’ä½“ç±»å‹</td>
                    </tr>
                    <tr>
                        <td>0x07</td>
                        <td>æ—¶é•¿</td>
                        <td>æ•°å€¼</td>
                        <td>åª’ä½“å†…å®¹çš„æ€»æ—¶é•¿(æ¯«ç§’)</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>å…ƒæ•°æ®è·å–å®ç°</h3>
            <pre><code>static int avrcp_get_element_attributes(struct avrcp_session *session,
                                      uint8_t *data, size_t len)
{
    struct avrcp_player *player = session->player;
    struct avrcp_metadata *metadata = player->metadata;
    uint8_t response[256];
    int pos = 0;
    
    /* æ„å»ºå“åº”å¤´ */
    response[pos++] = AVRCP_GET_ELEMENT_ATTRIBUTES;
    response[pos++] = 0x00; /* å‚æ•°é•¿åº¦å°†åœ¨åé¢è®¾ç½® */
    
    /* æ·»åŠ æ ‡é¢˜å±æ€§ */
    if (metadata->title[0] != '\0') {
        response[pos++] = 0x01; /* å±æ€§ID: æ ‡é¢˜ */
        uint16_t title_len = strlen(metadata->title);
        response[pos++] = (title_len >> 8) & 0xFF;
        response[pos++] = title_len & 0xFF;
        memcpy(&response[pos], metadata->title, title_len);
        pos += title_len;
    }
    
    /* æ·»åŠ è‰ºæœ¯å®¶å±æ€§ */
    if (metadata->artist[0] != '\0') {
        response[pos++] = 0x02; /* å±æ€§ID: è‰ºæœ¯å®¶ */
        uint16_t artist_len = strlen(metadata->artist);
        response[pos++] = (artist_len >> 8) & 0xFF;
        response[pos++] = artist_len & 0xFF;
        memcpy(&response[pos], metadata->artist, artist_len);
        pos += artist_len;
    }
    
    /* è®¾ç½®å‚æ•°é•¿åº¦ */
    response[1] = pos - 2;
    
    return avrcp_send_response(session, response, pos);
}</code></pre>
        </div>

        <div class="card">
            <h2>äº‹ä»¶é€šçŸ¥æœºåˆ¶</h2>
            <p>AVRCPä½¿ç”¨äº‹ä»¶é€šçŸ¥æœºåˆ¶æ¥å®æ—¶æ›´æ–°æ’­æ”¾çŠ¶æ€å’Œå…ƒæ•°æ®å˜åŒ–ï¼š</p>
            
            <pre><code>/* äº‹ä»¶ç±»å‹å®šä¹‰ */
#define AVRCP_EVENT_PLAYBACK_STATUS_CHANGED   0x01
#define AVRCP_EVENT_TRACK_CHANGED             0x02
#define AVRCP_EVENT_PLAYBACK_POS_CHANGED      0x05
#define AVRCP_EVENT_VOLUME_CHANGED            0x0D

/* æ³¨å†Œäº‹ä»¶é€šçŸ¥ */
static int avrcp_register_notification(struct avrcp_session *session,
                                     uint8_t event_id, uint32_t interval)
{
    struct avrcp_pending_event *event;
    
    event = kzalloc(sizeof(*event), GFP_KERNEL);
    if (!event)
        return -ENOMEM;
    
    event->event_id = event_id;
    event->interval = interval;
    event->session = session;
    
    list_add_tail(&event->list, &session->event_list);
    
    /* è®¾ç½®å®šæ—¶å™¨ */
    setup_timer(&event->timer, avrcp_event_timeout,
                (unsigned long)event);
    mod_timer(&event->timer, jiffies + msecs_to_jiffies(interval));
    
    return 0;
}

/* äº‹ä»¶é€šçŸ¥å›è°ƒ */
static void avrcp_event_timeout(unsigned long data)
{
    struct avrcp_pending_event *event = (struct avrcp_pending_event *)data;
    struct avrcp_session *session = event->session;
    uint8_t response[16];
    int pos = 0;
    
    response[pos++] = AVRCP_REGISTER_NOTIFICATION;
    response[pos++] = 0x00; /* å‚æ•°é•¿åº¦ */
    response[pos++] = event->event_id;
    
    switch (event->event_id) {
    case AVRCP_EVENT_PLAYBACK_STATUS_CHANGED:
        response[pos++] = session->player->play_status;
        break;
    case AVRCP_EVENT_TRACK_CHANGED:
        /* å‘é€å½“å‰æ›²ç›®ä¿¡æ¯ */
        memcpy(&response[pos], &session->player->track_uid, 8);
        pos += 8;
        break;
    }
    
    response[1] = pos - 2;
    avrcp_send_response(session, response, pos);
    
    /* é‡æ–°è®¾ç½®å®šæ—¶å™¨ */
    mod_timer(&event->timer, jiffies + msecs_to_jiffies(event->interval));
}</code></pre>
        </div>

        <div class="card">
            <h2>é©±åŠ¨å¼€å‘è¦ç‚¹</h2>
            <ul>
                <li><strong>åè®®ç‰ˆæœ¬å…¼å®¹æ€§</strong>ï¼šæ”¯æŒAVRCP 1.0åˆ°1.6å¤šä¸ªç‰ˆæœ¬</li>
                <li><strong>çŠ¶æ€æœºç®¡ç†</strong>ï¼šæ­£ç¡®å¤„ç†è¿æ¥ã€è®¤è¯ã€å‘½ä»¤å¤„ç†ç­‰çŠ¶æ€</li>
                <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå®Œå–„çš„é”™è¯¯ç å’Œå¼‚å¸¸æƒ…å†µå¤„ç†æœºåˆ¶</li>
                <li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå‡å°‘å†…å­˜æ‹·è´ï¼Œä½¿ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„</li>
                <li><strong>ç”µæºç®¡ç†</strong>ï¼šåˆç†å¤„ç†ä¼‘çœ å’Œå”¤é†’çŠ¶æ€</li>
            </ul>
            
            <h3>è°ƒè¯•æŠ€å·§</h3>
            <pre><code>/* å¯ç”¨è°ƒè¯•è¾“å‡º */
#define AVRCP_DEBUG

#ifdef AVRCP_DEBUG
#define avrcp_dbg(fmt, ...) \
    printk(KERN_DEBUG "AVRCP: " fmt, ##__VA_ARGS__)
#else
#define avrcp_dbg(fmt, ...) 
#endif

/* æ•°æ®åŒ…è°ƒè¯•å‡½æ•° */
static void avrcp_dump_packet(const char *label, const uint8_t *data, size_t len)
{
#ifdef AVRCP_DEBUG
    int i;
    printk(KERN_DEBUG "AVRCP %s (%zu bytes):", label, len);
    for (i = 0; i < len; i++) {
        if (i % 16 == 0)
            printk(KERN_DEBUG "\n%04x: ", i);
        printk(KERN_CONT "%02x ", data[i]);
    }
    printk(KERN_CONT "\n");
#endif
}</code></pre>
        </div>

        <footer>
            <p>è“æµ·èµ„æ–™æ˜é‡‘è¥</p>
        </footer>
    </div>
</body>
</html>