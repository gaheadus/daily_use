<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙驱动模块初始化 - Linux内核蓝牙驱动开发实战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.2);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4fc3f7;
        }

        h2 {
            color: #0277bd;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #81d4fa;
        }

        h3 {
            color: #0288d1;
            margin: 15px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #4fc3f7;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0f2f1;
        }

        tr:nth-child(even) {
            background: #f1f8e9;
        }

        tr:hover {
            background: #e1f5fe;
        }

        .code-block {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .svg-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .note {
            background: #fff9c4;
            border-left: 4px solid #ffd600;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #0277bd;
            font-weight: bold;
            border-top: 2px solid #81d4fa;
        }

        .flow-chart {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蓝牙驱动模块初始化</h1>
            <div class="subtitle">模块加载卸载函数、驱动注册注销、资源分配释放</div>
        </header>

        <div class="section">
            <h2>1. 模块加载与卸载基础</h2>
            <p>在Linux内核中，蓝牙驱动以模块形式存在，通过模块加载和卸载机制实现动态管理。模块初始化是驱动开发的第一步，确保驱动正确集成到内核中。</p>
            
            <div class="note">
                <strong>注意：</strong> 模块初始化函数必须正确管理资源，确保在加载失败或卸载时释放所有已分配的资源，避免内存泄漏。
            </div>
            
            <h3>模块加载卸载函数原型</h3>
            <div class="code-block">
<pre>
#include &lt;linux/module.h&gt;
#include &lt;linux/init.h&gt;

/* 模块加载函数 */
static int __init bluetooth_driver_init(void)
{
    /* 驱动初始化代码 */
    return 0; /* 成功返回0，失败返回负值 */
}

/* 模块卸载函数 */
static void __exit bluetooth_driver_exit(void)
{
    /* 驱动清理代码 */
}

/* 注册模块加载和卸载函数 */
module_init(bluetooth_driver_init);
module_exit(bluetooth_driver_exit);

/* 模块信息 */
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("Bluetooth Driver for Linux");
MODULE_VERSION("1.0");
</pre>
            </div>
        </div>

        <div class="section">
            <h2>2. 驱动注册与注销</h2>
            <p>蓝牙驱动需要向内核注册相应的驱动结构，使内核能够识别和管理蓝牙设备。这包括设备驱动注册、协议栈注册等。</p>
            
            <h3>驱动注册关键步骤</h3>
            <ol>
                <li><strong>分配驱动结构</strong>：使用alloc_xxx_driver函数分配驱动结构体</li>
                <li><strong>设置驱动属性</strong>：填充驱动名称、ID表、探测函数等</li>
                <li><strong>注册驱动</strong>：调用register_xxx_driver函数向内核注册</li>
                <li><strong>错误处理</strong>：检查返回值，处理注册失败情况</li>
            </ol>
            
            <h3>蓝牙驱动注册示例</h3>
            <div class="code-block">
<pre>
#include &lt;linux/bluetooth/hci_core.h&gt;

static struct hci_driver bt_driver = {
    .name   = "my_bt_driver",
    .probe  = bt_driver_probe,
    .remove = bt_driver_remove,
    .id_table = bt_driver_id_table,
};

static int __init bt_driver_init(void)
{
    int ret;
    
    /* 注册HCI驱动 */
    ret = hci_register_driver(&bt_driver);
    if (ret < 0) {
        printk(KERN_ERR "Failed to register Bluetooth driver\n");
        return ret;
    }
    
    printk(KERN_INFO "Bluetooth driver registered successfully\n");
    return 0;
}

static void __exit bt_driver_exit(void)
{
    /* 注销驱动 */
    hci_unregister_driver(&bt_driver);
    printk(KERN_INFO "Bluetooth driver unregistered\n");
}
</pre>
            </div>
            
            <div class="svg-container">
                <svg class="flow-chart" viewBox="0 0 800 300">
                    <!-- 驱动注册流程图 -->
                    <rect x="50" y="50" width="200" height="60" rx="10" fill="#4fc3f7" stroke="#0277bd" stroke-width="2"/>
                    <text x="150" y="85" text-anchor="middle" fill="white" font-weight="bold">模块加载</text>
                    
                    <rect x="300" y="50" width="200" height="60" rx="10" fill="#4fc3f7" stroke="#0277bd" stroke-width="2"/>
                    <text x="400" y="85" text-anchor="middle" fill="white" font-weight="bold">分配驱动结构</text>
                    
                    <rect x="550" y="50" width="200" height="60" rx="10" fill="#4fc3f7" stroke="#0277bd" stroke-width="2"/>
                    <text x="650" y="85" text-anchor="middle" fill="white" font-weight="bold">注册驱动</text>
                    
                    <rect x="300" y="150" width="200" height="60" rx="10" fill="#4fc3f7" stroke="#0277bd" stroke-width="2"/>
                    <text x="400" y="185" text-anchor="middle" fill="white" font-weight="bold">初始化完成</text>
                    
                    <!-- 箭头 -->
                    <path d="M250 80 L300 80" stroke="#0277bd" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    <path d="M500 80 L550 80" stroke="#0277bd" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    <path d="M650 80 L650 150 L400 150" stroke="#0277bd" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#0277bd"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>

        <div class="section">
            <h2>3. 资源分配与释放</h2>
            <p>在驱动初始化过程中，需要合理分配和管理系统资源，包括内存、中断、DMA、GPIO等，并在驱动卸载时正确释放这些资源。</p>
            
            <h3>资源分配关键函数</h3>
            <table>
                <thead>
                    <tr>
                        <th>资源类型</th>
                        <th>分配函数</th>
                        <th>释放函数</th>
                        <th>说明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>内存</td>
                        <td>kmalloc, kzalloc</td>
                        <td>kfree</td>
                        <td>内核空间内存分配</td>
                    </tr>
                    <tr>
                        <td>中断</td>
                        <td>request_irq</td>
                        <td>free_irq</td>
                        <td>中断请求与释放</td>
                    </tr>
                    <tr>
                        <td>DMA</td>
                        <td>dma_alloc_coherent</td>
                        <td>dma_free_coherent</td>
                        <td>DMA一致性内存</td>
                    </tr>
                    <tr>
                        <td>GPIO</td>
                        <td>gpio_request</td>
                        <td>gpio_free</td>
                        <td>GPIO引脚申请</td>
                    </tr>
                    <tr>
                        <td>设备号</td>
                        <td>alloc_chrdev_region</td>
                        <td>unregister_chrdev_region</td>
                        <td>字符设备号分配</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>资源管理最佳实践</h3>
            <ul>
                <li><strong>错误处理</strong>：每个分配操作后都要检查返回值</li>
                <li><strong>资源跟踪</strong>：使用标志位或数据结构跟踪已分配的资源</li>
                <li><strong>释放顺序</strong>：释放资源的顺序应与分配顺序相反</li>
                <li><strong>原子性</strong>：确保在部分初始化失败时能正确回滚</li>
            </ul>
            
            <h3>完整的初始化示例</h3>
            <div class="code-block">
<pre>
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/bluetooth/hci_core.h&gt;
#include &lt;linux/gpio.h&gt;
#include &lt;linux/interrupt.h&gt;

static int bt_irq;
static int bt_reset_gpio;

static irqreturn_t bt_interrupt(int irq, void *dev_id)
{
    /* 中断处理函数 */
    return IRQ_HANDLED;
}

static int bt_driver_probe(struct hci_dev *hdev)
{
    int ret;
    
    /* 申请GPIO */
    bt_reset_gpio = 123; /* 示例GPIO号 */
    ret = gpio_request(bt_reset_gpio, "bt_reset");
    if (ret) {
        printk(KERN_ERR "Failed to request GPIO %d\n", bt_reset_gpio);
        return ret;
    }
    
    /* 申请中断 */
    bt_irq = gpio_to_irq(bt_reset_gpio);
    ret = request_irq(bt_irq, bt_interrupt, IRQF_TRIGGER_RISING, 
                     "bt_irq", hdev);
    if (ret) {
        printk(KERN_ERR "Failed to request IRQ %d\n", bt_irq);
        gpio_free(bt_reset_gpio);
        return ret;
    }
    
    return 0;
}

static void bt_driver_remove(struct hci_dev *hdev)
{
    /* 释放资源 - 顺序与分配相反 */
    free_irq(bt_irq, hdev);
    gpio_free(bt_reset_gpio);
}
</pre>
            </div>
        </div>

        <div class="section">
            <h2>4. 初始化流程总结</h2>
            <p>蓝牙驱动模块的初始化是一个系统化的过程，需要按照正确的顺序执行各个步骤，并妥善处理可能出现的错误情况。</p>
            
            <div class="svg-container">
                <svg viewBox="0 0 800 400">
                    <!-- 软件架构图 -->
                    <rect x="50" y="50" width="700" height="300" rx="10" fill="none" stroke="#4fc3f7" stroke-width="3"/>
                    
                    <!-- 应用层 -->
                    <rect x="100" y="80" width="600" height="50" rx="5" fill="#e1f5fe" stroke="#4fc3f7" stroke-width="2"/>
                    <text x="400" y="110" text-anchor="middle" font-weight="bold">用户空间应用</text>
                    
                    <!-- 蓝牙协议栈 -->
                    <rect x="150" y="150" width="500" height="50" rx="5" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                    <text x="400" y="180" text-anchor="middle" font-weight="bold">蓝牙协议栈 (HCI, L2CAP, RFCOMM等)</text>
                    
                    <!-- 驱动层 -->
                    <rect x="200" y="220" width="400" height="50" rx="5" fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                    <text x="400" y="250" text-anchor="middle" font-weight="bold">蓝牙HCI驱动</text>
                    
                    <!-- 硬件层 -->
                    <rect x="250" y="290" width="300" height="40" rx="5" fill="#ffcdd2" stroke="#f44336" stroke-width="2"/>
                    <text x="400" y="315" text-anchor="middle" font-weight="bold">蓝牙硬件设备</text>
                    
                    <!-- 连接线 -->
                    <path d="M400 130 L400 150" stroke="#4fc3f7" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M400 200 L400 220" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M400 270 L400 290" stroke="#ffc107" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            
            <h3>初始化检查清单</h3>
            <ul>
                <li>✅ 模块加载/卸载函数正确实现</li>
                <li>✅ 驱动结构体正确填充和注册</li>
                <li>✅ 必要的资源申请和错误处理</li>
                <li>✅ 中断处理函数注册（如需要）</li>
                <li>✅ 设备节点创建（如需要）</li>
                <li>✅ 模块信息正确设置</li>
                <li>✅ 卸载时资源完全释放</li>
            </ul>
        </div>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>