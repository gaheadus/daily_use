<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux内核蓝牙驱动开发实战 - 蓝牙用户空间接口</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border: 2px solid #4db6ac;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }

        h1 {
            color: #00695c;
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #00796b;
            font-size: 1.8em;
            margin: 30px 0 15px;
            padding-left: 15px;
            border-left: 5px solid #4db6ac;
        }

        h3 {
            color: #00897b;
            font-size: 1.4em;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .card {
            background: linear-gradient(145deg, #ffffff, #e6f7f5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #80cbc4;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #f1f8e9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #c8e6c9;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #e8f5e9;
        }

        tr:hover {
            background-color: #c8e6c9;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        pre {
            background-color: #f5f5f5;
            border-left: 4px solid #4db6ac;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }

        code {
            background-color: #f1f8e9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #00695c;
        }

        .svg-container {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background-color: #f9fbe7;
            border-radius: 10px;
            border: 1px dashed #4db6ac;
        }

        .comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }

        .comparison-item {
            flex: 1;
            min-width: 300px;
            background: linear-gradient(145deg, #e0f2f1, #f1f8e9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #4db6ac;
            color: #00796b;
            font-weight: bold;
            font-size: 1.2em;
        }

        .highlight {
            background-color: #e8f5e9;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: #00695c;
        }

        .note {
            background-color: #fff9c4;
            border-left: 4px solid #ffd54f;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Linux内核蓝牙驱动开发实战</h1>
            <h2>蓝牙用户空间接口：Netlink套接字、Sysfs文件系统、Debugfs调试接口</h2>
        </header>

        <section>
            <div class="card">
                <h2>引言</h2>
                <p>在Linux系统中，内核与用户空间之间的通信是驱动开发中的关键环节。蓝牙子系统提供了多种用户空间接口，使应用程序能够与蓝牙协议栈进行交互。本课程将深入探讨三种主要的用户空间接口：<span class="highlight">Netlink套接字</span>、<span class="highlight">Sysfs文件系统</span>和<span class="highlight">Debugfs调试接口</span>。</p>
                
                <div class="svg-container">
                    <svg width="600" height="200" viewBox="0 0 600 200">
                        <rect x="50" y="50" width="150" height="100" rx="10" fill="#4db6ac" opacity="0.8" />
                        <text x="125" y="110" text-anchor="middle" fill="white" font-weight="bold">用户空间</text>
                        
                        <rect x="250" y="50" width="100" height="100" rx="10" fill="#ffb74d" opacity="0.8" />
                        <text x="300" y="110" text-anchor="middle" fill="white" font-weight="bold">接口层</text>
                        
                        <rect x="400" y="50" width="150" height="100" rx="10" fill="#81c784" opacity="0.8" />
                        <text x="475" y="110" text-anchor="middle" fill="white" font-weight="bold">内核空间</text>
                        
                        <path d="M200 100 L250 100" stroke="#4db6ac" stroke-width="3" />
                        <path d="M350 100 L400 100" stroke="#4db6ac" stroke-width="3" />
                        
                        <text x="225" y="85" text-anchor="middle" fill="#00695c" font-size="12">Netlink</text>
                        <text x="225" y="100" text-anchor="middle" fill="#00695c" font-size="12">Sysfs</text>
                        <text x="225" y="115" text-anchor="middle" fill="#00695c" font-size="12">Debugfs</text>
                    </svg>
                </div>
            </div>
        </section>

        <section>
            <h2>1. Netlink套接字</h2>
            <div class="card">
                <h3>概述</h3>
                <p>Netlink是Linux内核与用户空间进程之间进行双向通信的机制，特别适用于网络子系统。在蓝牙子系统中，Netlink套接字用于传输控制命令和事件通知。</p>
                
                <h3>主要特点</h3>
                <ul>
                    <li>全双工通信通道</li>
                    <li>支持多播通信</li>
                    <li>异步事件通知</li>
                    <li>内核主动向用户空间发送消息</li>
                </ul>
                
                <h3>蓝牙Netlink家族</h3>
                <table>
                    <tr>
                        <th>Netlink家族</th>
                        <th>用途</th>
                        <th>协议号</th>
                    </tr>
                    <tr>
                        <td>NETLINK_BLUETOOTH</td>
                        <td>通用蓝牙通信</td>
                        <td>31</td>
                    </tr>
                    <tr>
                        <td>NETLINK_SOCK_DIAG</td>
                        <td>套接字诊断</td>
                        <td>4</td>
                    </tr>
                </table>
                
                <h3>使用示例</h3>
                <pre><code>#include &lt;linux/netlink.h&gt;
#include &lt;linux/bluetooth.h&gt;

// 创建Netlink套接字
int sock_fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_BLUETOOTH);

struct sockaddr_nl src_addr;
memset(&src_addr, 0, sizeof(src_addr));
src_addr.nl_family = AF_NETLINK;
src_addr.nl_pid = getpid(); // 当前进程ID
src_addr.nl_groups = BT_NL_GROUP; // 蓝牙组播组

// 绑定套接字
bind(sock_fd, (struct sockaddr*)&src_addr, sizeof(src_addr));

// 接收消息
struct nlmsghdr *nlh;
char buffer[4096];
recv(sock_fd, buffer, sizeof(buffer), 0);</code></pre>
            </div>
        </section>

        <section>
            <h2>2. Sysfs文件系统</h2>
            <div class="card">
                <h3>概述</h3>
                <p>Sysfs是一个虚拟文件系统，它将内核对象、属性和关系导出到用户空间。在蓝牙子系统中，Sysfs用于展示蓝牙适配器和设备的属性信息。</p>
                
                <h3>主要目录结构</h3>
                <ul>
                    <li><code>/sys/class/bluetooth/</code> - 蓝牙设备类目录</li>
                    <li><code>/sys/class/bluetooth/hciX/</code> - 具体蓝牙适配器</li>
                    <li><code>/sys/class/bluetooth/hciX/address</code> - 蓝牙地址</li>
                    <li><code>/sys/class/bluetooth/hciX/name</code> - 设备名称</li>
                    <li><code>/sys/class/bluetooth/hciX/type</code> - 设备类型</li>
                </ul>
                
                <h3>常用属性文件</h3>
                <table>
                    <tr>
                        <th>文件路径</th>
                        <th>描述</th>
                        <th>访问权限</th>
                    </tr>
                    <tr>
                        <td>/sys/class/bluetooth/hci0/address</td>
                        <td>蓝牙适配器MAC地址</td>
                        <td>只读</td>
                    </tr>
                    <tr>
                        <td>/sys/class/bluetooth/hci0/name</td>
                        <td>蓝牙适配器名称</td>
                        <td>读写</td>
                    </tr>
                    <tr>
                        <td>/sys/class/bluetooth/hci0/power/control</td>
                        <td>电源管理控制</td>
                        <td>读写</td>
                    </tr>
                    <tr>
                        <td>/sys/class/bluetooth/hci0/discoverable</td>
                        <td>可发现性设置</td>
                        <td>读写</td>
                    </tr>
                </table>
                
                <h3>内核驱动示例</h3>
                <pre><code>#include &lt;linux/device.h&gt;
#include &lt;linux/bluetooth.h&gt;

// 创建设备属性
static ssize_t show_address(struct device *dev, 
                           struct device_attribute *attr, 
                           char *buf)
{
    return sprintf(buf, "%pMR\n", &hdev->bdaddr);
}

static DEVICE_ATTR(address, 0444, show_address, NULL);

// 注册属性
int bt_sysfs_add_device(struct hci_dev *hdev)
{
    struct device *dev = &hdev->dev;
    int err;
    
    err = device_create_file(dev, &dev_attr_address);
    if (err &lt; 0) {
        BT_ERR("Failed to create address file");
        return err;
    }
    
    return 0;
}</code></pre>
            </div>
        </section>

        <section>
            <h2>3. Debugfs调试接口</h2>
            <div class="card">
                <h3>概述</h3>
                <p>Debugfs是专门为调试目的设计的虚拟文件系统，它提供了简单的方法让内核开发者向用户空间导出调试信息。与Sysfs不同，Debugfs没有稳定的API，主要用于开发调试。</p>
                
                <h3>主要特点</h3>
                <ul>
                    <li>专门用于调试目的</li>
                    <li>API不稳定，可能随内核版本变化</li>
                    <li>支持多种文件类型：常规文件、符号链接、目录等</li>
                    <li>挂载在 <code>/sys/kernel/debug/</code> 目录</li>
                </ul>
                
                <h3>蓝牙Debugfs结构</h3>
                <div class="svg-container">
                    <svg width="500" height="300" viewBox="0 0 500 300">
                        <rect x="50" y="50" width="400" height="200" rx="10" fill="#e1f5fe" stroke="#4db6ac" stroke-width="2" />
                        <text x="250" y="80" text-anchor="middle" font-weight="bold" fill="#00695c">/sys/kernel/debug/bluetooth/</text>
                        
                        <rect x="80" y="110" width="120" height="30" rx="5" fill="#b3e5fc" />
                        <text x="140" y="130" text-anchor="middle" fill="#00695c">hci0</text>
                        
                        <rect x="220" y="110" width="120" height="30" rx="5" fill="#b3e5fc" />
                        <text x="280" y="130" text-anchor="middle" fill="#00695c">hci1</text>
                        
                        <rect x="80" y="160" width="340" height="30" rx="5" fill="#81d4fa" />
                        <text x="250" y="180" text-anchor="middle" fill="#00695c">smp</text>
                        
                        <rect x="80" y="200" width="340" height="30" rx="5" fill="#81d4fa" />
                        <text x="250" y="220" text-anchor="middle" fill="#00695c">keys</text>
                        
                        <path d="M140 140 L140 160" stroke="#4db6ac" stroke-width="2" />
                        <path d="M280 140 L280 160" stroke="#4db6ac" stroke-width="2" />
                    </svg>
                </div>
                
                <h3>使用示例</h3>
                <pre><code>#include &lt;linux/debugfs.h&gt;

static struct dentry *bt_debugfs;

// 创建调试文件
static int debugfs_show_stats(struct seq_file *f, void *p)
{
    struct hci_dev *hdev = f->private;
    
    seq_printf(f, "Sent ACL: %u\n", hdev->acl_cnt);
    seq_printf(f, "Sent SCO: %u\n", hdev->sco_cnt);
    seq_printf(f, "Sent CMD: %u\n", hdev->cmd_cnt);
    
    return 0;
}

DEFINE_SHOW_ATTRIBUTE(debugfs_show_stats);

// 初始化debugfs
int bt_debugfs_init(void)
{
    bt_debugfs = debugfs_create_dir("bluetooth", NULL);
    if (!bt_debugfs)
        return -ENOMEM;
    
    return 0;
}

// 为设备创建debugfs条目
void hci_debugfs_create(struct hci_dev *hdev)
{
    char name[8];
    
    snprintf(name, sizeof(name), "hci%u", hdev->id);
    hdev->debugfs = debugfs_create_dir(name, bt_debugfs);
    
    debugfs_create_file("stats", 0444, hdev->debugfs, 
                       hdev, &debugfs_show_stats_fops);
}</code></pre>
            </div>
        </section>

        <section>
            <h2>三种接口对比</h2>
            <div class="comparison">
                <div class="comparison-item">
                    <h3>Netlink套接字</h3>
                    <ul>
                        <li><strong>用途</strong>: 实时通信和事件通知</li>
                        <li><strong>通信方向</strong>: 双向</li>
                        <li><strong>性能</strong>: 高</li>
                        <li><strong>稳定性</strong>: 稳定API</li>
                        <li><strong>适用场景</strong>: 控制命令、事件监听</li>
                    </ul>
                </div>
                
                <div class="comparison-item">
                    <h3>Sysfs文件系统</h3>
                    <ul>
                        <li><strong>用途</strong>: 设备属性管理</li>
                        <li><strong>通信方向</strong>: 主要用户空间到内核</li>
                        <li><strong>性能</strong>: 中等</li>
                        <li><strong>稳定性</strong>: 稳定API</li>
                        <li><strong>适用场景</strong>: 设备配置、状态查询</li>
                    </ul>
                </div>
                
                <div class="comparison-item">
                    <h3>Debugfs调试接口</h3>
                    <ul>
                        <li><strong>用途</strong>: 调试信息输出</li>
                        <li><strong>通信方向</strong>: 主要内核到用户空间</li>
                        <li><strong>性能</strong>: 低到中等</li>
                        <li><strong>稳定性</strong>: 不稳定API</li>
                        <li><strong>适用场景</strong>: 开发调试、内部状态查看</li>
                    </ul>
                </div>
            </div>
            
            <div class="note">
                <p><strong>注意</strong>: 在实际开发中，应根据具体需求选择合适的接口。Netlink适合实时通信，Sysfs适合设备管理，Debugfs专门用于调试目的。</p>
            </div>
        </section>

        <section>
            <h2>实际应用案例</h2>
            <div class="card">
                <h3>蓝牙工具实现</h3>
                <p>常见的蓝牙工具如<code>hciconfig</code>、<code>hcitool</code>等就是通过这些接口与内核蓝牙子系统交互的：</p>
                
                <pre><code>// 使用hciconfig配置蓝牙设备
$ hciconfig hci0 up          # 启用蓝牙适配器
$ hciconfig hci0 name "MyBT" # 设置设备名称
$ hciconfig hci0 piscan      # 设置可发现和可连接模式

// 使用hcitool扫描设备
$ hcitool scan
Scanning ...
    00:11:22:33:44:55   MyPhone
    66:77:88:99:AA:BB   MyHeadset</code></pre>
                
                <h3>BlueZ协议栈架构</h3>
                <div class="svg-container">
                    <svg width="600" height="350" viewBox="0 0 600 350">
                        <!-- 用户空间 -->
                        <rect x="50" y="20" width="500" height="60" rx="5" fill="#e8f5e9" stroke="#4db6ac" stroke-width="2" />
                        <text x="300" y="50" text-anchor="middle" font-weight="bold" fill="#00695c">用户空间应用程序</text>
                        <text x="300" y="70" text-anchor="middle" fill="#00695c">(bluez-tools, bluetoothctl等)</text>
                        
                        <!-- BlueZ守护进程 -->
                        <rect x="100" y="100" width="400" height="60" rx="5" fill="#c8e6c9" stroke="#4db6ac" stroke-width="2" />
                        <text x="300" y="130" text-anchor="middle" font-weight="bold" fill="#00695c">BlueZ蓝牙守护进程</text>
                        
                        <!-- D-Bus -->
                        <rect x="150" y="160" width="300" height="40" rx="5" fill="#a5d6a7" stroke="#4db6ac" stroke-width="2" />
                        <text x="300" y="185" text-anchor="middle" font-weight="bold" fill="#00695c">D-Bus IPC</text>
                        
                        <!-- 内核接口层 -->
                        <rect x="200" y="220" width="200" height="80" rx="5" fill="#81c784" stroke="#4db6ac" stroke-width="2" />
                        <text x="300" y="240" text-anchor="middle" font-weight="bold" fill="white">内核接口层</text>
                        <text x="300" y="260" text-anchor="middle" fill="white" font-size="12">Netlink | Sysfs | Debugfs</text>
                        
                        <!-- 内核蓝牙协议栈 -->
                        <rect x="250" y="320" width="100" height="40" rx="5" fill="#4caf50" stroke="#4db6ac" stroke-width="2" />
                        <text x="300" y="345" text-anchor="middle" font-weight="bold" fill="white">蓝牙协议栈</text>
                        
                        <!-- 连接线 -->
                        <path d="M300 80 L300 100" stroke="#4db6ac" stroke-width="2" />
                        <path d="M300 160 L300 180" stroke="#4db6ac" stroke-width="2" />
                        <path d="M300 220 L300 240" stroke="#4db6ac" stroke-width="2" />
                        <path d="M300 300 L300 320" stroke="#4db6ac" stroke-width="2" />
                    </svg>
                </div>
            </div>
        </section>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>