<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙核心规范解读 - Linux内核蓝牙驱动开发实战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border: 2px solid #4db6ac;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }

        h1 {
            color: #00695c;
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #00796b;
            font-size: 1.8em;
            margin: 30px 0 15px;
            padding-left: 10px;
            border-left: 5px solid #4db6ac;
        }

        h3 {
            color: #00897b;
            font-size: 1.4em;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border: 1px solid #80cbc4;
        }

        .highlight {
            background-color: #e0f2f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #26a69a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #b2dfdb;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #e0f2f1;
        }

        tr:hover {
            background-color: #b2dfdb;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin-bottom: 8px;
        }

        .code-block {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .architecture {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .architecture svg {
            max-width: 100%;
            height: auto;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #00695c;
            font-weight: bold;
            border-top: 2px dashed #4db6ac;
        }

        .note {
            background-color: #fff9c4;
            border-left: 4px solid #ffd600;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .key-point {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蓝牙核心规范解读</h1>
            <p>蓝牙核心规范架构、基带协议、链路管理协议</p>
            <p>《Linux内核蓝牙驱动开发实战》课程 - 第八章</p>
        </header>

        <div class="section">
            <h2>1. 蓝牙核心规范概述</h2>
            <p>蓝牙核心规范是蓝牙技术的基石，定义了蓝牙设备之间通信的标准协议和接口。它由蓝牙技术联盟(SIG)制定和维护，确保不同厂商的蓝牙设备能够互操作。</p>
            
            <div class="highlight">
                <p>蓝牙核心规范的主要目标是：</p>
                <ul>
                    <li>提供短距离无线通信解决方案</li>
                    <li>确保设备间的互操作性</li>
                    <li>支持多种应用场景</li>
                    <li>提供低功耗通信能力</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>2. 蓝牙核心规范架构</h2>
            <p>蓝牙核心规范采用分层架构，每一层都有特定的功能和职责。这种分层设计使得蓝牙协议栈具有很好的模块化和可扩展性。</p>
            
            <div class="architecture">
                <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
                    <!-- 蓝牙协议栈架构图 -->
                    <rect x="50" y="50" width="500" height="300" fill="#e3f2fd" stroke="#90caf9" stroke-width="2" rx="10"/>
                    
                    <!-- 应用层 -->
                    <rect x="100" y="80" width="400" height="40" fill="#bbdefb" stroke="#64b5f6" stroke-width="1"/>
                    <text x="300" y="105" text-anchor="middle" font-family="Arial" font-size="14" fill="#0d47a1">应用层 (Profiles)</text>
                    
                    <!-- 中间件层 -->
                    <rect x="100" y="130" width="400" height="40" fill="#90caf9" stroke="#42a5f5" stroke-width="1"/>
                    <text x="300" y="155" text-anchor="middle" font-family="Arial" font-size="14" fill="#0d47a1">中间件层 (RFCOMM, SDP)</text>
                    
                    <!-- 逻辑链路控制与适配协议 -->
                    <rect x="100" y="180" width="400" height="40" fill="#64b5f6" stroke="#2196f3" stroke-width="1"/>
                    <text x="300" y="205" text-anchor="middle" font-family="Arial" font-size="14" fill="#ffffff">逻辑链路控制与适配协议 (L2CAP)</text>
                    
                    <!-- 主机控制器接口 -->
                    <rect x="100" y="230" width="400" height="40" fill="#42a5f5" stroke="#1e88e5" stroke-width="1"/>
                    <text x="300" y="255" text-anchor="middle" font-family="Arial" font-size="14" fill="#ffffff">主机控制器接口 (HCI)</text>
                    
                    <!-- 链路管理层 -->
                    <rect x="100" y="280" width="400" height="40" fill="#2196f3" stroke="#1976d2" stroke-width="1"/>
                    <text x="300" y="305" text-anchor="middle" font-family="Arial" font-size="14" fill="#ffffff">链路管理层 (LMP)</text>
                    
                    <!-- 基带层 -->
                    <rect x="100" y="330" width="400" height="40" fill="#1976d2" stroke="#1565c0" stroke-width="1"/>
                    <text x="300" y="355" text-anchor="middle" font-family="Arial" font-size="14" fill="#ffffff">基带层 (Baseband)</text>
                    
                    <!-- 箭头 -->
                    <line x1="300" y1="50" x2="300" y2="80" stroke="#0d47a1" stroke-width="2"/>
                    <line x1="300" y1="120" x2="300" y2="130" stroke="#0d47a1" stroke-width="2"/>
                    <line x1="300" y1="170" x2="300" y2="180" stroke="#0d47a1" stroke-width="2"/>
                    <line x1="300" y1="220" x2="300" y2="230" stroke="#0d47a1" stroke-width="2"/>
                    <line x1="300" y1="270" x2="300" y2="280" stroke="#0d47a1" stroke-width="2"/>
                    <line x1="300" y1="320" x2="300" y2="330" stroke="#0d47a1" stroke-width="2"/>
                    
                    <!-- 标签 -->
                    <text x="50" y="40" font-family="Arial" font-size="12" fill="#0d47a1">高层协议</text>
                    <text x="50" y="370" font-family="Arial" font-size="12" fill="#0d47a1">底层协议</text>
                </svg>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>协议层</th>
                        <th>功能描述</th>
                        <th>在Linux内核中的实现</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>应用层 (Profiles)</td>
                        <td>定义特定应用场景的互操作规范，如HFP、A2DP等</td>
                        <td>BlueZ profiles实现</td>
                    </tr>
                    <tr>
                        <td>中间件层</td>
                        <td>提供高层协议支持，如RFCOMM(串口仿真)、SDP(服务发现)</td>
                        <td>net/bluetooth/rfcomm, net/bluetooth/sdp</td>
                    </tr>
                    <tr>
                        <td>L2CAP</td>
                        <td>逻辑链路控制与适配协议，提供数据分段和重组</td>
                        <td>net/bluetooth/l2cap_core.c, net/bluetooth/l2cap.h</td>
                    </tr>
                    <tr>
                        <td>HCI</td>
                        <td>主机控制器接口，主机与控制器之间的通信接口</td>
                        <td>drivers/bluetooth/hci_*.c, include/net/bluetooth/hci*.h</td>
                    </tr>
                    <tr>
                        <td>LMP</td>
                        <td>链路管理协议，负责链路建立、安全和控制</td>
                        <td>集成在蓝牙控制器固件中</td>
                    </tr>
                    <tr>
                        <td>基带层</td>
                        <td>物理层通信，负责频率跳变、数据调制等</td>
                        <td>集成在蓝牙控制器硬件中</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>3. 基带协议 (Baseband Protocol)</h2>
            <p>基带协议是蓝牙技术的物理层实现，负责在2.4GHz ISM频段上进行无线通信。它定义了蓝牙设备的射频特性、调制方式、跳频机制等。</p>
            
            <h3>3.1 频率跳变</h3>
            <p>蓝牙使用自适应跳频(AFH)技术，在79个1MHz宽的信道之间以1600跳/秒的速度跳变，以避免干扰。</p>
            
            <div class="code-block">
<pre>
// 蓝牙频率计算示例
#define BLUETOOTH_BASE_FREQ 2402  // MHz

// 计算信道对应的频率
int bluetooth_channel_freq(int channel) {
    return BLUETOOTH_BASE_FREQ + channel;
}

// 跳频序列生成算法
void generate_hop_sequence(uint8_t *sequence, uint32_t clock, uint8_t address) {
    // 基于主设备时钟和地址生成伪随机跳频序列
    for (int i = 0; i < 79; i++) {
        sequence[i] = (address + clock + i) % 79;
    }
}
</pre>
            </div>
            
            <h3>3.2 物理链路类型</h3>
            <table>
                <thead>
                    <tr>
                        <th>链路类型</th>
                        <th>描述</th>
                        <th>应用场景</th>
                        <th>数据速率</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>SCO (同步面向连接)</td>
                        <td>对称、点对点、预留时隙的链路，用于语音传输</td>
                        <td>耳机、语音通话</td>
                        <td>64 Kbps</td>
                    </tr>
                    <tr>
                        <td>eSCO (扩展SCO)</td>
                        <td>SCO的扩展，支持重传和多种数据格式</td>
                        <td>高质量语音</td>
                        <td>64-128 Kbps</td>
                    </tr>
                    <tr>
                        <td>ACL (异步无连接)</td>
                        <td>不对称或对称、点对多点、分组交换链路</td>
                        <td>数据传输、文件传输</td>
                        <td>723.2 Kbps (非对称)</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="key-point">
                <h3>基带关键特性</h3>
                <ul>
                    <li><strong>时分双工(TDD)</strong>: 主从设备交替发送数据</li>
                    <li><strong>主从角色</strong>: 一个主设备最多可与7个从设备通信</li>
                    <li><strong>数据包格式</strong>: 接入码、包头、有效载荷</li>
                    <li><strong>错误检测与校正</strong>: CRC、FEC、ARQ</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>4. 链路管理协议 (LMP)</h2>
            <p>链路管理协议(LMP)负责蓝牙设备间链路的建立、配置和管理。它在基带协议之上运行，为上层协议提供可靠的链路服务。</p>
            
            <h3>4.1 LMP主要功能</h3>
            <ul>
                <li><strong>认证与加密</strong>: 管理设备间的安全连接</li>
                <li><strong>功率控制</strong>: 调整发射功率以优化能耗</li>
                <li><strong>链路质量监控</strong>: 评估和报告链路质量</li>
                <li><strong>角色切换</strong>: 主从设备角色转换</li>
                <li><strong>连接管理</strong>: 建立、维护和释放连接</li>
            </ul>
            
            <h3>4.2 LMP数据包格式</h3>
            <div class="code-block">
<pre>
// LMP数据包结构示例
struct lmp_pdu {
    uint8_t transaction_id:1;    // 事务ID (0:从设备发起, 1:主设备发起)
    uint8_t opcode:7;            // 操作码
    uint8_t payload[];           // 载荷数据
};

// 常见的LMP操作码
#define LMP_ACCEPTED         0x03
#define LMP_NOT_ACCEPTED     0x04
#define LMP_DETACH           0x07
#define LMP_AU_RAND          0x0B
#define LMP_SRES             0x0C
#define LMP_ENCRYPTION_MODE  0x0F
#define LMP_SETUP_COMPLETE   0x3D
</pre>
            </div>
            
            <h3>4.3 连接建立过程</h3>
            <ol>
                <li><strong>查询(Inquiry)</strong>: 设备发现周围的其他蓝牙设备</li>
                <li><strong>寻呼(Page)</strong>: 与特定设备建立连接</li>
                <li><strong>LMP协商</strong>: 交换能力信息，协商连接参数</li>
                <li><strong>认证</strong>: 验证设备身份</li>
                <li><strong>加密设置</strong>: 如需要，建立加密连接</li>
                <li><strong>连接完成</strong>: 链路建立完成，可以传输数据</li>
            </ol>
            
            <div class="note">
                <p><strong>注意：</strong>在Linux内核中，LMP功能主要由蓝牙控制器硬件实现，驱动程序通过HCI命令与控制器交互。</p>
            </div>
        </div>

        <div class="section">
            <h2>5. Linux内核中的蓝牙实现</h2>
            <p>Linux内核提供了完整的蓝牙协议栈实现，包括HCI驱动、L2CAP、SCO、RFCOMM等核心组件。</p>
            
            <h3>5.1 关键代码结构</h3>
            <div class="code-block">
<pre>
// Linux内核蓝牙子系统主要目录结构
net/bluetooth/
├── af_bluetooth.c      // 蓝牙协议族注册
├── hci_core.c          // HCI核心功能
├── hci_conn.c          // HCI连接管理
├── l2cap_core.c        // L2CAP核心实现
├── l2cap_sock.c        // L2CAP套接字接口
├── sco.c               // SCO音频连接
├── rfcomm/             // RFCOMM协议实现
│   ├── core.c
│   ├── sock.c
│   └── ...
└── hci/
    ├── hci_usb.c       // USB蓝牙驱动
    ├── hci_uart.c      // UART蓝牙驱动
    └── ...

// 蓝牙设备注册示例
static int my_bt_driver_probe(struct hci_dev *hdev)
{
    // 设置设备能力
    hdev->dev_type = HCI_PRIMARY;
    hdev->bus = HCI_USB;
    
    // 注册设备
    return hci_register_dev(hdev);
}
</pre>
            </div>
            
            <h3>5.2 驱动开发要点</h3>
            <ul>
                <li><strong>HCI驱动框架</strong>: 实现hci_driver结构体，注册到内核</li>
                <li><strong>数据传输</strong>: 使用sk_buff结构管理数据包</li>
                <li><strong>电源管理</strong>: 实现suspend/resume回调函数</li>
                <li><strong>设备发现</strong>: 处理查询和寻呼过程</li>
                <li><strong>错误处理</strong>: 完善的错误检测和恢复机制</li>
            </ul>
        </div>

        <div class="section">
            <h2>6. 总结</h2>
            <p>蓝牙核心规范提供了完整的无线通信解决方案，其分层架构确保了协议的灵活性和可扩展性。基带协议负责物理层通信，而链路管理协议则处理连接的管理和控制。</p>
            
            <div class="highlight">
                <p>作为Linux内核蓝牙驱动开发者，需要：</p>
                <ul>
                    <li>深入理解蓝牙核心规范的各个层次</li>
                    <li>掌握Linux内核蓝牙子系统的架构和API</li>
                    <li>熟悉HCI驱动开发流程和最佳实践</li>
                    <li>了解基带和LMP的工作原理，便于调试和优化</li>
                </ul>
            </div>
            
            <p>通过本章的学习，您应该对蓝牙核心规范有了全面的了解，为后续的蓝牙驱动开发实践打下了坚实的基础。</p>
        </div>

        <footer>
            <p>蓝海资料掘金营</p>
        </footer>
    </div>
</body>
</html>