<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙HFP协议驱动开发实战</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #FFC107;
            --accent-color: #2196F3;
            --background-color: #E8F5E9;
            --text-color: #333333;
            --card-bg: #FFFFFF;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
        }
        
        h3 {
            color: var(--accent-color);
        }
        
        .architecture {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        pre {
            background: #f5f5f5;
            border-left: 4px solid var(--accent-color);
            padding: 1rem;
            overflow-x: auto;
            border-radius: 4px;
        }
        
        code {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .highlight {
            background-color: var(--secondary-color);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            padding: 2rem 0;
            margin-top: 2rem;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: white;
            border-radius: 10px;
        }
        
        .flow-chart {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }
        
        .color-palette {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
        }
        
        .color-box {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .primary-color {
            background-color: var(--primary-color);
        }
        
        .secondary-color {
            background-color: var(--secondary-color);
        }
        
        .accent-color {
            background-color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蓝牙HFP协议驱动开发实战</h1>
            <div class="subtitle">语音通道建立、AT命令处理、音频路由切换</div>
        </header>
        
        <section>
            <h2>课程概述</h2>
            <p>本课程深入讲解Linux内核中蓝牙HFP（Hands-Free Profile）协议驱动的实现原理和开发实践。HFP协议是实现蓝牙免提通话功能的核心协议，广泛应用于车载系统、蓝牙耳机等设备。</p>
            
            <div class="architecture">
                <h3>HFP协议栈架构</h3>
                <svg width="100%" height="300" viewBox="0 0 800 300">
                    <rect x="50" y="50" width="200" height="60" rx="10" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="150" y="85" text-anchor="middle" fill="white" font-weight="bold">应用层</text>
                    
                    <rect x="300" y="50" width="200" height="60" rx="10" fill="#2196F3" stroke="#1565C0" stroke-width="2"/>
                    <text x="400" y="85" text-anchor="middle" fill="white" font-weight="bold">HFP协议层</text>
                    
                    <rect x="550" y="50" width="200" height="60" rx="10" fill="#FFC107" stroke="#FF8F00" stroke-width="2"/>
                    <text x="650" y="85" text-anchor="middle" fill="white" font-weight="bold">蓝牙核心栈</text>
                    
                    <line x1="250" y1="80" x2="300" y2="80" stroke="#666" stroke-width="2"/>
                    <line x1="500" y1="80" x2="550" y2="80" stroke="#666" stroke-width="2"/>
                    
                    <rect x="150" y="150" width="500" height="80" rx="10" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2"/>
                    <text x="400" y="190" text-anchor="middle" fill="#2E7D32" font-weight="bold">音频管理模块</text>
                    <text x="400" y="210" text-anchor="middle" fill="#2E7D32">音频路由、编解码、同步</text>
                    
                    <rect x="150" y="250" width="500" height="80" rx="10" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
                    <text x="400" y="290" text-anchor="middle" fill="#1565C0" font-weight="bold">AT命令处理模块</text>
                    <text x="400" y="310" text-anchor="middle" fill="#1565C0">命令解析、状态管理、事件响应</text>
                </svg>
            </div>
        </section>
        
        <section>
            <h2>语音通道建立</h2>
            <p>HFP语音通道建立是蓝牙免提功能的核心，涉及SCO（Synchronous Connection-Oriented）链路的建立和管理。</p>
            
            <h3>建立流程</h3>
            <ol>
                <li><span class="highlight">服务发现</span>：蓝牙设备发现HFP服务及特性</li>
                <li><span class="highlight">服务级连接</span>：建立RFCOMM连接用于AT命令传输</li>
                <li><span class="highlight">代码c协商</span>：协商音频编码格式（CVSD、mSBC等）</li>
                <li><span class="highlight">SCO链路建立</span>：建立同步音频传输链路</li>
                <li><span class="highlight">音频流启动</span>：开始双向音频数据传输</li>
            </ol>
            
            <div class="flow-chart">
                <svg width="600" height="400" viewBox="0 0 600 400">
                    <!-- 服务发现 -->
                    <rect x="50" y="50" width="200" height="40" rx="5" fill="#4CAF50" stroke="#2E7D32"/>
                    <text x="150" y="75" text-anchor="middle" fill="white">服务发现</text>
                    <line x1="150" y1="90" x2="150" y2="120" stroke="#666" stroke-width="2"/>
                    <polygon points="145,120 150,130 155,120" fill="#666"/>
                    
                    <!-- 服务级连接 -->
                    <rect x="50" y="130" width="200" height="40" rx="5" fill="#2196F3" stroke="#1565C0"/>
                    <text x="150" y="155" text-anchor="middle" fill="white">服务级连接</text>
                    <line x1="150" y1="170" x2="150" y2="200" stroke="#666" stroke-width="2"/>
                    <polygon points="145,200 150,210 155,200" fill="#666"/>
                    
                    <!-- 编解码协商 -->
                    <rect x="50" y="210" width="200" height="40" rx="5" fill="#FFC107" stroke="#FF8F00"/>
                    <text x="150" y="235" text-anchor="middle" fill="white">编解码协商</text>
                    <line x1="150" y1="250" x2="150" y2="280" stroke="#666" stroke-width="2"/>
                    <polygon points="145,280 150,290 155,280" fill="#666"/>
                    
                    <!-- SCO链路建立 -->
                    <rect x="50" y="290" width="200" height="40" rx="5" fill="#4CAF50" stroke="#2E7D32"/>
                    <text x="150" y="315" text-anchor="middle" fill="white">SCO链路建立</text>
                    <line x1="150" y1="330" x2="150" y2="360" stroke="#666" stroke-width="2"/>
                    <polygon points="145,360 150,370 155,360" fill="#666"/>
                    
                    <!-- 音频流启动 -->
                    <rect x="50" y="370" width="200" height="40" rx="5" fill="#2196F3" stroke="#1565C0"/>
                    <text x="150" y="395" text-anchor="middle" fill="white">音频流启动</text>
                </svg>
            </div>
            
            <h3>关键代码示例</h3>
            <pre><code>// SCO链路建立函数示例
static int hfp_setup_sco_connection(struct hci_conn *conn)
{
    struct hci_dev *hdev = conn->hdev;
    struct hci_cp_setup_sync_conn cp;
    
    memset(&cp, 0, sizeof(cp));
    
    cp.handle = cpu_to_le16(conn->handle);
    cp.pkt_type = cpu_to_le16(hdev->esco_type);
    cp.tx_bandwidth = cpu_to_le32(0x00001f40);
    cp.rx_bandwidth = cpu_to_le32(0x00001f40);
    
    // 设置编码参数
    if (conn->codec == HCI_CODEC_MSBC) {
        cp.max_latency = cpu_to_le16(0x0008);
        cp.retrans_effort = 0x02;  // 中等重传努力
        cp.voice_setting = cpu_to_le16(0x0060);  // mSBC编码
    } else {
        cp.max_latency = cpu_to_le16(0x000d);
        cp.retrans_effort = 0x01;  // 高质量重传努力
        cp.voice_setting = cpu_to_le16(0x0020);  // CVSD编码
    }
    
    return hci_send_cmd(hdev, HCI_OP_SETUP_SYNC_CONN, sizeof(cp), &cp);
}</code></pre>
        </section>
        
        <section>
            <h2>AT命令处理</h2>
            <p>AT命令是HFP协议中设备间通信的基础，用于控制呼叫、音量、网络状态等。</p>
            
            <h3>常用AT命令</h3>
            <table>
                <thead>
                    <tr>
                        <th>命令</th>
                        <th>功能</th>
                        <th>示例</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ATA</td>
                        <td>接听来电</td>
                        <td>ATA</td>
                    </tr>
                    <tr>
                        <td>AT+CHUP</td>
                        <td>挂断电话</td>
                        <td>AT+CHUP</td>
                    </tr>
                    <tr>
                        <td>AT+VGS</td>
                        <td>设置扬声器增益</td>
                        <td>AT+VGS=15</td>
                    </tr>
                    <tr>
                        <td>AT+VGM</td>
                        <td>设置麦克风增益</td>
                        <td>AT+VGM=15</td>
                    </tr>
                    <tr>
                        <td>AT+CCWA</td>
                        <td>呼叫等待通知</td>
                        <td>AT+CCWA=1</td>
                    </tr>
                    <tr>
                        <td>AT+CLIP</td>
                        <td>来电显示</td>
                        <td>AT+CLIP=1</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>AT命令处理状态机</h3>
            <div class="flow-chart">
                <svg width="500" height="300" viewBox="0 0 500 300">
                    <!-- 命令接收 -->
                    <circle cx="100" cy="100" r="30" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="100" y="105" text-anchor="middle" fill="white">接收</text>
                    
                    <!-- 解析 -->
                    <circle cx="200" cy="100" r="30" fill="#2196F3" stroke="#1565C0" stroke-width="2"/>
                    <text x="200" y="105" text-anchor="middle" fill="white">解析</text>
                    
                    <!-- 验证 -->
                    <circle cx="300" cy="100" r="30" fill="#FFC107" stroke="#FF8F00" stroke-width="2"/>
                    <text x="300" y="105" text-anchor="middle" fill="white">验证</text>
                    
                    <!-- 执行 -->
                    <circle cx="400" cy="100" r="30" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="400" y="105" text-anchor="middle" fill="white">执行</text>
                    
                    <!-- 连接线 -->
                    <line x1="130" y1="100" x2="170" y2="100" stroke="#666" stroke-width="2"/>
                    <line x1="230" y1="100" x2="270" y2="100" stroke="#666" stroke-width="2"/>
                    <line x1="330" y1="100" x2="370" y2="100" stroke="#666" stroke-width="2"/>
                    
                    <!-- 响应 -->
                    <rect x="200" y="180" width="100" height="40" rx="5" fill="#2196F3" stroke="#1565C0"/>
                    <text x="250" y="205" text-anchor="middle" fill="white">响应</text>
                    
                    <line x1="250" y1="140" x2="250" y2="180" stroke="#666" stroke-width="2"/>
                    <polygon points="245,180 250,170 255,180" fill="#666"/>
                </svg>
            </div>
            
            <h3>AT命令处理代码示例</h3>
            <pre><code>// AT命令解析和处理示例
static int hfp_parse_at_command(struct hfp_dev *dev, const char *buf, size_t len)
{
    char cmd[64];
    int params[4];
    int param_count;
    
    // 解析AT命令
    if (sscanf(buf, "AT+%[A-Z]=%d,%d,%d,%d", cmd, 
               &params[0], &params[1], &params[2], &params[3]) > 1) {
        param_count = sscanf(buf, "AT+%[A-Z]=%d,%d,%d,%d", cmd, 
                            &params[0], &params[1], &params[2], &params[3]) - 1;
    } else if (sscanf(buf, "AT+%[A-Z]", cmd) == 1) {
        param_count = 0;
    } else if (strncmp(buf, "ATA", 3) == 0) {
        // 处理ATA命令
        return hfp_answer_call(dev);
    } else if (strncmp(buf, "AT+CHUP", 7) == 0) {
        // 处理挂断命令
        return hfp_hangup_call(dev);
    } else {
        return -EINVAL;  // 无效命令
    }
    
    // 根据命令类型分发处理
    if (strcmp(cmd, "VGS") == 0 && param_count == 1) {
        return hfp_set_speaker_gain(dev, params[0]);
    } else if (strcmp(cmd, "VGM") == 0 && param_count == 1) {
        return hfp_set_microphone_gain(dev, params[0]);
    } else if (strcmp(cmd, "BRSF") == 0 && param_count == 1) {
        return hfp_handle_brsf(dev, params[0]);
    }
    
    return -ENOTSUPP;  // 不支持的命令
}</code></pre>
        </section>
        
        <section>
            <h2>音频路由切换</h2>
            <p>音频路由管理是HFP驱动中的重要功能，负责在多个音频设备间切换音频流。</p>
            
            <h3>音频路由场景</h3>
            <ul>
                <li><span class="highlight">蓝牙耳机 ↔ 手机扬声器</span>切换</li>
                <li><span class="highlight">车载系统 ↔ 手机</span>音频切换</li>
                <li>多设备间的<span class="highlight">音频抢占</span>管理</li>
                <li><span class="highlight">通话中</span>音频路由切换</li>
            </ul>
            
            <h3>音频路由状态表</h3>
            <table>
                <thead>
                    <tr>
                        <th>状态</th>
                        <th>音频源</th>
                        <th>音频目标</th>
                        <th>触发条件</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>IDLE</td>
                        <td>无</td>
                        <td>无</td>
                        <td>系统启动/无通话</td>
                    </tr>
                    <tr>
                        <td>INCOMING</td>
                        <td>网络</td>
                        <td>蓝牙设备</td>
                        <td>来电通知</td>
                    </tr>
                    <tr>
                        <td>ACTIVE</td>
                        <td>麦克风/网络</td>
                        <td>扬声器/网络</td>
                        <td>通话建立</td>
                    </tr>
                    <tr>
                        <td>SWITCHING</td>
                        <td>切换中</td>
                        <td>切换中</td>
                        <td>用户手动切换</td>
                    </tr>
                    <tr>
                        <td>HOLD</td>
                        <td>网络</td>
                        <td>无</td>
                        <td>通话保持</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>音频路由切换代码示例</h3>
            <pre><code>// 音频路由切换实现
static int hfp_switch_audio_route(struct hfp_dev *dev, 
                                 enum audio_route new_route)
{
    int ret;
    
    mutex_lock(&dev->audio_lock);
    
    // 检查当前状态是否允许切换
    if (dev->audio_state == AUDIO_STATE_SWITCHING) {
        mutex_unlock(&dev->audio_lock);
        return -EBUSY;
    }
    
    // 保存旧路由
    enum audio_route old_route = dev->current_route;
    
    // 更新状态为切换中
    dev->audio_state = AUDIO_STATE_SWITCHING;
    mutex_unlock(&dev->audio_lock);
    
    // 执行路由切换
    switch (new_route) {
    case AUDIO_ROUTE_BLUETOOTH:
        ret = hfp_switch_to_bluetooth(dev);
        break;
    case AUDIO_ROUTE_SPEAKER:
        ret = hfp_switch_to_speaker(dev);
        break;
    case AUDIO_ROUTE_WIRED:
        ret = hfp_switch_to_wired(dev);
        break;
    default:
        ret = -EINVAL;
        break;
    }
    
    mutex_lock(&dev->audio_lock);
    if (ret == 0) {
        dev->current_route = new_route;
        dev->audio_state = AUDIO_STATE_ACTIVE;
        
        // 通知上层音频路由已改变
        hfp_notify_audio_route_change(dev, old_route, new_route);
    } else {
        dev->audio_state = AUDIO_STATE_ACTIVE;
    }
    mutex_unlock(&dev->audio_lock);
    
    return ret;
}

// 切换到蓝牙音频路由
static int hfp_switch_to_bluetooth(struct hfp_dev *dev)
{
    struct snd_pcm *pcm;
    int ret;
    
    // 暂停当前音频流
    ret = snd_pcm_pause(dev->pcm_handle, 1);
    if (ret < 0) {
        pr_err("Failed to pause audio stream: %d\n", ret);
        return ret;
    }
    
    // 重新配置音频设备为蓝牙
    ret = snd_pcm_set_params(dev->pcm_handle,
                           SND_PCM_FORMAT_S16_LE,
                           SND_PCM_ACCESS_RW_INTERLEAVED,
                           1,  // 单声道
                           8000,  // 8kHz采样率
                           1,    // 允许重采样
                           50000); // 50ms延迟
    if (ret < 0) {
        pr_err("Failed to set audio params for Bluetooth: %d\n", ret);
        return ret;
    }
    
    // 恢复音频流
    ret = snd_pcm_pause(dev->pcm_handle, 0);
    if (ret < 0) {
        pr_err("Failed to resume audio stream: %d\n", ret);
        return ret;
    }
    
    return 0;
}</code></pre>
        </section>
        
        <section>
            <h2>调试与故障排除</h2>
            <p>HFP驱动开发过程中常见的调试技巧和问题解决方法。</p>
            
            <h3>常见问题</h3>
            <table>
                <thead>
                    <tr>
                        <th>问题现象</th>
                        <th>可能原因</th>
                        <th>解决方法</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>SCO连接失败</td>
                        <td>编码格式不匹配、带宽不足</td>
                        <td>检查编码协商、调整带宽参数</td>
                    </tr>
                    <tr>
                        <td>音频断续</td>
                        <td>缓冲区设置不当、系统负载高</td>
                        <td>调整缓冲区大小、优化系统性能</td>
                    </tr>
                    <tr>
                        <td>AT命令无响应</td>
                        <td>命令格式错误、状态机错误</td>
                        <td>检查命令格式、调试状态机逻辑</td>
                    </tr>
                    <tr>
                        <td>音频路由切换失败</td>
                        <td>资源冲突、权限问题</td>
                        <td>检查资源锁定、验证权限设置</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>调试工具</h3>
            <ul>
                <li><code>hcidump</code> - 蓝牙协议分析工具</li>
                <li><code>btmon</code> - 蓝牙监控工具</li>
                <li><code>alsamixer</code> - 音频设备控制工具</li>
                <li>内核动态调试（<code>dyndbg</code>）</li>
                <li>FTrace性能分析工具</li>
            </ul>
        </section>
        
        <footer>
            <p>蓝海资料掘金营</p>
        </footer>
    </div>
</body>
</html>