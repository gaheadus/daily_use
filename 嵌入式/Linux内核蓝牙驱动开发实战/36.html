<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙驱动测试方法 - Linux内核蓝牙驱动开发实战</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #FFC107;
            --accent-color: #2196F3;
            --light-color: #E8F5E9;
            --dark-color: #2E7D32;
            --text-color: #333;
            --bg-color: #F9FBE7;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        h2 {
            color: var(--dark-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        
        h3 {
            color: var(--accent-color);
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        pre {
            background-color: #f8f8f8;
            border-left: 4px solid var(--accent-color);
            padding: 1rem;
            overflow-x: auto;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        code {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .svg-container {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        footer {
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
            background-color: var(--dark-color);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .highlight {
            background-color: var(--light-color);
            padding: 0.5rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        ul, ol {
            padding-left: 1.5rem;
        }
        
        li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>蓝牙驱动测试方法</h1>
            <p>Linux内核蓝牙驱动开发实战 - 第36课</p>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2>课程概述</h2>
            <p>本课程将深入探讨Linux内核蓝牙驱动的测试方法，包括单元测试编写、集成测试流程以及自动化测试框架的构建。通过系统化的测试方法，确保蓝牙驱动的稳定性、可靠性和性能。</p>
        </div>

        <div class="card">
            <h2>1. 单元测试编写</h2>
            <p>单元测试是针对驱动中最小的可测试单元进行的测试，通常针对单个函数或模块。</p>
            
            <h3>1.1 单元测试框架</h3>
            <p>Linux内核提供了KUnit测试框架，专门用于内核代码的单元测试。</p>
            
            <div class="highlight">
                <h4>KUnit基本结构示例：</h4>
                <pre><code>#include &lt;kunit/test.h&gt;

/* 测试用例结构 */
static void test_bt_driver_init(struct kunit *test)
{
    struct bt_driver *driver;
    int ret;
    
    /* 测试驱动初始化 */
    driver = bt_driver_create();
    KUNIT_ASSERT_NOT_ERR_OR_NULL(test, driver);
    
    ret = bt_driver_init(driver);
    KUNIT_EXPECT_EQ(test, 0, ret);
    
    /* 清理资源 */
    bt_driver_destroy(driver);
}

/* 测试套件定义 */
static struct kunit_case bt_driver_test_cases[] = {
    KUNIT_CASE(test_bt_driver_init),
    {}
};

static struct kunit_suite bt_driver_test_suite = {
    .name = "bt_driver",
    .test_cases = bt_driver_test_cases,
};

kunit_test_suite(bt_driver_test_suite);</code></pre>
            </div>
            
            <h3>1.2 常用测试模式</h3>
            <table>
                <thead>
                    <tr>
                        <th>测试模式</th>
                        <th>描述</th>
                        <th>适用场景</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>边界值测试</td>
                        <td>测试输入参数的边界条件</td>
                        <td>缓冲区大小、超时值等</td>
                    </tr>
                    <tr>
                        <td>错误注入测试</td>
                        <td>模拟硬件故障或异常情况</td>
                        <td>内存分配失败、硬件错误</td>
                    </tr>
                    <tr>
                        <td>状态机测试</td>
                        <td>验证状态转换的正确性</td>
                        <td>连接状态管理、协议状态机</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>2. 集成测试流程</h2>
            <p>集成测试验证各个模块协同工作的正确性，重点关注模块间的接口和交互。</p>
            
            <h3>2.1 集成测试环境搭建</h3>
            <ul>
                <li><strong>硬件环境：</strong>蓝牙适配器、测试设备、信号衰减器</li>
                <li><strong>软件环境：</strong>Linux测试内核、BlueZ工具集、测试框架</li>
                <li><strong>网络环境：</strong>隔离的测试网络，避免干扰</li>
            </ul>
            
            <div class="svg-container">
                <h4>集成测试架构图</h4>
                <svg width="100%" height="300" viewBox="0 0 800 300">
                    <rect x="50" y="50" width="120" height="60" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="110" y="85" text-anchor="middle" fill="white">蓝牙驱动</text>
                    
                    <rect x="220" y="50" width="120" height="60" fill="#2196F3" stroke="#0D47A1" stroke-width="2"/>
                    <text x="280" y="85" text-anchor="middle" fill="white">HCI核心</text>
                    
                    <rect x="390" y="50" width="120" height="60" fill="#FFC107" stroke="#FF8F00" stroke-width="2"/>
                    <text x="450" y="85" text-anchor="middle" fill="black">L2CAP层</text>
                    
                    <rect x="560" y="50" width="120" height="60" fill="#E91E63" stroke="#AD1457" stroke-width="2"/>
                    <text x="620" y="85" text-anchor="middle" fill="white">RFCOMM</text>
                    
                    <!-- 连接线 -->
                    <line x1="170" y1="80" x2="220" y2="80" stroke="#666" stroke-width="2"/>
                    <line x1="340" y1="80" x2="390" y2="80" stroke="#666" stroke-width="2"/>
                    <line x1="510" y1="80" x2="560" y2="80" stroke="#666" stroke-width="2"/>
                    
                    <!-- 测试层 -->
                    <rect x="50" y="180" width="700" height="60" fill="#9C27B0" stroke="#6A1B9A" stroke-width="2" opacity="0.8"/>
                    <text x="400" y="215" text-anchor="middle" fill="white">集成测试框架</text>
                    
                    <!-- 测试连接线 -->
                    <line x1="110" y1="110" x2="110" y2="180" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="280" y1="110" x2="280" y2="180" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="450" y1="110" x2="450" y2="180" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="620" y1="110" x2="620" y2="180" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                </svg>
            </div>
            
            <h3>2.2 集成测试用例设计</h3>
            <ol>
                <li><strong>协议栈集成测试：</strong>验证HCI、L2CAP、RFCOMM等协议层的正确交互</li>
                <li><strong>设备发现测试：</strong>测试设备扫描、发现和配对流程</li>
                <li><strong>数据传输测试：</strong>验证数据在不同协议层的正确传输</li>
                <li><strong>电源管理测试：</strong>测试休眠、唤醒等电源管理功能</li>
                <li><strong>并发测试：</strong>验证多连接、多任务场景下的稳定性</li>
            </ol>
            
            <h3>2.3 集成测试脚本示例</h3>
            <pre><code>#!/bin/bash
# 蓝牙驱动集成测试脚本

echo "开始蓝牙驱动集成测试..."

# 加载蓝牙驱动模块
echo "加载蓝牙驱动模块..."
modprobe btusb
modprobe bluetooth

# 检查驱动加载状态
if lsmod | grep -q "btusb"; then
    echo "✓ 蓝牙驱动加载成功"
else
    echo "✗ 蓝牙驱动加载失败"
    exit 1
fi

# 启动蓝牙服务
echo "启动蓝牙服务..."
systemctl start bluetooth

# 测试设备发现功能
echo "测试设备发现功能..."
timeout 30s bluetoothctl scan on

# 测试协议栈功能
echo "测试L2CAP协议..."
python3 l2cap_test.py

# 性能测试
echo "执行性能测试..."
./bt_perf_test --duration=60 --connections=5

echo "集成测试完成！"</code></pre>
        </div>

        <div class="card">
            <h2>3. 自动化测试框架</h2>
            <p>自动化测试框架能够持续、高效地执行测试用例，及时发现回归问题。</p>
            
            <h3>3.1 测试框架架构</h3>
            <div class="svg-container">
                <svg width="100%" height="400" viewBox="0 0 800 400">
                    <!-- 测试管理 -->
                    <rect x="300" y="20" width="200" height="60" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                    <text x="400" y="55" text-anchor="middle" fill="white">测试管理服务器</text>
                    
                    <!-- CI/CD集成 -->
                    <rect x="50" y="100" width="150" height="60" fill="#2196F3" stroke="#0D47A1" stroke-width="2"/>
                    <text x="125" y="135" text-anchor="middle" fill="white">CI/CD系统</text>
                    
                    <!-- 测试执行器 -->
                    <rect x="250" y="100" width="150" height="60" fill="#FFC107" stroke="#FF8F00" stroke-width="2"/>
                    <text x="325" y="135" text-anchor="middle" fill="black">测试执行器</text>
                    
                    <!-- 结果分析 -->
                    <rect x="450" y="100" width="150" height="60" fill="#E91E63" stroke="#AD1457" stroke-width="2"/>
                    <text x="525" y="135" text-anchor="middle" fill="white">结果分析器</text>
                    
                    <!-- 报告生成 -->
                    <rect x="650" y="100" width="150" height="60" fill="#9C27B0" stroke="#6A1B9A" stroke-width="2"/>
                    <text x="725" y="135" text-anchor="middle" fill="white">报告生成器</text>
                    
                    <!-- 测试环境 -->
                    <rect x="150" y="200" width="500" height="120" fill="#607D8B" stroke="#37474F" stroke-width="2" opacity="0.8"/>
                    <text x="400" y="230" text-anchor="middle" fill="white">测试环境集群</text>
                    
                    <!-- 测试环境内部 -->
                    <rect x="180" y="250" width="100" height="50" fill="#795548" stroke="#4E342E" stroke-width="1"/>
                    <text x="230" y="277" text-anchor="middle" fill="white" font-size="12">设备A</text>
                    
                    <rect x="300" y="250" width="100" height="50" fill="#795548" stroke="#4E342E" stroke-width="1"/>
                    <text x="350" y="277" text-anchor="middle" fill="white" font-size="12">设备B</text>
                    
                    <rect x="420" y="250" width="100" height="50" fill="#795548" stroke="#4E342E" stroke-width="1"/>
                    <text x="470" y="277" text-anchor="middle" fill="white" font-size="12">设备C</text>
                    
                    <rect x="540" y="250" width="100" height="50" fill="#795548" stroke="#4E342E" stroke-width="1"/>
                    <text x="590" y="277" text-anchor="middle" fill="white" font-size="12">设备D</text>
                    
                    <!-- 连接线 -->
                    <line x1="400" y1="80" x2="400" y2="100" stroke="#666" stroke-width="2"/>
                    <line x1="125" y1="160" x2="125" y2="200" stroke="#666" stroke-width="2"/>
                    <line x1="325" y1="160" x2="325" y2="200" stroke="#666" stroke-width="2"/>
                    <line x1="525" y1="160" x2="525" y2="200" stroke="#666" stroke-width="2"/>
                    <line x1="725" y1="160" x2="725" y2="200" stroke="#666" stroke-width="2"/>
                </svg>
            </div>
            
            <h3>3.2 自动化测试工具链</h3>
            <table>
                <thead>
                    <tr>
                        <th>工具</th>
                        <th>用途</th>
                        <th>特点</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>KUnit</td>
                        <td>内核单元测试</td>
                        <td>内核原生支持，轻量级</td>
                    </tr>
                    <tr>
                        <td>Bluez Test Suite</td>
                        <td>蓝牙协议栈测试</td>
                        <td>专门针对BlueZ栈</td>
                    </tr>
                    <tr>
                        <td>Python + unittest</td>
                        <td>高层功能测试</td>
                        <td>灵活，易于扩展</td>
                    </tr>
                    <tr>
                        <td>Jenkins/GitLab CI</td>
                        <td>持续集成</td>
                        <td>自动化触发测试</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>3.3 自动化测试配置示例</h3>
            <pre><code># Jenkinsfile - 蓝牙驱动自动化测试流水线
pipeline {
    agent any
    stages {
        stage('代码检出') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/example/bt-driver.git'
            }
        }
        stage('编译内核') {
            steps {
                sh 'make -j$(nproc)'
            }
        }
        stage('单元测试') {
            steps {
                sh 'make modules_install'
                sh './run_kunit_tests.sh'
            }
        }
        stage('集成测试') {
            steps {
                sh './setup_test_environment.sh'
                sh './run_integration_tests.sh'
                sh './run_performance_tests.sh'
            }
        }
        stage('生成报告') {
            steps {
                sh './generate_test_report.py'
                publishHTML target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'test_reports',
                    reportFiles: 'index.html',
                    reportName: '蓝牙驱动测试报告'
                ]
            }
        }
    }
    post {
        always {
            emailext (
                subject: "蓝牙驱动测试结果: ${currentBuild.result}",
                body: "构建 ${env.BUILD_URL} 完成\n测试结果: ${currentBuild.result}",
                to: "dev-team@example.com"
            )
        }
    }
}</code></pre>
        </div>

        <div class="card">
            <h2>4. 测试最佳实践</h2>
            <ul>
                <li><strong>测试金字塔：</strong>构建多层次的测试体系，单元测试为基础，集成测试居中，UI测试为顶</li>
                <li><strong>持续测试：</strong>将测试集成到开发流程中，每次提交都触发自动化测试</li>
                <li><strong>测试数据管理：</strong>使用固定的测试数据，确保测试的可重复性</li>
                <li><strong>性能基准：</strong>建立性能基准，监控性能回归</li>
                <li><strong>错误报告：</strong>详细的错误日志和堆栈跟踪，便于问题定位</li>
            </ul>
        </div>

        <div class="card">
            <h2>5. 总结</h2>
            <p>蓝牙驱动测试是一个系统工程，需要结合单元测试、集成测试和自动化测试框架。通过完善的测试体系，可以显著提高驱动代码的质量和稳定性，减少生产环境中的问题。</p>
            <p>在实际开发中，建议：</p>
            <ol>
                <li>为每个新功能编写对应的测试用例</li>
                <li>建立持续集成流水线，自动化执行测试</li>
                <li>定期进行代码覆盖率分析，确保测试完整性</li>
                <li>建立性能基准，监控性能变化</li>
            </ol>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>蓝海资料掘金营</p>
        </div>
    </footer>
</body>
</html>