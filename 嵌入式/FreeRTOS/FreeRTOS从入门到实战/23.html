<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS实战：智能家居灯控节点设计</title>
    <style>
        :root {
            --tech-blue: #3498db;
            --vitality-orange: #f39c12;
            --fresh-green: #2ecc71;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: var(--dark-text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(90deg, var(--tech-blue), var(--fresh-green));
            color: white;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            border-left: 6px solid var(--tech-blue);
        }
        h2 {
            color: var(--tech-blue);
            border-bottom: 2px solid var(--vitality-orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h2 svg {
            width: 28px;
            height: 28px;
        }
        h3 {
            color: var(--fresh-green);
            margin: 15px 0 10px;
        }
        ul, ol {
            padding-left: 25px;
            margin: 15px 0;
        }
        li {
            margin-bottom: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: var(--tech-blue);
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Consolas', monospace;
            border-left: 5px solid var(--vitality-orange);
        }
        code {
            background: #f1f1f1;
            padding: 3px 6px;
            border-radius: 4px;
            color: #c7254e;
            font-family: 'Consolas', monospace;
        }
        .arch-diagram {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 25px 0;
            padding: 20px;
        }
        .task-card {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            flex: 1 1 300px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-top: 4px solid var(--vitality-orange);
        }
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: white;
            background: linear-gradient(90deg, var(--tech-blue), #2980b9);
            border-radius: 15px;
            font-size: 1.1rem;
            letter-spacing: 1px;
            box-shadow: var(--shadow);
        }
        .highlight {
            background: linear-gradient(90deg, #fff9c4, #ffecb3);
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>FreeRTOS综合实战一：智能家居灯控节点</h1>
        <p class="subtitle">设计一个模拟智能灯控节点，包含按键扫描、网络通信、LED控制任务，使用队列、事件组进行任务间通信</p>
    </header>

    <main>
        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-6h2v4h-2z"/>
                </svg>
                项目概述
            </h2>
            <p>本实战项目旨在通过一个模拟的智能灯控节点，综合运用FreeRTOS的多任务管理、任务间通信（队列、事件组）等核心机制。项目模拟真实智能家居场景，包含三个核心任务：</p>
            <ul>
                <li><span class="highlight">按键扫描任务</span>：检测用户物理输入（如开关、调光）。</li>
                <li><span class="highlight">网络通信任务</span>：模拟接收来自手机APP或云平台的远程控制指令。</li>
                <li><span class="highlight">LED控制任务</span>：根据指令控制LED的开关、亮度及闪烁模式。</li>
            </ul>
            <p>任务间通过<strong>队列</strong>传递具体控制命令，通过<strong>事件组</strong>同步状态与触发特定动作，实现解耦与高效协作。</p>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z"/>
                </svg>
                系统软件架构图
            </h2>
            <div class="arch-diagram">
                <svg viewBox="0 0 800 300" width="100%" height="100%">
                    <!-- 背景框 -->
                    <rect x="10" y="10" width="780" height="280" rx="10" fill="#e8f4fc" stroke="#3498db" stroke-width="2"/>
                    
                    <!-- 任务框 -->
                    <rect x="100" y="60" width="150" height="60" rx="8" fill="#3498db" stroke="#1c5a7a" stroke-width="2"/>
                    <text x="175" y="95" text-anchor="middle" fill="white" font-size="16" font-weight="bold">按键扫描任务</text>
                    
                    <rect x="320" y="60" width="150" height="60" rx="8" fill="#f39c12" stroke="#b36d00" stroke-width="2"/>
                    <text x="395" y="95" text-anchor="middle" fill="white" font-size="16" font-weight="bold">网络通信任务</text>
                    
                    <rect x="540" y="60" width="150" height="60" rx="8" fill="#2ecc71" stroke="#1e7a4c" stroke-width="2"/>
                    <text x="615" y="95" text-anchor="middle" fill="white" font-size="16" font-weight="bold">LED控制任务</text>
                    
                    <!-- 通信机制 -->
                    <rect x="100" y="180" width="250" height="60" rx="8" fill="#9b59b6" stroke="#6c3483" stroke-width="2"/>
                    <text x="225" y="215" text-anchor="middle" fill="white" font-size="16" font-weight="bold">命令队列</text>
                    
                    <rect x="440" y="180" width="250" height="60" rx="8" fill="#e74c3c" stroke="#922b21" stroke-width="2"/>
                    <text x="565" y="215" text-anchor="middle" fill="white" font-size="16" font-weight="bold">事件组</text>
                    
                    <!-- 连接线 -->
                    <path d="M175 120 L175 150 Q175 160 225 160 L225 180" stroke="#2c3e50" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M395 120 L395 150 Q395 160 345 160 L345 180" stroke="#2c3e50" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M615 120 L615 150 Q615 160 565 160 L565 180" stroke="#2c3e50" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M225 240 L225 260 Q225 270 175 270 L175 240" stroke="#2c3e50" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrow)"/>
                    <path d="M565 240 L565 260 Q565 270 615 270 L615 240" stroke="#2c3e50" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrow)"/>
                    
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#2c3e50"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            <p>架构说明：三个核心任务通过<strong>命令队列</strong>传递结构化控制指令，通过<strong>事件组</strong>广播状态变化（如网络连接成功、报警触发）。LED控制任务作为指令的最终执行者，监听队列和事件组。</p>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                任务详细设计
            </h2>
            <div class="task-card">
                <div class="card">
                    <h3>1. 按键扫描任务 (KeyScan_Task)</h3>
                    <ul>
                        <li><strong>优先级</strong>: 中 (高于网络，低于LED控制)</li>
                        <li><strong>功能</strong>: 循环扫描GPIO按键，消抖处理，识别短按/长按。</li>
                        <li><strong>输出</strong>: 将按键事件封装为命令结构体，发送至命令队列。</li>
                        <li><strong>关键API</strong>: <code>xQueueSend()</code>, <code>vTaskDelay()</code></li>
                    </ul>
                </div>
                <div class="card">
                    <h3>2. 网络通信任务 (NetComm_Task)</h3>
                    <ul>
                        <li><strong>优先级</strong>: 低</li>
                        <li><strong>功能</strong>: 模拟UART/Wi-Fi接收，解析JSON格式指令。</li>
                        <li><strong>输出</strong>: 解析后的命令发送至队列；网络事件（如连接）设置事件组位。</li>
                        <li><strong>关键API</strong>: <code>xQueueSend()</code>, <code>xEventGroupSetBits()</code></li>
                    </ul>
                </div>
                <div class="card">
                    <h3>3. LED控制任务 (LEDCtrl_Task)</h3>
                    <ul>
                        <li><strong>优先级</strong>: 高 (需及时响应)</li>
                        <li><strong>功能</strong>: 阻塞式等待队列命令和事件组。执行开关、调光、闪烁。</li>
                        <li><strong>关键API</strong>: <code>xQueueReceive()</code>, <code>xEventGroupWaitBits()</code>, PWM控制。</li>
                    </ul>
                </div>
            </div>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                数据结构与通信定义
            </h2>
            <h3>命令枚举与结构体</h3>
            <pre><code>/* 命令类型枚举 */
typedef enum {
    CMD_LED_ON,
    CMD_LED_OFF,
    CMD_LED_TOGGLE,
    CMD_LED_SET_BRIGHTNESS, // 设置亮度 0-100
    CMD_LED_BLINK           // 设置闪烁模式
} CmdType_t;

/* 命令结构体 */
typedef struct {
    CmdType_t type;
    uint32_t  value;        // 亮度值、闪烁间隔等
    uint32_t  source;       // 命令来源：按键、网络
} LedCommand_t;</code></pre>

            <h3>事件组位定义</h3>
            <pre><code>/* 事件组位定义 (每个位代表一个事件) */
#define EVENT_NET_CONNECTED    (1 << 0)  // 网络连接成功
#define EVENT_ALARM_TRIGGERED  (1 << 1)  // 报警触发
#define EVENT_CONFIG_UPDATED   (1 << 2)  // 配置更新
#define EVENT_ALL_SYNC         (EVENT_NET_CONNECTED | EVENT_ALARM_TRIGGERED | EVENT_CONFIG_UPDATED)</code></pre>

            <h3>全局句柄声明</h3>
            <pre><code>/* FreeRTOS通信句柄 */
QueueHandle_t     xCmdQueue;      // 命令队列句柄
EventGroupHandle_t xLedEventGroup; // 事件组句柄
SemaphoreHandle_t xMutex_LED;     // LED资源互斥锁（可选）</code></pre>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                </svg>
                核心代码片段
            </h2>
            <h3>1. 创建队列与事件组 (main函数内)</h3>
            <pre><code>int main(void) {
    // 硬件初始化...
    
    // 创建命令队列，可容纳10个命令
    xCmdQueue = xQueueCreate(10, sizeof(LedCommand_t));
    
    // 创建事件组
    xLedEventGroup = xEventGroupCreate();
    
    // 创建任务
    xTaskCreate(KeyScan_Task, "KeyScan", 128, NULL, 2, NULL);
    xTaskCreate(NetComm_Task, "NetComm", 256, NULL, 1, NULL);
    xTaskCreate(LEDCtrl_Task, "LEDCtrl", 256, NULL, 3, NULL);
    
    // 启动调度器
    vTaskStartScheduler();
    
    while(1);
}</code></pre>

            <h3>2. LED控制任务实现 (示例)</h3>
            <pre><code>void LEDCtrl_Task(void *pvParameters) {
    LedCommand_t cmd;
    EventBits_t events;
    const TickType_t xMaxBlockTime = pdMS_TO_TICKS(1000);
    
    for(;;) {
        // 等待事件组中的任意事件，最多阻塞1000ms
        events = xEventGroupWaitBits(xLedEventGroup,
                                     EVENT_ALL_SYNC,
                                     pdTRUE,   // 清除已触发的位
                                     pdFALSE,  // 不需要所有位同时满足
                                     xMaxBlockTime);
        
        if(events & EVENT_NET_CONNECTED) {
            // 网络连接成功，可执行特定动作，如同步状态
            // ...
        }
        
        // 非阻塞式从队列接收命令
        if(xQueueReceive(xCmdQueue, &cmd, 0) == pdTRUE) {
            switch(cmd.type) {
                case CMD_LED_ON:
                    GPIO_Set(LED_PIN);
                    break;
                case CMD_LED_SET_BRIGHTNESS:
                    // 设置PWM占空比，模拟调光
                    TIM_SetDuty(cmd.value);
                    break;
                case CMD_LED_BLINK:
                    // 启动软件定时器实现闪烁
                    // ...
                    break;
                default:
                    break;
            }
        }
        vTaskDelay(pdMS_TO_TICKS(20)); // 适当延时，防止空转
    }
}</code></pre>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                关键知识点总结
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>知识点</th>
                        <th>在本项目中的应用</th>
                        <th>FreeRTOS API</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>任务创建与管理</strong></td>
                        <td>创建三个优先级不同的任务，实现功能划分。</td>
                        <td><code>xTaskCreate()</code>, <code>vTaskDelay()</code></td>
                    </tr>
                    <tr>
                        <td><strong>队列通信</strong></td>
                        <td>传递结构化的LED控制命令，实现生产者-消费者模型。</td>
                        <td><code>xQueueCreate()</code>, <code>xQueueSend()</code>, <code>xQueueReceive()</code></td>
                    </tr>
                    <tr>
                        <td><strong>事件组同步</strong></td>
                        <td>广播系统事件（如网络状态），实现多任务同步等待。</td>
                        <td><code>xEventGroupCreate()</code>, <code>xEventGroupSetBits()</code>, <code>xEventGroupWaitBits()</code></td>
                    </tr>
                    <tr>
                        <td><strong>优先级调度</strong></td>
                        <td>LED控制任务优先级最高，确保实时响应。</td>
                        <td>任务优先级参数配置</td>
                    </tr>
                    <tr>
                        <td><strong>资源管理</strong></td>
                        <td>（扩展）可使用互斥锁保护共享硬件资源（如PWM）。</td>
                        <td><code>xSemaphoreCreateMutex()</code></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                扩展思考与练习
            </h2>
            <ol>
                <li><strong>增加看门狗</strong>：如何为每个任务设置软件看门狗，防止任务卡死？</li>
                <li><strong>低功耗优化</strong>：在无操作时，如何让系统进入低功耗模式（Tickless模式）？</li>
                <li><strong>命令队列溢出处理</strong>：当队列满时，是等待、覆盖还是丢弃新命令？如何实现？</li>
                <li><strong>增加状态反馈</strong>：LED状态改变后，如何通过网络任务反馈给手机APP？</li>
                <li><strong>使用通知(Notification)</strong>：尝试用任务通知替代事件组，实现轻量级同步。</li>
            </ol>
            <p style="margin-top: 15px; padding: 15px; background: #e8f8f5; border-radius: 8px;">
                <strong>动手挑战</strong>：在现有框架上，增加一个“环境光传感器任务”，根据环境光线自动调节LED亮度，并通过事件组通知LED任务。
            </p>
        </section>
    </main>

    <footer>
        <p>蓝海资料掘金营 © 2023 - FreeRTOS从入门到实战课程</p>
        <p>智能家居节点实战项目 | 理论与实践结合，打造嵌入式核心能力</p>
    </footer>
</body>
</html>