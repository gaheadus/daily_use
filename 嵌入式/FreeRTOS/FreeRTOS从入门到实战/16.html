<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS从入门到实战 - 16、中断管理</title>
    <style>
        :root {
            --tech-blue: #3498db;
            --vitality-orange: #f39c12;
            --fresh-green: #2ecc71;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: var(--dark-text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(90deg, var(--tech-blue), var(--fresh-green));
            color: white;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px var(--shadow);
        }
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        section {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
            border-left: 6px solid var(--tech-blue);
            transition: transform 0.3s;
        }
        section:hover {
            transform: translateY(-5px);
        }
        h2 {
            color: var(--tech-blue);
            border-bottom: 2px dashed var(--vitality-orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        h3 {
            color: var(--fresh-green);
            margin: 15px 0 10px;
        }
        p {
            margin-bottom: 15px;
            text-align: justify;
        }
        ul, ol {
            padding-left: 25px;
            margin-bottom: 20px;
        }
        li {
            margin-bottom: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow);
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: var(--tech-blue);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f2f9ff;
        }
        tr:hover {
            background-color: #e8f4fc;
        }
        .code-block {
            background: #2d3a4b;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            border-left: 5px solid var(--vitality-orange);
        }
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }
        svg {
            max-width: 100%;
            height: auto;
        }
        .highlight {
            background-color: #fffacd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .tip-box {
            background: #e8f6f3;
            border-left: 5px solid var(--fresh-green);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            background: linear-gradient(90deg, var(--dark-text), #34495e);
            color: white;
            border-radius: 15px;
            font-size: 1.2rem;
            letter-spacing: 2px;
            box-shadow: 0 -5px 15px var(--shadow);
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 2rem;
            }
            section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>FreeRTOS从入门到实战</h1>
        <div class="subtitle">第16讲：中断管理（Interrupt）</div>
        <div class="subtitle">中断处理原则、ISR专用API、优先级协调、中断延迟</div>
    </header>

    <main>
        <section>
            <h2>一、FreeRTOS中断处理核心原则</h2>
            <p>在FreeRTOS中，中断服务程序（ISR）的设计必须遵循特定的原则，以确保实时性和系统稳定性。</p>
            <ul>
                <li><span class="highlight">快速进出</span>：ISR应尽可能短小精悍，只完成最紧急的处理，将耗时操作交给任务。</li>
                <li><span class="highlight">不可阻塞</span>：ISR中不能调用可能引起阻塞的函数（如<code>vTaskDelay()</code>）。</li>
                <li><span class="highlight">使用FromISR API</span>：在ISR中必须使用带<code>FromISR</code>后缀的专用API。</li>
                <li><span class="highlight">优先级管理</span>：合理配置中断优先级与任务优先级，避免优先级反转。</li>
                <li><span class="highlight">延迟处理</span>：通过二值信号量、队列等机制将处理延迟到任务中。</li>
            </ul>
            <div class="svg-container">
                <svg width="600" height="200" viewBox="0 0 600 200">
                    <rect x="10" y="80" width="120" height="40" rx="5" fill="var(--tech-blue)" opacity="0.8"/>
                    <text x="70" y="105" text-anchor="middle" fill="white" font-weight="bold">硬件中断</text>
                    <path d="M130 100 L170 100" stroke="var(--vitality-orange)" stroke-width="3"/>
                    <rect x="170" y="80" width="120" height="40" rx="5" fill="var(--fresh-green)" opacity="0.8"/>
                    <text x="230" y="105" text-anchor="middle" fill="white" font-weight="bold">ISR快速处理</text>
                    <path d="M290 100 L330 100" stroke="var(--vitality-orange)" stroke-width="3"/>
                    <rect x="330" y="80" width="120" height="40" rx="5" fill="var(--vitality-orange)" opacity="0.8"/>
                    <text x="390" y="105" text-anchor="middle" fill="white" font-weight="bold">发送信号/队列</text>
                    <path d="M450 100 L490 100" stroke="var(--tech-blue)" stroke-width="3"/>
                    <rect x="490" y="80" width="120" height="40" rx="5" fill="#9b59b6" opacity="0.8"/>
                    <text x="550" y="105" text-anchor="middle" fill="white" font-weight="bold">任务处理</text>
                    <text x="300" y="180" text-anchor="middle" fill="var(--dark-text)" font-size="14">中断延迟处理流程</text>
                </svg>
            </div>
        </section>

        <section>
            <h2>二、中断服务程序（ISR）专用API（带FromISR后缀）</h2>
            <p>FreeRTOS提供了一系列专用于ISR的函数，这些函数以<code>FromISR</code>结尾，它们不会进行任务切换判断，且可在中断上下文中安全调用。</p>
            <h3>常用FromISR API列表</h3>
            <table>
                <thead>
                    <tr>
                        <th>函数名称</th>
                        <th>功能描述</th>
                        <th>注意事项</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>xQueueSendToBackFromISR()</code></td>
                        <td>在ISR中向队列尾部发送数据</td>
                        <td>需检查返回值，可能队列已满</td>
                    </tr>
                    <tr>
                        <td><code>xQueueReceiveFromISR()</code></td>
                        <td>在ISR中从队列接收数据</td>
                        <td>通常ISR只发送，不接收</td>
                    </tr>
                    <tr>
                        <td><code>xSemaphoreGiveFromISR()</code></td>
                        <td>在ISR中释放信号量</td>
                        <td>常用于解除任务阻塞</td>
                    </tr>
                    <tr>
                        <td><code>xTaskResumeFromISR()</code></td>
                        <td>在ISR中恢复被挂起的任务</td>
                        <td>需谨慎使用，避免频繁恢复</td>
                    </tr>
                    <tr>
                        <td><code>vTaskNotifyGiveFromISR()</code></td>
                        <td>在ISR中直接通知任务</td>
                        <td>高效轻量，替代信号量</td>
                    </tr>
                </tbody>
            </table>
            <h3>代码示例：在ISR中释放二值信号量</h3>
            <div class="code-block">
<pre>
// 全局定义
SemaphoreHandle_t xBinarySemaphore;

// 任务函数：等待信号量并处理
void vProcessingTask(void *pvParameters) {
    for(;;) {
        // 等待信号量（阻塞）
        if(xSemaphoreTake(xBinarySemaphore, portMAX_DELAY) == pdTRUE) {
            // 执行实际处理
            process_interrupt_data();
        }
    }
}

// 中断服务程序
void USART1_IRQHandler(void) {
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;

    // 清除中断标志
    USART_ClearITPendingBit(USART1, USART_IT_RXNE);

    // 读取数据（示例）
    uint8_t data = USART_ReceiveData(USART1);

    // 释放信号量，通知任务
    xSemaphoreGiveFromISR(xBinarySemaphore, &xHigherPriorityTaskWoken);

    // 如果需要，执行上下文切换
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}
</pre>
            </div>
            <div class="tip-box">
                <strong>提示：</strong> <code>xHigherPriorityTaskWoken</code> 参数用于记录API调用是否唤醒了更高优先级的任务。若为<code>pdTRUE</code>，则应在ISR退出前调用<code>portYIELD_FROM_ISR()</code>以立即进行任务切换。
            </div>
        </section>

        <section>
            <h2>三、中断优先级与任务优先级协调</h2>
            <p>在FreeRTOS中，中断优先级（硬件）和任务优先级（软件）需要合理配置，以避免冲突并保证实时性。</p>
            <div class="svg-container">
                <svg width="600" height="300" viewBox="0 0 600 300">
                    <rect x="50" y="20" width="500" height="260" rx="10" fill="none" stroke="var(--dark-text)" stroke-width="2"/>
                    <text x="300" y="50" text-anchor="middle" fill="var(--tech-blue)" font-size="18" font-weight="bold">中断优先级 vs 任务优先级</text>
                    <!-- 中断优先级条 -->
                    <rect x="100" y="80" width="400" height="30" rx="5" fill="url(#grad1)"/>
                    <text x="90" y="100" text-anchor="end" fill="var(--dark-text)" font-size="14">中断优先级</text>
                    <text x="110" y="102" fill="white" font-size="12">高 (7)</text>
                    <text x="480" y="102" fill="white" font-size="12">低 (0)</text>
                    <!-- 任务优先级条 -->
                    <rect x="100" y="150" width="400" height="30" rx="5" fill="url(#grad2)"/>
                    <text x="90" y="170" text-anchor="end" fill="var(--dark-text)" font-size="14">任务优先级</text>
                    <text x="110" y="172" fill="white" font-size="12">高 (configMAX_PRIORITIES-1)</text>
                    <text x="480" y="172" fill="white" font-size="12">低 (0)</text>
                    <!-- 关键区说明 -->
                    <rect x="100" y="210" width="400" height="60" rx="5" fill="#fef9e7" stroke="var(--vitality-orange)" stroke-width="2"/>
                    <text x="300" y="230" text-anchor="middle" fill="var(--dark-text)" font-size="14" font-weight="bold">关键规则</text>
                    <text x="300" y="255" text-anchor="middle" fill="var(--dark-text)" font-size="12">中断优先级必须高于所有任务优先级，才能保证实时性</text>
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:0.9"/>
                            <stop offset="100%" style="stop-color:#f1c40f;stop-opacity:0.7"/>
                        </linearGradient>
                        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:0.9"/>
                            <stop offset="100%" style="stop-color:#3498db;stop-opacity:0.7"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <h3>配置要点</h3>
            <ol>
                <li><strong>中断优先级数值</strong>：取决于MCU架构（如ARM Cortex-M中数值越小优先级越高）。</li>
                <li><strong>FreeRTOS可管理的中断</strong>：通过<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>或<code>configMAX_API_CALL_INTERRUPT_PRIORITY</code>定义，只有优先级低于此值的中断才能安全调用FromISR API。</li>
                <li><strong>任务优先级</strong>：由<code>configMAX_PRIORITIES</code>定义范围，通常0为最低。</li>
                <li><strong>协调原则</strong>：最高优先级的中断应能打断任何任务，但不应被任务阻塞。</li>
            </ol>
        </section>

        <section>
            <h2>四、中断延迟（Interrupt Latency）</h2>
            <p>中断延迟是指从中断发生到ISR第一条指令开始执行的时间。它是衡量RTOS实时性的关键指标。</p>
            <h3>影响中断延迟的因素</h3>
            <ul>
                <li><strong>硬件延迟</strong>：CPU响应中断的固有时间。</li>
                <li><strong>中断屏蔽</strong>：全局中断或特定优先级中断被关闭的时间。</li>
                <li><strong>RTOS内核状态</strong>：内核正在执行临界区代码时，会暂时屏蔽中断。</li>
                <li><strong>中断嵌套</strong>：高优先级中断正在执行时，低优先级中断需等待。</li>
            </ul>
            <h3>FreeRTOS优化措施</h3>
            <table>
                <thead>
                    <tr>
                        <th>措施</th>
                        <th>说明</th>
                        <th>效果</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>短临界区</td>
                        <td>使用<code>taskENTER_CRITICAL()</code>/<code>taskEXIT_CRITICAL()</code>时，尽量缩短临界区长度</td>
                        <td>减少中断屏蔽时间</td>
                    </tr>
                    <tr>
                        <td>中断嵌套允许</td>
                        <td>合理配置中断控制器，允许高优先级中断打断低优先级ISR</td>
                        <td>提高高优先级中断响应</td>
                    </tr>
                    <tr>
                        <td>FromISR API</td>
                        <td>使用专用API，避免在ISR中进行复杂判断</td>
                        <td>缩短ISR执行时间</td>
                    </tr>
                    <tr>
                        <td>优先级分组</td>
                        <td>合理设置ARM Cortex-M的优先级分组（如使用4位抢占优先级）</td>
                        <td>灵活的中断嵌套控制</td>
                    </tr>
                </tbody>
            </table>
            <div class="tip-box">
                <strong>最佳实践：</strong> 对于极其苛刻的实时要求，可将中断分为两类：一类直接在全中断使能环境下处理（不调用任何RTOS API），另一类则通过FromISR API与任务通信。同时，应使用<code>portSET_INTERRUPT_MASK_FROM_ISR()</code>等函数精细控制中断屏蔽范围。
            </div>
        </section>

        <section>
            <h2>五、软件架构示意图</h2>
            <p>以下SVG图展示了FreeRTOS中断管理的典型软件架构：</p>
            <div class="svg-container">
                <svg width="650" height="400" viewBox="0 0 650 400">
                    <rect x="50" y="30" width="550" height="340" rx="10" fill="#f8f9fa" stroke="var(--tech-blue)" stroke-width="2"/>
                    <text x="325" y="60" text-anchor="middle" fill="var(--dark-text)" font-size="20" font-weight="bold">FreeRTOS中断管理架构</text>
                    <!-- 硬件层 -->
                    <rect x="80" y="90" width="200" height="60" rx="5" fill="var(--tech-blue)" opacity="0.9"/>
                    <text x="180" y="125" text-anchor="middle" fill="white" font-size="16" font-weight="bold">硬件中断源</text>
                    <text x="180" y="145" text-anchor="middle" fill="#ddd" font-size="12">定时器、UART、GPIO等</text>
                    <!-- ISR层 -->
                    <rect x="320" y="90" width="200" height="60" rx="5" fill="var(--fresh-green)" opacity="0.9"/>
                    <text x="420" y="125" text-anchor="middle" fill="white" font-size="16" font-weight="bold">中断服务程序(ISR)</text>
                    <text x="420" y="145" text-anchor="middle" fill="#ddd" font-size="12">快速处理，调用FromISR API</text>
                    <!-- 任务层 -->
                    <rect x="80" y="200" width="440" height="120" rx="5" fill="var(--vitality-orange)" opacity="0.8"/>
                    <text x="300" y="230" text-anchor="middle" fill="white" font-size="16" font-weight="bold">FreeRTOS任务</text>
                    <rect x="100" y="250" width="120" height="50" rx="5" fill="#9b59b6" opacity="0.9"/>
                    <text x="160" y="280" text-anchor="middle" fill="white" font-size="14">高优先级任务</text>
                    <rect x="250" y="250" width="120" height="50" rx="5" fill="#3498db" opacity="0.9"/>
                    <text x="310" y="280" text-anchor="middle" fill="white" font-size="14">中优先级任务</text>
                    <rect x="400" y="250" width="120" height="50" rx="5" fill="#1abc9c" opacity="0.9"/>
                    <text x="460" y="280" text-anchor="middle" fill="white" font-size="14">低优先级任务</text>
                    <!-- 连接线 -->
                    <path d="M180 150 L180 200" stroke="var(--dark-text)" stroke-width="2" stroke-dasharray="5,5"/>
                    <path d="M420 150 L420 200" stroke="var(--dark-text)" stroke-width="2" stroke-dasharray="5,5"/>
                    <path d="M280 150 L280 200" stroke="var(--dark-text)" stroke-width="2" stroke-dasharray="5,5"/>
                    <!-- 箭头和标签 -->
                    <polygon points="280,90 275,80 285,80" fill="var(--tech-blue)"/>
                    <text x="280" y="75" text-anchor="middle" fill="var(--dark-text)" font-size="12">中断触发</text>
                    <polygon points="420,200 415,190 425,190" fill="var(--fresh-green)"/>
                    <text x="420" y="185" text-anchor="middle" fill="var(--dark-text)" font-size="12">信号量/队列</text>
                    <!-- 内核 -->
                    <rect x="250" y="330" width="100" height="30" rx="5" fill="#2c3e50"/>
                    <text x="300" y="350" text-anchor="middle" fill="white" font-size="14">FreeRTOS内核</text>
                    <text x="325" y="390" text-anchor="middle" fill="var(--dark-text)" font-size="14">优先级调度、资源管理、中断协调</text>
                </svg>
            </div>
        </section>
    </main>

    <footer>
        蓝海资料掘金营
    </footer>
</body>
</html>