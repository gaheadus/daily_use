<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS实战：外部中断与任务通信</title>
    <style>
        :root {
            --tech-blue: #4A90E2;
            --vital-orange: #FF8C42;
            --fresh-green: #6BCF7F;
            --light-gray: #F5F7FA;
            --dark-gray: #2C3E50;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, var(--light-gray) 0%, #E3F2FD 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(to right, var(--tech-blue), #2A6DB0);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 10px 20px rgba(42, 109, 176, 0.2);
        }
        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        section {
            background: white;
            border-radius: 12px;
            padding: 1.8rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 6px solid var(--vital-orange);
        }
        h2 {
            color: var(--tech-blue);
            border-bottom: 2px solid var(--fresh-green);
            padding-bottom: 0.5rem;
            margin-bottom: 1.2rem;
            font-size: 1.8rem;
        }
        h3 {
            color: var(--vital-orange);
            margin: 1.2rem 0 0.8rem;
        }
        p {
            margin-bottom: 1rem;
        }
        ul, ol {
            padding-left: 1.5rem;
            margin-bottom: 1.2rem;
        }
        li {
            margin-bottom: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        th {
            background-color: var(--tech-blue);
            color: white;
            padding: 1rem;
            text-align: left;
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        pre {
            background: #f8f9fa;
            border-left: 4px solid var(--fresh-green);
            padding: 1.2rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.2rem 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        code {
            background: #eef7ff;
            padding: 2px 6px;
            border-radius: 4px;
            color: #d63384;
            font-family: 'Consolas', monospace;
        }
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }
        .architecture {
            background: #f0f8ff;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px dashed var(--tech-blue);
        }
        .note {
            background: #FFF9E6;
            border-left: 5px solid var(--vital-orange);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1.5rem 0;
        }
        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem;
            color: white;
            background: linear-gradient(to right, var(--dark-gray), #1a2530);
            border-radius: 12px;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }
        .step-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .step {
            background: #f0faff;
            padding: 1.2rem;
            border-radius: 10px;
            border-top: 4px solid var(--fresh-green);
        }
        .step h4 {
            color: var(--tech-blue);
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>FreeRTOS从入门到实战</h1>
        <div class="subtitle">第17讲：中断实战 - 外部中断与任务通信</div>
        <div class="subtitle">配置按键外部中断，在ISR中发送信号量或通知，唤醒高优先级任务进行处理</div>
    </header>

    <main>
        <section>
            <h2>课程目标</h2>
            <p>掌握在FreeRTOS中如何安全、高效地处理外部中断，并通过信号量或任务通知实现中断服务程序（ISR）与任务之间的通信，从而将耗时操作从ISR转移到高优先级任务中执行，确保系统的实时性与稳定性。</p>
            <div class="svg-container">
                <svg width="600" height="120" viewBox="0 0 600 120">
                    <rect x="10" y="50" width="120" height="40" rx="8" fill="#4A90E2" stroke="#2A6DB0" stroke-width="2"/>
                    <text x="70" y="75" text-anchor="middle" fill="white" font-weight="bold" font-size="14">按键按下</text>
                    <path d="M130 70 L170 70" stroke="#FF8C42" stroke-width="3" marker-end="url(#arrow)"/>
                    <rect x="170" y="50" width="120" height="40" rx="8" fill="#FF8C42" stroke="#D96B1A" stroke-width="2"/>
                    <text x="230" y="75" text-anchor="middle" fill="white" font-weight="bold" font-size="14">外部中断ISR</text>
                    <path d="M290 70 L330 70" stroke="#6BCF7F" stroke-width="3" marker-end="url(#arrow)"/>
                    <rect x="330" y="50" width="120" height="40" rx="8" fill="#6BCF7F" stroke="#3A9F50" stroke-width="2"/>
                    <text x="390" y="75" text-anchor="middle" fill="white" font-weight="bold" font-size="14">发送信号量</text>
                    <path d="M450 70 L490 70" stroke="#4A90E2" stroke-width="3" marker-end="url(#arrow)"/>
                    <rect x="490" y="50" width="120" height="40" rx="8" fill="#4A90E2" stroke="#2A6DB0" stroke-width="2"/>
                    <text x="550" y="75" text-anchor="middle" fill="white" font-weight="bold" font-size="14">任务处理</text>
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#FF8C42"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>

        <section class="architecture">
            <h2>软件架构图</h2>
            <div class="svg-container">
                <svg width="700" height="300" viewBox="0 0 700 300">
                    <!-- 硬件层 -->
                    <rect x="50" y="20" width="600" height="60" rx="5" fill="#E3F2FD" stroke="#4A90E2" stroke-width="2"/>
                    <text x="350" y="55" text-anchor="middle" fill="#2A6DB0" font-weight="bold" font-size="16">硬件层 (按键/GPIO)</text>
                    <path d="M350 80 L350 110" stroke="#4A90E2" stroke-width="2" stroke-dasharray="5,5"/>
                    
                    <!-- 驱动层 -->
                    <rect x="150" y="110" width="400" height="60" rx="5" fill="#FFF3E0" stroke="#FF8C42" stroke-width="2"/>
                    <text x="350" y="145" text-anchor="middle" fill="#D96B1A" font-weight="bold" font-size="16">驱动层 (GPIO中断配置)</text>
                    <path d="M350 170 L350 200" stroke="#FF8C42" stroke-width="2" stroke-dasharray="5,5"/>
                    
                    <!-- RTOS层 -->
                    <rect x="100" y="200" width="500" height="80" rx="5" fill="#E8F5E9" stroke="#6BCF7F" stroke-width="2"/>
                    <text x="350" y="225" text-anchor="middle" fill="#2E7D32" font-weight="bold" font-size="16">FreeRTOS层</text>
                    <text x="350" y="255" text-anchor="middle" fill="#2E7D32" font-size="14">信号量/任务通知 + 高优先级处理任务</text>
                    
                    <!-- 连接线 -->
                    <path d="M250 110 L250 80" stroke="#4A90E2" stroke-width="1"/>
                    <path d="M450 110 L450 80" stroke="#4A90E2" stroke-width="1"/>
                    <circle cx="250" cy="80" r="5" fill="#4A90E2"/>
                    <circle cx="450" cy="80" r="5" fill="#4A90E2"/>
                    
                    <!-- 标签 -->
                    <text x="250" y="75" text-anchor="middle" fill="#2A6DB0" font-size="12">中断触发</text>
                    <text x="450" y="75" text-anchor="middle" fill="#2A6DB0" font-size="12">ISR调用</text>
                </svg>
            </div>
        </section>

        <section>
            <h2>核心概念</h2>
            <div class="step-box">
                <div class="step">
                    <h4>外部中断</h4>
                    <p>由外部硬件事件（如按键按下、传感器信号）触发，打断CPU当前执行流，立即跳转到中断服务程序（ISR）。</p>
                </div>
                <div class="step">
                    <h4>ISR设计原则</h4>
                    <ul>
                        <li>快进快出，避免阻塞</li>
                        <li>不调用可能阻塞的API</li>
                        <li>通过通信机制唤醒任务处理</li>
                    </ul>
                </div>
                <div class="step">
                    <h4>任务通信机制</h4>
                    <ul>
                        <li><strong>信号量</strong>：二进制/计数信号量，ISR中给出，任务中获取</li>
                        <li><strong>任务通知</strong>：轻量级信号，直接通知特定任务</li>
                    </ul>
                </div>
            </div>
        </section>

        <section>
            <h2>实战步骤</h2>
            <ol>
                <li><strong>硬件配置</strong>：配置GPIO引脚为输入模式，使能外部中断，设置触发边沿（下降沿/上升沿）。</li>
                <li><strong>创建通信对象</strong>：创建二进制信号量或任务通知所需变量。</li>
                <li><strong>编写ISR</strong>：在中断服务函数中清除中断标志，调用FreeRTOS专用于ISR的API发送信号量或任务通知。</li>
                <li><strong>创建处理任务</strong>：创建高优先级任务，等待信号量或通知，收到后执行实际处理逻辑（如消抖、记录按键值、更新状态）。</li>
                <li><strong>优先级与阻塞</strong>：确保处理任务优先级高于大部分任务，并在等待通信对象时进入阻塞状态，让出CPU资源。</li>
            </ol>
        </section>

        <section>
            <h2>代码示例：信号量方式</h2>
            <pre><code>#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "main.h"

// 定义信号量句柄
SemaphoreHandle_t xButtonSemaphore = NULL;

// 高优先级处理任务
void vButtonTask(void *pvParameters) {
    while(1) {
        // 等待信号量，永久阻塞
        if(xSemaphoreTake(xButtonSemaphore, portMAX_DELAY) == pdTRUE) {
            // 实际处理：消抖、逻辑处理
            HAL_GPIO_TogglePin(LED_GPIO_Port, LED_Pin);
            printf("按键被按下，任务已处理！\r\n");
        }
    }
}

// 外部中断回调函数（STM32 HAL库示例）
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    
    if(GPIO_Pin == KEY_Pin) {
        // 给出信号量（ISR专用API）
        xSemaphoreGiveFromISR(xButtonSemaphore, &xHigherPriorityTaskWoken);
        
        // 如果需要，进行任务切换
        portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
    }
}

int main(void) {
    // 硬件初始化...
    
    // 创建二进制信号量
    xButtonSemaphore = xSemaphoreCreateBinary();
    
    // 创建按键处理任务（高优先级）
    xTaskCreate(vButtonTask, "ButtonTask", 128, NULL, 3, NULL);
    
    // 启动调度器
    vTaskStartScheduler();
    
    while(1);
}</code></pre>
        </section>

        <section>
            <h2>代码示例：任务通知方式</h2>
            <pre><code>#include "FreeRTOS.h"
#include "task.h"

// 定义任务句柄
TaskHandle_t xButtonTaskHandle = NULL;

// 按键处理任务
void vButtonTask(void *pvParameters) {
    uint32_t ulNotificationValue;
    while(1) {
        // 等待任务通知，永久阻塞
        ulNotificationValue = ulTaskNotifyTake(pdTRUE, portMAX_DELAY);
        
        if(ulNotificationValue > 0) {
            // 实际处理
            HAL_GPIO_TogglePin(LED_GPIO_Port, LED_Pin);
            printf("收到通知，处理次数：%lu\r\n", ulNotificationValue);
        }
    }
}

// 外部中断回调
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    
    if(GPIO_Pin == KEY_Pin) {
        // 发送任务通知（ISR专用API）
        vTaskNotifyGiveFromISR(xButtonTaskHandle, &xHigherPriorityTaskWoken);
        
        // 如果需要，进行任务切换
        portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
    }
}

int main(void) {
    // 硬件初始化...
    
    // 创建按键处理任务
    xTaskCreate(vButtonTask, "ButtonTask", 128, NULL, 3, &xButtonTaskHandle);
    
    // 启动调度器
    vTaskStartScheduler();
    
    while(1);
}</code></pre>
        </section>

        <section>
            <h2>两种方式对比</h2>
            <table>
                <thead>
                    <tr>
                        <th>特性</th>
                        <th>信号量</th>
                        <th>任务通知</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>速度</strong></td>
                        <td>较慢</td>
                        <td>更快（轻量级）</td>
                    </tr>
                    <tr>
                        <td><strong>内存占用</strong></td>
                        <td>需要单独分配信号量对象</td>
                        <td>使用任务自带结构，无需额外对象</td>
                    </tr>
                    <tr>
                        <td><strong>灵活性</strong></td>
                        <td>可被多个任务等待</td>
                        <td>只能通知一个特定任务</td>
                    </tr>
                    <tr>
                        <td><strong>适用场景</strong></td>
                        <td>多个任务等待同一事件</td>
                        <td>一对一事件通知，追求效率</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>关键注意事项</h2>
            <div class="note">
                <p><strong>注意：</strong>在ISR中必须使用FreeRTOS提供的“FromISR”结尾的API，不可使用普通任务API。</p>
            </div>
            <ul>
                <li><strong>中断优先级</strong>：确保FreeRTOS可管理的中断优先级设置正确（通常低于<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code>）。</li>
                <li><strong>消抖处理</strong>：硬件消抖或任务中软件消抖，避免在ISR中做延时。</li>
                <li><strong>资源保护</strong>：如果处理任务访问共享资源，需使用互斥量或临界区进行保护。</li>
                <li><strong>性能监测</strong>：使用FreeRTOS跟踪工具监测中断频率与任务响应时间。</li>
            </ul>
        </section>

        <section>
            <h2>总结与拓展</h2>
            <p>本讲实现了FreeRTOS下经典的中断-任务通信模式，将耗时操作从ISR剥离，保证了系统的实时性。这是嵌入式RTOS开发的核心模式之一。</p>
            <p><strong>拓展思考：</strong></p>
            <ul>
                <li>如何扩展以支持多个按键？</li>
                <li>如果处理任务也需要阻塞等待其他事件，应如何设计？</li>
                <li>如何结合队列（Queue）在ISR中传递数据（如按键值）给任务？</li>
            </ul>
        </section>
    </main>

    <footer>
        蓝海资料掘金营
    </footer>
</body>
</html>