<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理50问 - 任务通知值获取</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }
        
        .header h1 {
            color: #00695c;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #00796b;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .content-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: #00796b;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #80cbc4;
        }
        
        h3 {
            color: #004d40;
            margin: 15px 0 10px;
        }
        
        p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        ul, ol {
            margin-left: 25px;
            margin-bottom: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .code-block {
            background-color: #f5f5f5;
            border-left: 4px solid #4db6ac;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            overflow-x: auto;
        }
        
        pre {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f1f8e9;
        }
        
        tr:hover {
            background-color: #e0f2f1;
        }
        
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }
        
        .svg-diagram {
            max-width: 100%;
            height: auto;
        }
        
        .note-box {
            background-color: #e1f5fe;
            border-left: 4px solid #0288d1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .warning-box {
            background-color: #ffecb3;
            border-left: 4px solid #ffa000;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #4db6ac;
            color: #00796b;
            font-weight: 500;
        }
        
        .function-signature {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: bold;
            border: 1px solid #a5d6a7;
        }
        
        .example-section {
            background-color: #f9fbe7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #dce775;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FreeRTOS任务管理50问</h1>
            <div class="subtitle">第29问：任务通知值获取 - xTaskNotifyWait函数的使用</div>
        </div>
        
        <div class="content-section">
            <h2>1. 函数概述</h2>
            <p><code>xTaskNotifyWait</code> 是FreeRTOS中用于等待任务通知的函数。它允许任务等待通知，并在收到通知时获取通知值。这个函数是实现任务间同步和通信的重要工具。</p>
            
            <div class="function-signature">
                BaseType_t xTaskNotifyWait( uint32_t ulBitsToClearOnEntry, 
                                          uint32_t ulBitsToClearOnExit, 
                                          uint32_t *pulNotificationValue, 
                                          TickType_t xTicksToWait );
            </div>
            
            <div class="svg-container">
                <svg class="svg-diagram" width="600" height="200" viewBox="0 0 600 200">
                    <rect x="50" y="50" width="500" height="100" rx="10" fill="#e1f5fe" stroke="#4db6ac" stroke-width="2"/>
                    <text x="300" y="80" text-anchor="middle" font-size="16" font-weight="bold" fill="#00695c">任务等待通知</text>
                    <text x="300" y="110" text-anchor="middle" font-size="14" fill="#00796b">xTaskNotifyWait函数</text>
                    
                    <path d="M 50 100 L 20 100" stroke="#4db6ac" stroke-width="2" fill="none"/>
                    <path d="M 20 95 L 20 105 L 10 100 Z" fill="#4db6ac"/>
                    <text x="10" y="120" text-anchor="middle" font-size="12" fill="#00796b">等待</text>
                    
                    <path d="M 550 100 L 580 100" stroke="#4db6ac" stroke-width="2" fill="none"/>
                    <path d="M 580 95 L 580 105 L 590 100 Z" fill="#4db6ac"/>
                    <text x="590" y="120" text-anchor="middle" font-size="12" fill="#00796b">通知到达</text>
                    
                    <circle cx="150" cy="100" r="8" fill="#ff9800"/>
                    <circle cx="300" cy="100" r="8" fill="#ff9800"/>
                    <circle cx="450" cy="100" r="8" fill="#ff9800"/>
                </svg>
            </div>
        </div>
        
        <div class="content-section">
            <h2>2. 参数详解</h2>
            <table>
                <thead>
                    <tr>
                        <th>参数</th>
                        <th>类型</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ulBitsToClearOnEntry</td>
                        <td>uint32_t</td>
                        <td>在进入等待状态前，要清除任务通知值中的哪些位</td>
                    </tr>
                    <tr>
                        <td>ulBitsToClearOnExit</td>
                        <td>uint32_t</td>
                        <td>在退出函数前，要清除任务通知值中的哪些位</td>
                    </tr>
                    <tr>
                        <td>pulNotificationValue</td>
                        <td>uint32_t *</td>
                        <td>指向变量的指针，用于存储接收到的通知值</td>
                    </tr>
                    <tr>
                        <td>xTicksToWait</td>
                        <td>TickType_t</td>
                        <td>等待通知的最大时间（以时钟节拍为单位）</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="note-box">
                <strong>注意：</strong> 如果设置 xTicksToWait 为 portMAX_DELAY，任务将无限期等待通知（需要配置 configUSE_TASK_NOTIFICATIONS 为 1）。
            </div>
        </div>
        
        <div class="content-section">
            <h2>3. 返回值说明</h2>
            <ul>
                <li><strong>pdTRUE</strong> - 成功接收到通知</li>
                <li><strong>pdFALSE</strong> - 在指定的超时时间内未接收到通知</li>
            </ul>
            
            <div class="svg-container">
                <svg class="svg-diagram" width="500" height="150" viewBox="0 0 500 150">
                    <rect x="50" y="50" width="200" height="50" rx="5" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                    <text x="150" y="75" text-anchor="middle" font-size="14" fill="#2e7d32">pdTRUE</text>
                    <text x="150" y="95" text-anchor="middle" font-size="12" fill="#388e3c">成功接收通知</text>
                    
                    <rect x="250" y="50" width="200" height="50" rx="5" fill="#ffcdd2" stroke="#f44336" stroke-width="2"/>
                    <text x="350" y="75" text-anchor="middle" font-size="14" fill="#c62828">pdFALSE</text>
                    <text x="350" y="95" text-anchor="middle" font-size="12" fill="#d32f2f">超时未接收</text>
                    
                    <path d="M 125 100 L 125 120 L 100 120 L 100 130 L 125 130 L 125 150" stroke="#4db6ac" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    <path d="M 375 100 L 375 120 L 400 120 L 400 130 L 375 130 L 375 150" stroke="#4db6ac" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4db6ac"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>
        
        <div class="content-section">
            <h2>4. 使用场景</h2>
            <ol>
                <li><strong>任务同步</strong> - 一个任务等待另一个任务完成特定操作</li>
                <li><strong>事件通知</strong> - 任务等待特定事件的发生</li>
                <li><strong>数据传递</strong> - 通过通知值传递简单的数据</li>
                <li><strong>替代二进制信号量</strong> - 作为轻量级的同步机制</li>
            </ol>
            
            <div class="svg-container">
                <svg class="svg-diagram" width="600" height="300" viewBox="0 0 600 300">
                    <!-- 任务同步 -->
                    <rect x="50" y="30" width="200" height="40" rx="5" fill="#bbdefb" stroke="#2196f3" stroke-width="2"/>
                    <text x="150" y="55" text-anchor="middle" font-size="12" fill="#0d47a1">任务A</text>
                    
                    <rect x="50" y="100" width="200" height="40" rx="5" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                    <text x="150" y="125" text-anchor="middle" font-size="12" fill="#1b5e20">任务B</text>
                    
                    <path d="M 150 70 L 150 100" stroke="#2196f3" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="160" y="90" text-anchor="start" font-size="10" fill="#1565c0">等待通知</text>
                    
                    <path d="M 250 125 L 320 125 L 320 55 L 250 55" stroke="#4caf50" stroke-width="2"/>
                    <text x="285" y="115" text-anchor="middle" font-size="10" fill="#2e7d32">发送通知</text>
                    
                    <!-- 事件通知 -->
                    <rect x="350" y="30" width="200" height="40" rx="5" fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                    <text x="450" y="55" text-anchor="middle" font-size="12" fill="#ff6f00">事件处理任务</text>
                    
                    <circle cx="450" cy="120" r="25" fill="#f48fb1" stroke="#e91e63" stroke-width="2"/>
                    <text x="450" y="125" text-anchor="middle" font-size="10" fill="#ad1457">事件</text>
                    
                    <path d="M 450 70 L 450 95" stroke="#ffc107" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="460" y="85" text-anchor="start" font-size="10" fill="#ff8f00">等待事件</text>
                    
                    <path d="M 475 120 L 550 120 L 550 55 L 475 55" stroke="#e91e63" stroke-width="2"/>
                    <text x="512" y="110" text-anchor="middle" font-size="10" fill="#c2185b">事件发生</text>
                </svg>
            </div>
        </div>
        
        <div class="content-section">
            <h2>5. 使用示例</h2>
            
            <div class="example-section">
                <h3>示例1：基本使用</h3>
                <div class="code-block">
                    <pre>// 任务函数示例
void vTaskExample( void *pvParameters )
{
    uint32_t ulNotificationValue;
    BaseType_t xResult;
    
    for( ;; )
    {
        // 等待通知，不清除任何位，无限期等待
        xResult = xTaskNotifyWait( 
                    0x00,              // 进入时不清除任何位
                    0xffffffff,        // 退出时清除所有位
                    &ulNotificationValue, // 存储通知值
                    portMAX_DELAY );   // 无限期等待
        
        if( xResult == pdTRUE )
        {
            // 成功接收到通知
            // 处理通知值 ulNotificationValue
            if( ulNotificationValue == 0x01 )
            {
                // 处理事件1
            }
            else if( ulNotificationValue == 0x02 )
            {
                // 处理事件2
            }
        }
    }
}</pre>
                </div>
            </div>
            
            <div class="example-section">
                <h3>示例2：带超时的等待</h3>
                <div class="code-block">
                    <pre>// 带超时的任务通知等待
void vTaskWithTimeout( void *pvParameters )
{
    uint32_t ulNotificationValue;
    BaseType_t xResult;
    const TickType_t xMaxWaitTime = pdMS_TO_TICKS( 1000 ); // 等待1秒
    
    for( ;; )
    {
        // 等待通知，最多等待1秒
        xResult = xTaskNotifyWait( 
                    0x00,              // 进入时不清除任何位
                    0xffffffff,        // 退出时清除所有位
                    &ulNotificationValue, 
                    xMaxWaitTime );    // 最多等待1秒
        
        if( xResult == pdTRUE )
        {
            // 成功接收到通知
            // 处理通知值
            processNotification( ulNotificationValue );
        }
        else
        {
            // 超时，执行其他操作
            handleTimeout();
        }
    }
}</pre>
                </div>
            </div>
            
            <div class="example-section">
                <h3>示例3：位操作</h3>
                <div class="code-block">
                    <pre>// 使用位操作的任务通知
void vTaskBitwise( void *pvParameters )
{
    uint32_t ulNotificationValue;
    BaseType_t xResult;
    
    for( ;; )
    {
        // 等待通知，清除第0位和第1位，保留其他位
        xResult = xTaskNotifyWait( 
                    0x03,              // 进入时清除位0和位1
                    0x00,              // 退出时不清除任何位
                    &ulNotificationValue, 
                    portMAX_DELAY );
        
        if( xResult == pdTRUE )
        {
            // 检查特定的位
            if( ( ulNotificationValue & 0x01 ) != 0 )
            {
                // 位0被设置
                handleEvent1();
            }
            
            if( ( ulNotificationValue & 0x02 ) != 0 )
            {
                // 位1被设置
                handleEvent2();
            }
            
            if( ( ulNotificationValue & 0x04 ) != 0 )
            {
                // 位2被设置
                handleEvent3();
            }
        }
    }
}</pre>
                </div>
            </div>
        </div>
        
        <div class="content-section">
            <h2>6. 注意事项</h2>
            <div class="warning-box">
                <strong>重要提醒：</strong>
                <ul>
                    <li>使用前确保 <code>configUSE_TASK_NOTIFICATIONS</code> 已设置为1</li>
                    <li>任务通知是轻量级的，每个任务只能有一个通知值</li>
                    <li>通知值是一个32位无符号整数，可以用于传递数据或状态</li>
                    <li>使用位操作时，注意位的清除和设置顺序</li>
                    <li>在中断服务程序中使用 <code>xTaskNotifyFromISR</code> 发送通知</li>
                </ul>
            </div>
            
            <h3>与相关函数的比较</h3>
            <table>
                <thead>
                    <tr>
                        <th>函数</th>
                        <th>用途</th>
                        <th>特点</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>xTaskNotifyWait</td>
                        <td>等待任务通知</td>
                        <td>可以等待并获取通知值，支持位操作</td>
                    </tr>
                    <tr>
                        <td>ulTaskNotifyTake</td>
                        <td>等待任务通知（计数型）</td>
                        <td>专用于计数型通知，类似计数信号量</td>
                    </tr>
                    <tr>
                        <td>xTaskNotify</td>
                        <td>发送任务通知</td>
                        <td>发送通知到指定任务，支持多种操作</td>
                    </tr>
                    <tr>
                        <td>xTaskNotifyFromISR</td>
                        <td>在ISR中发送任务通知</td>
                        <td>中断安全版本，用于中断服务程序</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="content-section">
            <h2>7. 软件架构图</h2>
            <div class="svg-container">
                <svg class="svg-diagram" width="700" height="400" viewBox="0 0 700 400">
                    <!-- 应用层 -->
                    <rect x="50" y="30" width="600" height="60" rx="5" fill="#e1f5fe" stroke="#4db6ac" stroke-width="2"/>
                    <text x="350" y="50" text-anchor="middle" font-size="16" font-weight="bold" fill="#00695c">应用层</text>
                    <text x="350" y="70" text-anchor="middle" font-size="12" fill="#00796b">用户任务和应用程序</text>
                    
                    <!-- FreeRTOS API层 -->
                    <rect x="100" y="120" width="500" height="60" rx="5" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                    <text x="350" y="140" text-anchor="middle" font-size="16" font-weight="bold" fill="#2e7d32">FreeRTOS API层</text>
                    <text x="350" y="160" text-anchor="middle" font-size="12" fill="#388e3c">任务通知API</text>
                    
                    <!-- 任务通知函数 -->
                    <rect x="150" y="200" width="100" height="40" rx="5" fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                    <text x="200" y="220" text-anchor="middle" font-size="12" fill="#ff6f00">xTaskNotifyWait</text>
                    
                    <rect x="270" y="200" width="100" height="40" rx="5" fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                    <text x="320" y="220" text-anchor="middle" font-size="12" fill="#ff6f00">xTaskNotify</text>
                    
                    <rect x="390" y="200" width="120" height="40" rx="5" fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                    <text x="450" y="220" text-anchor="middle" font-size="12" fill="#ff6f00">xTaskNotifyFromISR</text>
                    
                    <!-- 内核层 -->
                    <rect x="150" y="280" width="400" height="60" rx="5" fill="#f8bbd9" stroke="#e91e63" stroke-width="2"/>
                    <text x="350" y="300" text-anchor="middle" font-size="16" font-weight="bold" fill="#ad1457">FreeRTOS内核</text>
                    <text x="350" y="320" text-anchor="middle" font-size="12" fill="#c2185b">任务调度和通知管理</text>
                    
                    <!-- 连接线 -->
                    <path d="M 350 90 L 350 120" stroke="#4db6ac" stroke-width="2"/>
                    <path d="M 200 180 L 200 200" stroke="#4caf50" stroke-width="2"/>
                    <path d="M 320 180 L 320 200" stroke="#4caf50" stroke-width="2"/>
                    <path d="M 450 180 L 450 200" stroke="#4caf50" stroke-width="2"/>
                    <path d="M 350 240 L 350 280" stroke="#e91e63" stroke-width="2"/>
                    
                    <!-- 箭头 -->
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto">
                            <path d="M0,0 L10,5 L0,10 Z" fill="#4db6ac"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>
        
        <div class="footer">
            蓝海资料掘金营
        </div>
    </div>
</body>
</html>