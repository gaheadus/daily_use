<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理50问 - 任务如何安全地删除自己</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }
        
        .header h1 {
            color: #00695c;
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header .subtitle {
            color: #00796b;
            font-size: 1.3em;
            font-weight: 500;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #00796b;
            border-left: 5px solid #4db6ac;
            padding-left: 15px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .card h3 {
            color: #004d40;
            margin: 15px 0 10px;
            font-size: 1.2em;
        }
        
        .card p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .code-block {
            background: #f5f5f5;
            border-left: 4px solid #4db6ac;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            overflow-x: auto;
        }
        
        pre {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .warning {
            background-color: #fff8e1;
            border-left: 4px solid #ffb300;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .tip {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e0f2f1;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #4db6ac;
            color: #00796b;
            font-weight: 500;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FreeRTOS任务管理50问</h1>
            <div class="subtitle">第17问：任务如何安全地删除自己</div>
        </div>
        
        <div class="content">
            <div class="card">
                <h2>任务删除自身概述</h2>
                <p>在FreeRTOS中，任务删除自身是一个常见的操作，但需要谨慎处理以避免资源泄漏和系统不稳定。任务可以通过调用<code>vTaskDelete(NULL)</code>函数来删除自己。</p>
                
                <div class="svg-container">
                    <svg width="400" height="200" viewBox="0 0 400 200">
                        <rect x="50" y="50" width="300" height="100" rx="10" fill="#e1f5fe" stroke="#4db6ac" stroke-width="2"/>
                        <text x="200" y="80" text-anchor="middle" font-family="Arial" font-size="16" fill="#00695c">任务运行中</text>
                        <text x="200" y="110" text-anchor="middle" font-family="Arial" font-size="16" fill="#00695c">调用vTaskDelete(NULL)</text>
                        <text x="200" y="140" text-anchor="middle" font-family="Arial" font-size="16" fill="#00695c">任务被删除</text>
                        <path d="M200 150 L200 180 L100 180 L100 50" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4db6ac"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
                
                <h3>删除自身的方法</h3>
                <p>任务删除自身的最简单方法是调用<code>vTaskDelete(NULL)</code>。传递NULL作为参数表示删除调用该函数的任务本身。</p>
                
                <div class="code-block">
                    <pre>void vTaskFunction( void *pvParameters )
{
    // 任务初始化代码
    // ...
    
    for( ;; )
    {
        // 任务主体代码
        // ...
        
        // 当满足某个条件时，任务删除自身
        if( xConditionMet == pdTRUE )
        {
            // 删除自身
            vTaskDelete( NULL );
        }
        
        vTaskDelay( pdMS_TO_TICKS( 100 ) ); // 延迟100ms
    }
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>安全删除自身的要点</h2>
                
                <h3>资源清理</h3>
                <p>在删除自身之前，任务必须释放它所占用的所有资源，包括：</p>
                <ul>
                    <li>动态分配的内存</li>
                    <li>信号量、互斥量等同步对象</li>
                    <li>文件描述符</li>
                    <li>硬件资源</li>
                </ul>
                
                <div class="warning">
                    <p><strong>警告：</strong>如果任务在删除自身前没有正确释放资源，可能会导致内存泄漏或资源耗尽，影响系统稳定性。</p>
                </div>
                
                <h3>删除时机</h3>
                <p>任务应该在安全的状态下删除自己，避免在临界区或持有互斥量时删除自身。</p>
                
                <div class="code-block">
                    <pre>void vTaskFunction( void *pvParameters )
{
    // 获取互斥量
    if( xSemaphoreTake( xMutex, portMAX_DELAY ) == pdTRUE )
    {
        // 临界区操作
        // ...
        
        // 释放互斥量
        xSemaphoreGive( xMutex );
        
        // 现在可以安全删除自身
        vTaskDelete( NULL );
    }
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>任务删除流程</h2>
                
                <div class="svg-container">
                    <svg width="400" height="300" viewBox="0 0 400 300">
                        <rect x="50" y="30" width="300" height="40" rx="5" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                        <text x="200" y="55" text-anchor="middle" font-family="Arial" font-size="14" fill="#2e7d32">任务正常运行</text>
                        
                        <rect x="50" y="90" width="300" height="40" rx="5" fill="#fff9c4" stroke="#ffb300" stroke-width="2"/>
                        <text x="200" y="115" text-anchor="middle" font-family="Arial" font-size="14" fill="#f57f17">检测删除条件</text>
                        
                        <rect x="50" y="150" width="300" height="40" rx="5" fill="#ffcdd2" stroke="#e57373" stroke-width="2"/>
                        <text x="200" y="175" text-anchor="middle" font-family="Arial" font-size="14" fill="#c62828">释放所有资源</text>
                        
                        <rect x="50" y="210" width="300" height="40" rx="5" fill="#b3e5fc" stroke="#4db6ac" stroke-width="2"/>
                        <text x="200" y="235" text-anchor="middle" font-family="Arial" font-size="14" fill="#00695c">调用vTaskDelete(NULL)</text>
                        
                        <path d="M200 70 L200 90" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                        <path d="M200 130 L200 150" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                        <path d="M200 190 L200 210" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                        
                        <defs>
                            <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4db6ac"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
                
                <ol>
                    <li>任务检测到需要删除自身的条件</li>
                    <li>释放所有动态分配的内存和资源</li>
                    <li>释放持有的所有同步对象（信号量、互斥量等）</li>
                    <li>调用vTaskDelete(NULL)删除自身</li>
                    <li>FreeRTOS内核将任务移至已删除状态并回收任务栈空间</li>
                </ol>
            </div>
            
            <div class="card">
                <h2>常见问题与解决方案</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>问题</th>
                            <th>原因</th>
                            <th>解决方案</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>内存泄漏</td>
                            <td>任务删除前未释放动态分配的内存</td>
                            <td>在vTaskDelete(NULL)前调用free()释放所有内存</td>
                        </tr>
                        <tr>
                            <td>资源死锁</td>
                            <td>任务删除时仍持有互斥量</td>
                            <td>确保在删除前释放所有持有的同步对象</td>
                        </tr>
                        <tr>
                            <td>栈空间未回收</td>
                            <td>FreeRTOS配置问题</td>
                            <td>确保configUSE_TRACE_FACILITY启用，以便内核回收栈空间</td>
                        </tr>
                        <tr>
                            <td>任务句柄无效</td>
                            <td>任务删除后其他任务仍引用其句柄</td>
                            <td>使用任务通知或全局变量通知其他任务</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tip">
                    <p><strong>最佳实践：</strong>在任务函数开始时分配所有需要的资源，在删除自身前统一释放，这样可以确保资源管理的完整性。</p>
                </div>
            </div>
            
            <div class="card">
                <h2>完整示例代码</h2>
                
                <div class="code-block">
                    <pre>#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "queue.h"

// 任务句柄和同步对象
TaskHandle_t xTaskHandle = NULL;
SemaphoreHandle_t xMutex = NULL;
QueueHandle_t xQueue = NULL;

void vExampleTask( void *pvParameters )
{
    // 任务局部变量和资源
    void *pvBuffer = NULL;
    
    // 分配资源
    pvBuffer = pvPortMalloc( 1024 );
    xMutex = xSemaphoreCreateMutex();
    xQueue = xQueueCreate( 5, sizeof( int ) );
    
    if( pvBuffer == NULL || xMutex == NULL || xQueue == NULL )
    {
        // 资源分配失败，直接删除任务
        vTaskDelete( NULL );
    }
    
    for( ;; )
    {
        // 获取互斥量
        if( xSemaphoreTake( xMutex, portMAX_DELAY ) == pdTRUE )
        {
            // 执行任务操作
            // ...
            
            // 检查是否需要删除自身
            if( /* 删除条件 */ )
            {
                // 释放互斥量
                xSemaphoreGive( xMutex );
                
                // 释放所有资源
                if( pvBuffer != NULL )
                {
                    vPortFree( pvBuffer );
                    pvBuffer = NULL;
                }
                
                // 删除同步对象
                vSemaphoreDelete( xMutex );
                vQueueDelete( xQueue );
                
                // 安全删除自身
                vTaskDelete( NULL );
            }
            else
            {
                // 释放互斥量，继续执行
                xSemaphoreGive( xMutex );
            }
        }
        
        vTaskDelay( pdMS_TO_TICKS( 10 ) ); // 延迟10ms
    }
}

// 创建任务的函数
void vCreateExampleTask( void )
{
    xTaskCreate(
        vExampleTask,       // 任务函数
        "ExampleTask",      // 任务名称
        1000,               // 栈深度
        NULL,               // 任务参数
        tskIDLE_PRIORITY + 1, // 任务优先级
        &xTaskHandle        // 任务句柄
    );
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>FreeRTOS任务状态转换</h2>
                
                <div class="svg-container">
                    <svg width="400" height="300" viewBox="0 0 400 300">
                        <rect x="50" y="50" width="100" height="60" rx="10" fill="#bbdefb" stroke="#2196f3" stroke-width="2"/>
                        <text x="100" y="80" text-anchor="middle" font-family="Arial" font-size="12" fill="#0d47a1">就绪</text>
                        
                        <rect x="200" y="50" width="100" height="60" rx="10" fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                        <text x="250" y="80" text-anchor="middle" font-family="Arial" font-size="12" fill="#1b5e20">运行</text>
                        
                        <rect x="50" y="150" width="100" height="60" rx="10" fill="#fff9c4" stroke="#ffeb3b" stroke-width="2"/>
                        <text x="100" y="180" text-anchor="middle" font-family="Arial" font-size="12" fill="#f57f17">阻塞</text>
                        
                        <rect x="200" y="150" width="100" height="60" rx="10" fill="#ffcdd2" stroke="#f44336" stroke-width="2"/>
                        <text x="250" y="180" text-anchor="middle" font-family="Arial" font-size="12" fill="#b71c1c">挂起</text>
                        
                        <rect x="125" y="230" width="100" height="60" rx="10" fill="#e0e0e0" stroke="#9e9e9e" stroke-width="2"/>
                        <text x="175" y="260" text-anchor="middle" font-family="Arial" font-size="12" fill="#424242">删除</text>
                        
                        <path d="M100 110 L100 150" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        <path d="M150 80 L200 80" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        <path d="M250 110 L250 150" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        <path d="M200 180 L150 180" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        <path d="M150 210 L150 230" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        <path d="M175 110 L175 230" fill="none" stroke="#4db6ac" stroke-width="2" marker-end="url(#arrowhead3)"/>
                        
                        <defs>
                            <marker id="arrowhead3" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4db6ac"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
                
                <p>任务删除是FreeRTOS任务状态转换的最终状态。一旦任务被删除，其栈空间和TCB（任务控制块）将被FreeRTOS内存管理系统回收。</p>
            </div>
        </div>
        
        <div class="footer">
            蓝海资料掘金营
        </div>
    </div>
</body>
</html>