<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理50问 - 任务状态查询</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 50%, #f8bbd0 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(45deg, #42a5f5, #ab47bc);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #ff9800;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #42a5f5;
        }
        
        h2 {
            color: #1565c0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #bbdefb;
        }
        
        h3 {
            color: #ab47bc;
            margin: 15px 0 10px;
        }
        
        p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th {
            background: #42a5f5;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:nth-child(even) {
            background: #f5f5f5;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .code-block {
            background: #263238;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .diagram-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .diagram {
            max-width: 100%;
            height: auto;
        }
        
        .note {
            background: #fff9c4;
            border-left: 5px solid #ffd600;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .tip {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        footer {
            background: linear-gradient(45deg, #1565c0, #6a1b9a);
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            margin-top: 30px;
        }
        
        .example-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .highlight {
            background: #fff9c4;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS任务管理50问</h1>
            <div class="subtitle">第13问：任务状态查询 - eTaskGetState函数的使用</div>
        </header>
        
        <div class="content">
            <div class="section">
                <h2>1. eTaskGetState函数概述</h2>
                <p><span class="highlight">eTaskGetState</span> 是FreeRTOS提供的一个API函数，用于查询指定任务当前的状态。该函数返回一个枚举类型的值，表示任务可能处于的各种状态。</p>
                
                <div class="tip">
                    <strong>提示：</strong> 使用eTaskGetState函数可以帮助开发者监控任务执行情况，诊断系统问题，以及实现基于任务状态的调度策略。
                </div>
                
                <h3>函数原型</h3>
                <div class="code-block">
                    <pre>eTaskState eTaskGetState( TaskHandle_t xTask );</pre>
                </div>
                
                <h3>参数说明</h3>
                <ul>
                    <li><span class="highlight">xTask</span>：要查询状态的任务句柄。如果传入NULL，则查询调用任务自身的状态。</li>
                </ul>
                
                <h3>返回值</h3>
                <p>返回一个eTaskState枚举值，表示任务的状态：</p>
                <ul>
                    <li><span class="highlight">eRunning</span>：任务正在运行</li>
                    <li><span class="highlight">eReady</span>：任务就绪，等待调度</li>
                    <li><span class="highlight">eBlocked</span>：任务阻塞，等待事件</li>
                    <li><span class="highlight">eSuspended</span>：任务挂起</li>
                    <li><span class="highlight">eDeleted</span>：任务已删除</li>
                    <li><span class="highlight">eInvalid</span>：任务句柄无效</li>
                </ul>
            </div>
            
            <div class="section">
                <h2>2. 任务状态详解</h2>
                <p>在FreeRTOS中，任务可以处于多种状态，了解这些状态对于系统调试和优化至关重要。</p>
                
                <div class="diagram-container">
                    <svg class="diagram" width="600" height="400" viewBox="0 0 600 400">
                        <!-- 任务状态转换图 -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#42a5f5"/>
                            </marker>
                        </defs>
                        
                        <!-- 状态节点 -->
                        <rect x="50" y="50" width="120" height="60" rx="10" ry="10" 
                              fill="#bbdefb" stroke="#42a5f5" stroke-width="2"/>
                        <text x="110" y="85" text-anchor="middle" fill="#0d47a1" font-weight="bold">eReady</text>
                        
                        <rect x="250" y="50" width="120" height="60" rx="10" ry="10" 
                              fill="#c8e6c9" stroke="#4caf50" stroke-width="2"/>
                        <text x="310" y="85" text-anchor="middle" fill="#1b5e20" font-weight="bold">eRunning</text>
                        
                        <rect x="450" y="50" width="120" height="60" rx="10" ry="10" 
                              fill="#ffecb3" stroke="#ffc107" stroke-width="2"/>
                        <text x="510" y="85" text-anchor="middle" fill="#ff6f00" font-weight="bold">eBlocked</text>
                        
                        <rect x="150" y="200" width="120" height="60" rx="10" ry="10" 
                              fill="#f8bbd0" stroke="#e91e63" stroke-width="2"/>
                        <text x="210" y="235" text-anchor="middle" fill="#880e4f" font-weight="bold">eSuspended</text>
                        
                        <rect x="350" y="200" width="120" height="60" rx="10" ry="10" 
                              fill="#bdbdbd" stroke="#757575" stroke-width="2"/>
                        <text x="410" y="235" text-anchor="middle" fill="#212121" font-weight="bold">eDeleted</text>
                        
                        <!-- 状态转换箭头 -->
                        <line x1="170" y1="50" x2="250" y2="50" stroke="#42a5f5" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="210" y="40" text-anchor="middle" fill="#42a5f5">调度器选择</text>
                        
                        <line x1="310" y1="110" x2="310" y2="200" stroke="#4caf50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="320" y="155" text-anchor="start" fill="#4caf50">vTaskSuspend</text>
                        
                        <line x1="370" y1="110" x2="450" y2="110" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="410" y="100" text-anchor="middle" fill="#ffc107">等待事件</text>
                        
                        <line x1="510" y1="110" x2="510" y2="200" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="520" y="155" text-anchor="start" fill="#ffc107">vTaskSuspend</text>
                        
                        <line x1="450" y1="50" x2="370" y2="50" stroke="#42a5f5" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="410" y="40" text-anchor="middle" fill="#42a5f5">事件发生</text>
                        
                        <line x1="210" y1="260" x2="210" y2="320" stroke="#e91e63" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="220" y="290" text-anchor="start" fill="#e91e63">vTaskDelete</text>
                        
                        <line x1="270" y1="200" x2="350" y2="200" stroke="#757575" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="310" y="190" text-anchor="middle" fill="#757575">vTaskDelete</text>
                    </svg>
                </div>
                
                <h3>任务状态说明表</h3>
                <table>
                    <thead>
                        <tr>
                            <th>状态</th>
                            <th>描述</th>
                            <th>常见场景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="highlight">eRunning</span></td>
                            <td>任务当前正在处理器上执行</td>
                            <td>只有一个任务在任何时刻处于此状态</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">eReady</span></td>
                            <td>任务已准备就绪，等待调度器分配处理器时间</td>
                            <td>任务在就绪列表中等待执行</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">eBlocked</span></td>
                            <td>任务正在等待某个事件（如信号量、队列、延时等）</td>
                            <td>调用vTaskDelay、等待队列或信号量</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">eSuspended</span></td>
                            <td>任务被显式挂起，不会参与调度</td>
                            <td>调用vTaskSuspend函数</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">eDeleted</span></td>
                            <td>任务已被删除，但内存尚未释放</td>
                            <td>调用vTaskDelete函数后</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">eInvalid</span></td>
                            <td>任务句柄无效或任务不存在</td>
                            <td>传入无效的任务句柄</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>3. eTaskGetState使用示例</h2>
                <p>以下是一个完整的使用eTaskGetState函数的示例，展示了如何查询任务状态并根据状态执行不同的操作。</p>
                
                <div class="example-box">
                    <h3>示例代码：监控任务状态</h3>
                    <div class="code-block">
                        <pre>#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"

// 任务句柄声明
TaskHandle_t xTask1Handle = NULL;
TaskHandle_t xTask2Handle = NULL;

// 任务1：执行一些工作
void vTask1Function( void *pvParameters )
{
    for( ;; )
    {
        // 模拟任务工作
        vTaskDelay( pdMS_TO_TICKS( 1000 ) );
        
        // 检查任务2的状态
        eTaskState eState = eTaskGetState( xTask2Handle );
        
        switch( eState )
        {
            case eRunning:
                // 任务2正在运行
                break;
                
            case eReady:
                // 任务2已就绪
                break;
                
            case eBlocked:
                // 任务2阻塞中
                break;
                
            case eSuspended:
                // 任务2被挂起，尝试恢复它
                vTaskResume( xTask2Handle );
                break;
                
            case eDeleted:
                // 任务2已被删除
                break;
                
            case eInvalid:
                // 无效的任务句柄
                break;
        }
    }
}

// 任务2：被监控的任务
void vTask2Function( void *pvParameters )
{
    for( ;; )
    {
        // 任务2的工作代码
        vTaskDelay( pdMS_TO_TICKS( 2000 ) );
    }
}

// 创建任务的函数
void vCreateTasks( void )
{
    // 创建任务1
    xTaskCreate( vTask1Function,   // 任务函数
                 "Task1",          // 任务名称
                 1024,             // 堆栈大小
                 NULL,             // 参数
                 2,                // 优先级
                 &xTask1Handle );  // 任务句柄
                 
    // 创建任务2
    xTaskCreate( vTask2Function,   // 任务函数
                 "Task2",          // 任务名称
                 1024,             // 堆栈大小
                 NULL,             // 参数
                 1,                // 优先级
                 &xTask2Handle );  // 任务句柄
}

int main( void )
{
    // 初始化硬件和FreeRTOS
    // ...
    
    // 创建任务
    vCreateTasks();
    
    // 启动调度器
    vTaskStartScheduler();
    
    // 不会执行到这里
    for( ;; );
}</pre>
                    </div>
                </div>
                
                <div class="note">
                    <strong>注意：</strong> 在多任务环境中使用eTaskGetState时，需要注意任务状态可能在查询瞬间发生变化。因此，查询结果只代表调用函数那一时刻的任务状态。
                </div>
            </div>
            
            <div class="section">
                <h2>4. 使用场景与最佳实践</h2>
                
                <h3>典型使用场景</h3>
                <ul>
                    <li><span class="highlight">系统监控</span>：监控关键任务的状态，确保系统正常运行</li>
                    <li><span class="highlight">调试诊断</span>：在系统出现问题时，检查任务状态以定位问题</li>
                    <li><span class="highlight">动态调度</span>：根据任务状态实现自定义的调度策略</li>
                    <li><span class="highlight">资源管理</span>：根据任务状态管理共享资源的分配</li>
                </ul>
                
                <h3>最佳实践</h3>
                <ol>
                    <li>在非关键代码路径中使用eTaskGetState，避免影响系统实时性</li>
                    <li>理解返回的状态是瞬间状态，可能在你使用该状态时已经发生变化</li>
                    <li>对于时间敏感的应用，考虑使用其他同步机制而非轮询任务状态</li>
                    <li>合理处理eInvalid状态，确保传入有效的任务句柄</li>
                    <li>在调试版本中可以频繁使用，但在发布版本中应谨慎使用以减少开销</li>
                </ol>
                
                <h3>常见问题与解决方案</h3>
                <table>
                    <thead>
                        <tr>
                            <th>问题</th>
                            <th>原因</th>
                            <th>解决方案</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>返回eInvalid状态</td>
                            <td>任务句柄无效或任务已被删除</td>
                            <td>检查任务句柄的初始化和生命周期</td>
                        </tr>
                        <tr>
                            <td>状态判断不准确</td>
                            <td>任务状态在查询后立即发生变化</td>
                            <td>理解状态的瞬时性，或使用其他同步机制</td>
                        </tr>
                        <tr>
                            <td>系统性能下降</td>
                            <td>过于频繁地查询任务状态</td>
                            <td>减少查询频率，或在非关键路径中查询</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>5. 与其他状态查询函数的比较</h2>
                <p>FreeRTOS提供了多个用于查询任务状态的函数，了解它们的区别有助于选择正确的工具。</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>函数</th>
                            <th>功能</th>
                            <th>返回值</th>
                            <th>适用场景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="highlight">eTaskGetState</span></td>
                            <td>查询任务当前状态</td>
                            <td>eTaskState枚举值</td>
                            <td>需要精确知道任务状态的场景</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">uxTaskPriorityGet</span></td>
                            <td>查询任务优先级</td>
                            <td>UBaseType_t数值</td>
                            <td>需要知道任务优先级的场景</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">vTaskGetInfo</span></td>
                            <td>获取任务的多种信息</td>
                            <td>TaskStatus_t结构体</td>
                            <td>需要全面了解任务状态的调试场景</td>
                        </tr>
                        <tr>
                            <td><span class="highlight">uxTaskGetStackHighWaterMark</span></td>
                            <td>查询任务堆栈使用情况</td>
                            <td>UBaseType_t数值</td>
                            <td>堆栈大小优化和溢出检测</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tip">
                    <strong>提示：</strong> 在FreeRTOS v10.0.0及以上版本中，推荐使用vTaskGetInfo函数，它可以一次性获取任务的多种信息，包括状态、优先级、堆栈使用情况等。
                </div>
            </div>
        </div>
        
        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>