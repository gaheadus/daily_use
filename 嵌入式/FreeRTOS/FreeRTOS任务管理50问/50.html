<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理最佳实践</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }
        
        .header h1 {
            color: #00695c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header p {
            color: #00796b;
            font-size: 1.2rem;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid #4db6ac;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #00796b;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .card h2 svg {
            margin-right: 10px;
        }
        
        .card ul, .card ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .card li {
            margin-bottom: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0f2f1;
        }
        
        th {
            background-color: #4db6ac;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f1f8e9;
        }
        
        tr:hover {
            background-color: #e0f2f1;
        }
        
        pre {
            background: #f5f5f5;
            border-left: 4px solid #4db6ac;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .code-block {
            background: #f9fbe7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e6ee9c;
        }
        
        .code-block h3 {
            color: #827717;
            margin-bottom: 10px;
        }
        
        .architecture {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .architecture h2 {
            text-align: center;
            color: #00796b;
            margin-bottom: 20px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #4db6ac;
            color: #00796b;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .highlight {
            background-color: #fff9c4;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .tip {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .warning {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FreeRTOS任务管理最佳实践</h1>
            <p>经验总结与注意事项</p>
        </div>
        
        <div class="architecture">
            <h2>FreeRTOS任务管理架构概览</h2>
            <svg width="100%" height="300" viewBox="0 0 800 300">
                <rect x="50" y="50" width="150" height="60" rx="10" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                <text x="125" y="85" text-anchor="middle" fill="white" font-weight="bold">任务创建</text>
                
                <rect x="250" y="50" width="150" height="60" rx="10" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                <text x="325" y="85" text-anchor="middle" fill="white" font-weight="bold">任务调度</text>
                
                <rect x="450" y="50" width="150" height="60" rx="10" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                <text x="525" y="85" text-anchor="middle" fill="white" font-weight="bold">任务通信</text>
                
                <rect x="650" y="50" width="150" height="60" rx="10" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                <text x="725" y="85" text-anchor="middle" fill="white" font-weight="bold">任务同步</text>
                
                <rect x="150" y="150" width="150" height="60" rx="10" fill="#80cbc4" stroke="#00796b" stroke-width="2"/>
                <text x="225" y="185" text-anchor="middle" fill="white" font-weight="bold">优先级管理</text>
                
                <rect x="350" y="150" width="150" height="60" rx="10" fill="#80cbc4" stroke="#00796b" stroke-width="2"/>
                <text x="425" y="185" text-anchor="middle" fill="white" font-weight="bold">栈空间管理</text>
                
                <rect x="550" y="150" width="150" height="60" rx="10" fill="#80cbc4" stroke="#00796b" stroke-width="2"/>
                <text x="625" y="185" text-anchor="middle" fill="white" font-weight="bold">资源管理</text>
                
                <rect x="250" y="230" width="300" height="60" rx="10" fill="#26a69a" stroke="#00796b" stroke-width="2"/>
                <text x="400" y="265" text-anchor="middle" fill="white" font-weight="bold" font-size="18">FreeRTOS内核</text>
                
                <!-- 连接线 -->
                <path d="M200 110 L200 140 L225 140 L225 150" stroke="#00796b" stroke-width="2" fill="none"/>
                <path d="M400 110 L400 140 L425 140 L425 150" stroke="#00796b" stroke-width="2" fill="none"/>
                <path d="M600 110 L600 140 L625 140 L625 150" stroke="#00796b" stroke-width="2" fill="none"/>
                
                <path d="M225 210 L225 220 L400 220 L400 230" stroke="#00796b" stroke-width="2" fill="none"/>
                <path d="M425 210 L425 220 L400 220" stroke="#00796b" stroke-width="2" fill="none"/>
                <path d="M625 210 L625 220 L400 220" stroke="#00796b" stroke-width="2" fill="none"/>
            </svg>
        </div>
        
        <div class="content">
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                    任务设计原则
                </h2>
                <ul>
                    <li><span class="highlight">单一职责原则</span>：每个任务应专注于单一功能</li>
                    <li><span class="highlight">合理划分</span>：按功能模块划分任务，避免任务过于复杂</li>
                    <li><span class="highlight">事件驱动</span>：任务应基于事件或消息进行工作，避免忙等待</li>
                    <li><span class="highlight">优先级合理</span>：根据实时性要求合理设置任务优先级</li>
                    <li><span class="highlight">资源预估</span>：合理分配栈空间，考虑最坏情况下的使用</li>
                </ul>
                
                <div class="tip">
                    <strong>提示：</strong> 任务划分应遵循"高内聚，低耦合"原则，提高系统可维护性。
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    任务创建最佳实践
                </h2>
                <ol>
                    <li>使用有意义的任务名称，便于调试</li>
                    <li>合理设置栈大小，避免浪费或溢出</li>
                    <li>为任务分配适当的优先级</li>
                    <li>考虑使用静态内存分配提高确定性</li>
                    <li>在系统启动时创建所有任务，避免运行时动态创建</li>
                </ol>
                
                <div class="code-block">
                    <h3>任务创建示例代码</h3>
                    <pre>
// 任务函数原型
void vTaskFunction( void *pvParameters );

// 任务创建示例
BaseType_t xReturned;
TaskHandle_t xHandle = NULL;

// 创建任务
xReturned = xTaskCreate(
    vTaskFunction,       // 任务函数
    "DemoTask",          // 任务名称
    1024,                // 栈大小（字）
    NULL,                // 任务参数
    tskIDLE_PRIORITY + 2, // 任务优先级
    &xHandle             // 任务句柄
);

if( xReturned != pdPASS ) {
    // 任务创建失败处理
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline>
                    </svg>
                    优先级管理策略
                </h2>
                <table>
                    <thead>
                        <tr>
                            <th>优先级范围</th>
                            <th>适用任务类型</th>
                            <th>注意事项</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>高 (≥ configMAX_PRIORITIES-3)</td>
                            <td>紧急处理、硬实时任务</td>
                            <td>数量应严格控制，避免优先级反转</td>
                        </tr>
                        <tr>
                            <td>中 (5-15)</td>
                            <td>常规功能任务</td>
                            <td>大部分任务应处于此范围</td>
                        </tr>
                        <tr>
                            <td>低 (2-4)</td>
                            <td>后台任务、非实时任务</td>
                            <td>可被高优先级任务抢占</td>
                        </tr>
                        <tr>
                            <td>空闲 (0-1)</td>
                            <td>空闲任务、低功耗任务</td>
                            <td>不应阻塞，确保系统有任务可运行</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="warning">
                    <strong>警告：</strong> 避免过多高优先级任务，否则可能导致低优先级任务"饿死"。
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    栈空间管理
                </h2>
                <ul>
                    <li>使用uxTaskGetStackHighWaterMark()监控栈使用情况</li>
                    <li>为每个任务分配足够的栈空间，考虑函数调用深度</li>
                    <li>注意局部变量和中断嵌套对栈空间的影响</li>
                    <li>定期检查栈溢出，可使用栈填充模式检测</li>
                </ul>
                
                <div class="code-block">
                    <h3>栈使用监控示例</h3>
                    <pre>
void vTaskCheckStackUsage( void *pvParameters ) {
    UBaseType_t uxHighWaterMark;
    
    for( ;; ) {
        // 获取栈高水位线（最小剩余栈空间）
        uxHighWaterMark = uxTaskGetStackHighWaterMark( NULL );
        
        // 如果剩余栈空间小于100字，发出警告
        if( uxHighWaterMark < 100 ) {
            // 栈空间不足处理
        }
        
        vTaskDelay( pdMS_TO_TICKS( 10000 ) ); // 每10秒检查一次
    }
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="7.5,4.21 12,6.81 16.5,4.21"></polyline>
                        <polyline points="7.5,19.79 7.5,14.6 3,12"></polyline>
                        <polyline points="21,12 16.5,14.6 16.5,19.79"></polyline>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    任务通信与同步
                </h2>
                <ul>
                    <li>根据数据量选择队列、信号量或事件标志组</li>
                    <li>避免在中断服务程序中长时间阻塞</li>
                    <li>使用互斥量保护共享资源，注意优先级继承</li>
                    <li>合理设置超时时间，避免永久阻塞</li>
                    <li>考虑使用任务通知进行轻量级通信</li>
                </ul>
                
                <div class="code-block">
                    <h3>队列使用示例</h3>
                    <pre>
// 创建队列
QueueHandle_t xQueue;
xQueue = xQueueCreate( 10, sizeof( uint32_t ) );

// 发送数据到队列
uint32_t ulDataToSend = 100;
xQueueSend( xQueue, &ulDataToSend, portMAX_DELAY );

// 从队列接收数据
uint32_t ulReceivedData;
if( xQueueReceive( xQueue, &ulReceivedData, pdMS_TO_TICKS( 100 ) ) ) {
    // 成功接收到数据
}</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    常见问题与调试
                </h2>
                <table>
                    <thead>
                        <tr>
                            <th>问题现象</th>
                            <th>可能原因</th>
                            <th>解决方法</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>系统卡死</td>
                            <td>栈溢出、死锁、优先级配置不当</td>
                            <td>检查栈使用、使用互斥量、调整优先级</td>
                        </tr>
                        <tr>
                            <td>任务响应慢</td>
                            <td>任务优先级过低、被高优先级任务阻塞</td>
                            <td>提高优先级、优化任务执行时间</td>
                        </tr>
                        <tr>
                            <td>内存不足</td>
                            <td>栈分配过大、内存泄漏</td>
                            <td>优化栈大小、检查动态内存使用</td>
                        </tr>
                        <tr>
                            <td>数据损坏</td>
                            <td>共享资源未保护、竞态条件</td>
                            <td>使用互斥量、信号量保护共享资源</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tip">
                    <strong>调试技巧：</strong> 使用FreeRTOS的跟踪功能（trace）可以可视化任务执行情况，帮助诊断问题。
                </div>
            </div>
        </div>
        
        <div class="architecture">
            <h2>任务状态转换图</h2>
            <svg width="100%" height="250" viewBox="0 0 800 250">
                <!-- 状态框 -->
                <rect x="50" y="50" width="120" height="60" rx="10" fill="#81c784" stroke="#2e7d32" stroke-width="2"/>
                <text x="110" y="85" text-anchor="middle" fill="white" font-weight="bold">运行中</text>
                
                <rect x="220" y="50" width="120" height="60" rx="10" fill="#fff176" stroke="#f9a825" stroke-width="2"/>
                <text x="280" y="85" text-anchor="middle" fill="#5d4037" font-weight="bold">就绪</text>
                
                <rect x="390" y="50" width="120" height="60" rx="10" fill="#ffb74d" stroke="#ef6c00" stroke-width="2"/>
                <text x="450" y="85" text-anchor="middle" fill="white" font-weight="bold">阻塞</text>
                
                <rect x="560" y="50" width="120" height="60" rx="10" fill="#90a4ae" stroke="#37474f" stroke-width="2"/>
                <text x="620" y="85" text-anchor="middle" fill="white" font-weight="bold">挂起</text>
                
                <rect x="330" y="150" width="120" height="60" rx="10" fill="#e57373" stroke="#c62828" stroke-width="2"/>
                <text x="390" y="185" text-anchor="middle" fill="white" font-weight="bold">删除</text>
                
                <!-- 状态转换箭头 -->
                <path d="M170 80 L220 80" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="195" y="75" text-anchor="middle" fill="#2e7d32" font-size="12">被抢占</text>
                
                <path d="M280 80 L340 80" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="310" y="75" text-anchor="middle" fill="#2e7d32" font-size="12">调度</text>
                
                <path d="M450 110 L450 150 L390 150" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="470" y="130" text-anchor="middle" fill="#2e7d32" font-size="12">事件发生</text>
                
                <path d="M390 80 L340 80" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="365" y="75" text-anchor="middle" fill="#2e7d32" font-size="12">等待事件</text>
                
                <path d="M510 80 L560 80" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="535" y="75" text-anchor="middle" fill="#2e7d32" font-size="12">vTaskSuspend</text>
                
                <path d="M560 110 L560 150 L450 150" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="510" y="130" text-anchor="middle" fill="#2e7d32" font-size="12">vTaskResume</text>
                
                <path d="M450 180 L390 180" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                <text x="420" y="175" text-anchor="middle" fill="#2e7d32" font-size="12">vTaskDelete</text>
                
                <!-- 定义箭头标记 -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32"/>
                    </marker>
                </defs>
            </svg>
        </div>
        
        <div class="card">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                性能优化建议
            </h2>
            <ul>
                <li>使用任务通知代替二进制信号量，减少内存使用</li>
                <li>合理使用静态内存分配，提高时间确定性</li>
                <li>优化任务优先级，减少上下文切换开销</li>
                <li>使用直接任务通知进行轻量级同步</li>
                <li>考虑使用协程（Co-routine）减少RAM使用</li>
                <li>启用configUSE_PREEMPTION提高响应性</li>
                <li>合理配置时间片大小，平衡响应性和吞吐量</li>
            </ul>
            
            <div class="code-block">
                <h3>使用任务通知优化性能</h3>
                <pre>
// 传统信号量方式
SemaphoreHandle_t xSemaphore = xSemaphoreCreateBinary();

// 发送信号
xSemaphoreGive( xSemaphore );

// 等待信号
xSemaphoreTake( xSemaphore, portMAX_DELAY );

// 使用任务通知（更高效）
TaskHandle_t xTaskToNotify = xTaskGetCurrentTaskHandle();

// 发送通知
xTaskNotifyGive( xTaskToNotify );

// 等待通知
ulNotificationCount = ulTaskNotifyTake( pdTRUE, portMAX_DELAY );</pre>
            </div>
        </div>
        
        <div class="footer">
            蓝海资料掘金营
        </div>
    </div>
</body>
</html>