<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务挂起机制</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4db6ac;
        }

        h1 {
            color: #00695c;
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #00796b;
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px dashed #80cbc4;
        }

        h3 {
            color: #004d40;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #4db6ac;
        }

        .highlight {
            background-color: #e0f2f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #26a69a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #b2dfdb;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f1f8e9;
        }

        tr:hover {
            background-color: #e0f2f1;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        pre {
            background: #f5f5f5;
            border-left: 4px solid #4db6ac;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 0 8px 8px 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        code {
            background: #e8f5e9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #00695c;
        }

        .svg-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .comparison-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }

        .comparison-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .comparison-card.suspend {
            border-top: 5px solid #ff9800;
        }

        .comparison-card.delay {
            border-top: 5px solid #2196f3;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #00796b;
            font-weight: bold;
            border-top: 2px solid #80cbc4;
        }

        .flow-chart {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .note {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
        }

        .warning {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS任务挂起机制</h1>
            <p>vTaskSuspend函数的作用和使用场景</p>
        </header>

        <section>
            <div class="card">
                <h2>1. 任务挂起机制概述</h2>
                <p>在FreeRTOS中，任务挂起是一种重要的任务管理机制，允许暂时停止某个任务的执行，而不会删除该任务。被挂起的任务不会参与调度，直到有其他任务或中断服务程序将其恢复。</p>
                
                <div class="svg-container">
                    <svg width="600" height="200" viewBox="0 0 600 200">
                        <rect x="50" y="80" width="100" height="40" rx="5" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                        <text x="100" y="105" text-anchor="middle" fill="white" font-weight="bold">就绪状态</text>
                        
                        <rect x="250" y="80" width="100" height="40" rx="5" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="300" y="105" text-anchor="middle" fill="white" font-weight="bold">挂起状态</text>
                        
                        <rect x="450" y="80" width="100" height="40" rx="5" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                        <text x="500" y="105" text-anchor="middle" fill="white" font-weight="bold">恢复执行</text>
                        
                        <path d="M150 100 L240 100" stroke="#00796b" stroke-width="2" marker-end="url(#arrow)"/>
                        <text x="195" y="95" text-anchor="middle" fill="#00796b">vTaskSuspend</text>
                        
                        <path d="M350 100 L440 100" stroke="#00796b" stroke-width="2" marker-end="url(#arrow)"/>
                        <text x="395" y="95" text-anchor="middle" fill="#00796b">vTaskResume</text>
                        
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#00796b"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>

            <div class="card">
                <h2>2. vTaskSuspend函数详解</h2>
                
                <h3>函数原型</h3>
                <pre><code>void vTaskSuspend( TaskHandle_t xTaskToSuspend );</code></pre>
                
                <h3>参数说明</h3>
                <table>
                    <tr>
                        <th>参数</th>
                        <th>类型</th>
                        <th>描述</th>
                    </tr>
                    <tr>
                        <td>xTaskToSuspend</td>
                        <td>TaskHandle_t</td>
                        <td>要挂起的任务的句柄。使用NULL可以挂起当前正在执行的任务</td>
                    </tr>
                </table>
                
                <h3>函数特性</h3>
                <ul>
                    <li>挂起任务不会释放任务占用的内存资源</li>
                    <li>被挂起的任务不会参与FreeRTOS调度器的调度</li>
                    <li>可以挂起任何状态的任务（就绪、阻塞、运行）</li>
                    <li>挂起操作是累积的 - 需要相同次数的恢复操作才能重新激活任务</li>
                </ul>
                
                <div class="note">
                    <strong>注意：</strong>挂起调度器（vTaskSuspendAll）与挂起任务（vTaskSuspend）是不同的概念。挂起调度器会暂停所有任务的调度，而挂起任务只影响特定任务。
                </div>
            </div>

            <div class="card">
                <h2>3. 使用场景分析</h2>
                
                <div class="comparison-table">
                    <div class="comparison-card suspend">
                        <h3>适用场景</h3>
                        <ul>
                            <li><strong>调试和诊断</strong> - 临时隔离问题任务</li>
                            <li><strong>资源管理</strong> - 当资源不可用时暂停相关任务</li>
                            <li><strong>任务同步</strong> - 等待特定事件或条件</li>
                            <li><strong>节能模式</strong> - 在低功耗应用中暂停非关键任务</li>
                            <li><strong>配置更新</strong> - 暂停任务以安全更新配置参数</li>
                        </ul>
                    </div>
                    
                    <div class="comparison-card delay">
                        <h3>不适用场景</h3>
                        <ul>
                            <li><strong>短期等待</strong> - 应使用vTaskDelay或信号量</li>
                            <li><strong>任务终止</strong> - 需要永久停止任务时应删除任务</li>
                            <li><strong>高频率同步</strong> - 应使用更轻量的同步机制</li>
                            <li><strong>实时性要求高</strong> - 挂起/恢复操作有一定开销</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>4. 代码示例</h2>
                
                <h3>示例1：挂起和恢复任务</h3>
                <pre><code>// 任务句柄声明
TaskHandle_t xDisplayTaskHandle = NULL;

// 显示任务
void vDisplayTask(void *pvParameters)
{
    for(;;)
    {
        // 更新显示内容
        updateDisplay();
        
        // 延迟100ms
        vTaskDelay(pdMS_TO_TICKS(100));
    }
}

// 控制任务 - 根据需要挂起/恢复显示任务
void vControlTask(void *pvParameters)
{
    for(;;)
    {
        if(systemInLowPowerMode())
        {
            // 挂起显示任务以节省功耗
            vTaskSuspend(xDisplayTaskHandle);
        }
        else
        {
            // 恢复显示任务
            vTaskResume(xDisplayTaskHandle);
        }
        
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

// 创建任务
xTaskCreate(vDisplayTask, "Display", 1024, NULL, 2, &xDisplayTaskHandle);
xTaskCreate(vControlTask, "Control", 1024, NULL, 3, NULL);</code></pre>
                
                <h3>示例2：挂起自身</h3>
                <pre><code>void vDataProcessingTask(void *pvParameters)
{
    for(;;)
    {
        // 等待数据可用
        if(xSemaphoreTake(xDataReadySemaphore, portMAX_DELAY))
        {
            // 处理数据
            processData();
        }
        else
        {
            // 没有数据可处理，挂起自身直到有新数据
            vTaskSuspend(NULL);
        }
    }
}

// 数据到达时恢复任务
void vDataArrivalISR(void)
{
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    
    // 恢复数据处理任务
    vTaskResumeFromISR(xDataProcessingTaskHandle);
    
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}</code></pre>
            </div>

            <div class="card">
                <h2>5. 任务状态转换图</h2>
                
                <div class="svg-container">
                    <svg width="700" height="400" viewBox="0 0 700 400">
                        <!-- 运行状态 -->
                        <rect x="300" y="50" width="100" height="60" rx="10" fill="#4caf50" stroke="#2e7d32" stroke-width="2"/>
                        <text x="350" y="85" text-anchor="middle" fill="white" font-weight="bold">运行</text>
                        
                        <!-- 就绪状态 -->
                        <rect x="100" y="150" width="100" height="60" rx="10" fill="#2196f3" stroke="#1565c0" stroke-width="2"/>
                        <text x="150" y="185" text-anchor="middle" fill="white" font-weight="bold">就绪</text>
                        
                        <!-- 阻塞状态 -->
                        <rect x="300" y="250" width="100" height="60" rx="10" fill="#ff9800" stroke="#ef6c00" stroke-width="2"/>
                        <text x="350" y="285" text-anchor="middle" fill="white" font-weight="bold">阻塞</text>
                        
                        <!-- 挂起状态 -->
                        <rect x="500" y="150" width="100" height="60" rx="10" fill="#9e9e9e" stroke="#616161" stroke-width="2"/>
                        <text x="550" y="185" text-anchor="middle" fill="white" font-weight="bold">挂起</text>
                        
                        <!-- 状态转换箭头 -->
                        <path d="M350 110 L350 150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="340" y="135" text-anchor="middle" fill="#333" font-size="12">时间片结束</text>
                        
                        <path d="M150 110 L300 110" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="225" y="105" text-anchor="middle" fill="#333" font-size="12">调度器选择</text>
                        
                        <path d="M350 200 L350 250" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="360" y="225" text-anchor="middle" fill="#333" font-size="12">等待事件</text>
                        
                        <path d="M350 310 L350 360 L150 360 L150 210" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="250" y="345" text-anchor="middle" fill="#333" font-size="12">事件发生</text>
                        
                        <path d="M200 180 L280 180" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="240" y="175" text-anchor="middle" fill="#333" font-size="12">vTaskSuspend</text>
                        
                        <path d="M520 180 L600 180 L600 110 L400 110 L400 70" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="500" y="165" text-anchor="middle" fill="#333" font-size="12">vTaskSuspend</text>
                        
                        <path d="M400 150 L500 150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="450" y="145" text-anchor="middle" fill="#333" font-size="12">vTaskResume</text>
                        
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>

            <div class="card">
                <h2>6. 最佳实践和注意事项</h2>
                
                <h3>最佳实践</h3>
                <ul>
                    <li>始终检查任务句柄的有效性 before 挂起操作</li>
                    <li>在挂起任务前，确保释放其持有的所有临界资源</li>
                    <li>使用任务通知或信号量来协调挂起和恢复操作</li>
                    <li>考虑使用vTaskSuspendAll()进行批量任务管理</li>
                </ul>
                
                <h3>常见陷阱</h3>
                <div class="warning">
                    <strong>警告：</strong>避免在中断服务程序中直接使用vTaskSuspend()，应使用中断安全版本或通过任务通知机制。
                </div>
                
                <table>
                    <tr>
                        <th>问题</th>
                        <th>原因</th>
                        <th>解决方案</th>
                    </tr>
                    <tr>
                        <td>任务无法恢复</td>
                        <td>挂起次数多于恢复次数</td>
                        <td>确保挂起和恢复操作成对出现</td>
                    </tr>
                    <tr>
                        <td>系统死锁</td>
                        <td>挂持了持有互斥锁的任务</td>
                        <td>挂起前释放所有临界资源</td>
                    </tr>
                    <tr>
                        <td>优先级反转</td>
                        <td>高优先级任务被挂起导致低优先级任务运行</td>
                        <td>合理设计任务优先级和挂起策略</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>7. 相关函数对比</h2>
                
                <table>
                    <tr>
                        <th>函数</th>
                        <th>作用</th>
                        <th>适用场景</th>
                        <th>注意事项</th>
                    </tr>
                    <tr>
                        <td><code>vTaskSuspend()</code></td>
                        <td>挂起指定任务</td>
                        <td>长期暂停、调试、资源管理</td>
                        <td>需要配对使用vTaskResume()</td>
                    </tr>
                    <tr>
                        <td><code>vTaskDelay()</code></td>
                        <td>延迟当前任务执行</td>
                        <td>定时操作、周期性任务</td>
                        <td>相对时间延迟</td>
                    </tr>
                    <tr>
                        <td><code>vTaskDelete()</code></td>
                        <td>删除任务</td>
                        <td>任务生命周期结束</td>
                        <td>释放任务占用资源</td>
                    </tr>
                    <tr>
                        <td><code>vTaskSuspendAll()</code></td>
                        <td>挂起所有任务调度</td>
                        <td>系统维护、关键操作</td>
                        <td>影响整个系统调度</td>
                    </tr>
                </table>
            </div>
        </section>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>