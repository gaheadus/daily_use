<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理50问 - 第49问：vTaskEndScheduler函数使用</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4fc3f7 0%, #81c784 50%, #4db6ac 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid #26a69a;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        section {
            margin-bottom: 40px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #4fc3f7;
        }

        h2 {
            color: #00796b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #80cbc4;
        }

        h3 {
            color: #004d40;
            margin: 20px 0 15px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0f2f1;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f1f8e9;
        }

        tr:hover {
            background-color: #e0f2f1;
        }

        .code-block {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .warning {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .tip {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .diagram-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .architecture {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        footer {
            background: linear-gradient(135deg, #00796b 0%, #004d40 100%);
            color: white;
            text-align: center;
            padding: 25px;
            font-size: 1.1em;
            margin-top: 40px;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .nav-button {
            background: #4db6ac;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-button:hover {
            background: #00796b;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .highlight {
            background: linear-gradient(120deg, #e1f5fe 0%, #e1f5fe 100%);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS任务管理50问</h1>
            <div class="subtitle">第49问：任务结束调度器 - vTaskEndScheduler函数使用</div>
        </header>

        <div class="content">
            <section>
                <h2>vTaskEndScheduler函数概述</h2>
                <p><span class="highlight">vTaskEndScheduler()</span>是FreeRTOS中一个特殊且强大的函数，它用于完全停止RTOS内核的调度器。调用此函数后，系统将不再进行任务调度，所有创建的任务将停止执行，系统返回到调用<span class="highlight">vTaskStartScheduler()</span>之前的状态。</p>
                
                <div class="tip">
                    <strong>提示：</strong> vTaskEndScheduler()通常用于以下场景：系统需要从RTOS模式切换回裸机模式、系统调试、或者在某些特殊条件下需要完全停止多任务环境。
                </div>
            </section>

            <section>
                <h2>函数原型与参数</h2>
                <div class="code-block">
                    <pre>void vTaskEndScheduler( void );</pre>
                </div>
                <p>该函数没有参数，也没有返回值。调用后，调度器将停止运行，系统进入非调度状态。</p>
            </section>

            <section>
                <h2>使用场景与限制</h2>
                <table>
                    <thead>
                        <tr>
                            <th>使用场景</th>
                            <th>说明</th>
                            <th>注意事项</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>系统模式切换</td>
                            <td>从RTOS多任务环境切换回单任务裸机环境</td>
                            <td>需要确保所有资源已正确释放</td>
                        </tr>
                        <tr>
                            <td>调试与测试</td>
                            <td>在特定条件下停止系统进行调试</td>
                            <td>中断处理程序可能仍然运行</td>
                        </tr>
                        <tr>
                            <td>系统恢复</td>
                            <td>在严重错误后恢复系统到初始状态</td>
                            <td>需要处理未完成的任务和资源</td>
                        </tr>
                        <tr>
                            <td>动态配置</td>
                            <td>需要动态启用/禁用RTOS功能</td>
                            <td>配置变更期间需保证系统稳定性</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning">
                    <strong>重要限制：</strong>
                    <ul>
                        <li>调用vTaskEndScheduler()后，所有动态创建的任务将不再执行</li>
                        <li>定时器、队列、信号量等RTOS对象可能处于不一致状态</li>
                        <li>中断服务程序可能仍然运行，需要特别处理</li>
                        <li>内存管理需要手动处理，防止内存泄漏</li>
                    </ul>
                </div>
            </section>

            <section>
                <h2>函数执行流程</h2>
                <div class="diagram-container">
                    <svg width="600" height="300" viewBox="0 0 600 300" class="architecture">
                        <!-- 流程图 -->
                        <rect x="50" y="30" width="200" height="40" rx="5" fill="#4fc3f7" stroke="#00796b" stroke-width="2"/>
                        <text x="150" y="55" text-anchor="middle" fill="white" font-weight="bold">调用vTaskEndScheduler()</text>
                        
                        <rect x="50" y="100" width="200" height="40" rx="5" fill="#81c784" stroke="#2e7d32" stroke-width="2"/>
                        <text x="150" y="125" text-anchor="middle" fill="white" font-weight="bold">停止任务调度</text>
                        
                        <rect x="50" y="170" width="200" height="40" rx="5" fill="#ffb74d" stroke="#ef6c00" stroke-width="2"/>
                        <text x="150" y="195" text-anchor="middle" fill="white" font-weight="bold">删除所有任务</text>
                        
                        <rect x="50" y="240" width="200" height="40" rx="5" fill="#e57373" stroke="#c62828" stroke-width="2"/>
                        <text x="150" y="265" text-anchor="middle" fill="white" font-weight="bold">返回main函数</text>
                        
                        <!-- 箭头 -->
                        <path d="M150 70 L150 100" stroke="#00796b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                        <path d="M150 140 L150 170" stroke="#00796b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                        <path d="M150 210 L150 240" stroke="#00796b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                        
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#00796b"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </section>

            <section>
                <h2>代码示例</h2>
                <h3>基本使用示例</h3>
                <div class="code-block">
                    <pre>#include "FreeRTOS.h"
#include "task.h"

void vApplicationIdleHook( void )
{
    // 空闲任务钩子函数
    static int idleCounter = 0;
    idleCounter++;
    
    // 在特定条件下停止调度器
    if (idleCounter > 10000)
    {
        // 执行清理操作
        // ...
        
        // 停止调度器
        vTaskEndScheduler();
    }
}

int main( void )
{
    // 创建任务
    xTaskCreate( vTask1, "Task1", configMINIMAL_STACK_SIZE, NULL, 1, NULL );
    xTaskCreate( vTask2, "Task2", configMINIMAL_STACK_SIZE, NULL, 2, NULL );
    
    // 启动调度器
    vTaskStartScheduler();
    
    // 调度器停止后，程序会回到这里
    // 此时可以执行一些清理操作或进入低功耗模式
    
    for( ;; )
    {
        // 系统现在运行在裸机模式
        // 处理必要的功能
    }
}</pre>
                </div>

                <h3>完整的使用模式</h3>
                <div class="code-block">
                    <pre>// 全局变量，用于控制调度器状态
static BaseType_t xSchedulerRunning = pdFALSE;

void vControlTask( void *pvParameters )
{
    while(1)
    {
        // 检查是否需要停止调度器
        if( /* 停止条件 */ )
        {
            // 执行必要的清理工作
            vCleanupBeforeSchedulerEnd();
            
            // 停止调度器
            vTaskEndScheduler();
        }
        
        vTaskDelay( pdMS_TO_TICKS( 1000 ) );
    }
}

void vCleanupBeforeSchedulerEnd( void )
{
    // 删除所有动态创建的任务
    // 删除所有队列、信号量等内核对象
    // 保存系统状态（如果需要）
    // 关闭外设（根据需要）
}

// 主函数
int main( void )
{
    // 硬件初始化
    prvSetupHardware();
    
    // 创建初始任务
    xTaskCreate( vControlTask, "Ctrl", configMINIMAL_STACK_SIZE, NULL, 3, NULL );
    
    // 标记调度器运行状态
    xSchedulerRunning = pdTRUE;
    
    // 启动调度器
    vTaskStartScheduler();
    
    // 调度器停止后执行到这里
    xSchedulerRunning = pdFALSE;
    
    // 系统现在运行在裸机模式
    while(1)
    {
        // 处理必要的功能
        vProcessEssentialFunctions();
    }
    
    return 0;
}</pre>
                </div>
            </section>

            <section>
                <h2>最佳实践与注意事项</h2>
                <h3>最佳实践</h3>
                <ul>
                    <li><strong>资源清理：</strong>在调用vTaskEndScheduler()之前，确保所有动态创建的任务和内核对象已被正确删除</li>
                    <li><strong>状态保存：</strong>如果需要恢复RTOS环境，保存关键系统状态</li>
                    <li><strong>中断处理：</strong>确保中断服务程序在调度器停止后仍能正常工作，或适当禁用中断</li>
                    <li><strong>内存管理：</strong>检查并处理可能的内存泄漏问题</li>
                </ul>

                <h3>常见错误与避免方法</h3>
                <table>
                    <thead>
                        <tr>
                            <th>错误类型</th>
                            <th>问题描述</th>
                            <th>解决方案</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>资源泄漏</td>
                            <td>未删除任务和内核对象导致内存泄漏</td>
                            <td>在停止调度器前遍历并删除所有动态创建的对象</td>
                        </tr>
                        <tr>
                            <td>状态不一致</td>
                            <td>系统状态在调度器停止后处于不一致状态</td>
                            <td>实现状态保存和恢复机制</td>
                        </tr>
                        <tr>
                            <td>中断冲突</td>
                            <td>中断服务程序访问已删除的RTOS对象</td>
                            <td>在停止调度器前禁用相关中断或修改ISR</td>
                        </tr>
                        <tr>
                            <td>时序问题</td>
                            <td>在错误的时间点停止调度器</td>
                            <td>实现安全的停止条件检查机制</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section>
                <h2>系统架构变化</h2>
                <div class="diagram-container">
                    <svg width="700" height="400" viewBox="0 0 700 400" class="architecture">
                        <!-- 调度器运行时的架构 -->
                        <text x="350" y="30" text-anchor="middle" font-weight="bold" font-size="16">FreeRTOS调度器运行时的系统架构</text>
                        
                        <rect x="50" y="50" width="600" height="150" fill="#e3f2fd" stroke="#90caf9" stroke-width="2" rx="10"/>
                        <text x="350" y="75" text-anchor="middle" font-weight="bold">FreeRTOS内核</text>
                        
                        <!-- 任务 -->
                        <rect x="80" y="100" width="100" height="30" fill="#c8e6c9" stroke="#81c784" stroke-width="2" rx="5"/>
                        <text x="130" y="120" text-anchor="middle" font-size="12">任务1</text>
                        
                        <rect x="200" y="100" width="100" height="30" fill="#c8e6c9" stroke="#81c784" stroke-width="2" rx="5"/>
                        <text x="250" y="120" text-anchor="middle" font-size="12">任务2</text>
                        
                        <rect x="320" y="100" width="100" height="30" fill="#c8e6c9" stroke="#81c784" stroke-width="2" rx="5"/>
                        <text x="370" y="120" text-anchor="middle" font-size="12">任务3</text>
                        
                        <rect x="440" y="100" width="100" height="30" fill="#c8e6c9" stroke="#81c784" stroke-width="2" rx="5"/>
                        <text x="490" y="120" text-anchor="middle" font-size="12">空闲任务</text>
                        
                        <!-- 调度器 -->
                        <rect x="300" y="150" width="100" height="30" fill="#ffccbc" stroke="#ff8a65" stroke-width="2" rx="5"/>
                        <text x="350" y="170" text-anchor="middle" font-size="12">调度器</text>
                        
                        <!-- 调度器停止后的架构 -->
                        <text x="350" y="230" text-anchor="middle" font-weight="bold" font-size="16">调用vTaskEndScheduler()后的系统架构</text>
                        
                        <rect x="50" y="260" width="600" height="120" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="2" rx="10"/>
                        <text x="350" y="285" text-anchor="middle" font-weight="bold">裸机环境</text>
                        
                        <!-- 主循环 -->
                        <rect x="300" y="310" width="100" height="30" fill="#b3e5fc" stroke="#4fc3f7" stroke-width="2" rx="5"/>
                        <text x="350" y="330" text-anchor="middle" font-size="12">主循环</text>
                        
                        <!-- 箭头 -->
                        <path d="M350 200 L350 230" stroke="#00796b" stroke-width="2" fill="none" marker-end="url(#arrowhead2)"/>
                        
                        <defs>
                            <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#00796b"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </section>

            <section>
                <h2>总结</h2>
                <p><span class="highlight">vTaskEndScheduler()</span>是FreeRTOS中一个强大但需要谨慎使用的函数。它允许系统从多任务环境切换回单任务环境，但在使用时必须注意：</p>
                <ol>
                    <li><strong>资源管理：</strong>确保所有动态创建的资源被正确释放</li>
                    <li><strong>状态一致性：</strong>保持系统状态的一致性，避免数据损坏</li>
                    <li><strong>中断处理：</strong>正确处理中断服务程序，防止访问已释放的资源</li>
                    <li><strong>时序控制：</strong>在安全的时机调用该函数，避免竞态条件</li>
                </ol>
                <p>正确使用vTaskEndScheduler()可以为嵌入式系统提供更大的灵活性和控制能力，但不当使用可能导致系统不稳定或资源泄漏。</p>
            </section>

            <div class="nav-buttons">
                <button class="nav-button" onclick="location.href='question48.html'">上一问：任务挂起调度器</button>
                <button class="nav-button" onclick="location.href='question50.html'">下一问：任务管理总结</button>
            </div>
        </div>

        <footer>
            蓝海资料掘金营 © 2023 - FreeRTOS专家课程
        </footer>
    </div>
</body>
</html>