<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务通知机制</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border: 2px solid #4db6ac;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px dashed #4db6ac;
        }

        h1 {
            color: #00695c;
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #00796b;
            font-size: 1.8rem;
            margin: 25px 0 15px;
            padding-left: 10px;
            border-left: 5px solid #4db6ac;
        }

        h3 {
            color: #00897b;
            font-size: 1.4rem;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .highlight {
            background-color: #e0f2f1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #26a69a;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #b2dfdb;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #e0f2f1;
        }

        tr:hover {
            background-color: #b2dfdb;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }

        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #26a69a;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        .svg-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }

        .comparison-item {
            flex: 1;
            min-width: 300px;
            background-color: #e0f2f1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .comparison-item h3 {
            color: #00796b;
            text-align: center;
            margin-bottom: 15px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #4db6ac;
            color: #00695c;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .note {
            background-color: #fff9c4;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd600;
            margin: 15px 0;
        }

        .example-box {
            background-color: #f3e5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ab47bc;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS任务通知机制</h1>
            <p>任务通知的基本概念和使用</p>
        </header>

        <section>
            <h2>一、任务通知概述</h2>
            <p>任务通知是FreeRTOS提供的一种轻量级通信机制，允许任务之间、中断服务程序与任务之间进行快速的数据传递和同步。与队列、信号量等传统通信机制相比，任务通知具有更高的效率和更低的内存开销。</p>
            
            <div class="highlight">
                <p><strong>核心特点：</strong></p>
                <ul>
                    <li>每个任务都有一个32位的通知值</li>
                    <li>可以直接向任务发送通知，无需创建额外的通信对象</li>
                    <li>支持多种通知方式：设置位、递增计数器、直接更新值等</li>
                    <li>可以替代二值信号量、计数信号量、事件组等多种通信机制</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>二、任务通知的优势</h2>
            
            <div class="comparison">
                <div class="comparison-item">
                    <h3>传统通信机制</h3>
                    <ul>
                        <li>需要创建队列、信号量等对象</li>
                        <li>内存开销较大</li>
                        <li>API调用相对复杂</li>
                        <li>性能相对较低</li>
                    </ul>
                </div>
                
                <div class="comparison-item">
                    <h3>任务通知</h3>
                    <ul>
                        <li>无需创建额外对象</li>
                        <li>内存开销极小</li>
                        <li>API简单直观</li>
                        <li>性能极高（快45%）</li>
                    </ul>
                </div>
            </div>
            
            <div class="svg-container">
                <svg width="600" height="200" viewBox="0 0 600 200">
                    <rect x="50" y="50" width="200" height="100" fill="#4db6ac" opacity="0.7" rx="10"/>
                    <text x="150" y="110" text-anchor="middle" fill="white" font-size="16" font-weight="bold">任务A</text>
                    <rect x="350" y="50" width="200" height="100" fill="#26a69a" opacity="0.7" rx="10"/>
                    <text x="450" y="110" text-anchor="middle" fill="white" font-size="16" font-weight="bold">任务B</text>
                    <path d="M250 100 L350 100" stroke="#ff9800" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="300" y="90" text-anchor="middle" fill="#ff9800" font-size="14">任务通知</text>
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#ff9800"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>

        <section>
            <h2>三、任务通知API函数</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>函数</th>
                        <th>描述</th>
                        <th>使用场景</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>xTaskNotifyGive()</code></td>
                        <td>向任务发送通知，通知值递增</td>
                        <td>替代计数信号量</td>
                    </tr>
                    <tr>
                        <td><code>ulTaskNotifyTake()</code></td>
                        <td>等待通知，可清零或递减通知值</td>
                        <td>替代信号量接收</td>
                    </tr>
                    <tr>
                        <td><code>xTaskNotify()</code></td>
                        <td>向任务发送通知，可指定操作</td>
                        <td>通用通知发送</td>
                    </tr>
                    <tr>
                        <td><code>xTaskNotifyWait()</code></td>
                        <td>等待通知，可指定位清除</td>
                        <td>通用通知接收</td>
                    </tr>
                    <tr>
                        <td><code>xTaskNotifyFromISR()</code></td>
                        <td>从中断发送通知</td>
                        <td>中断服务程序中使用</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>四、任务通知的使用模式</h2>
            
            <h3>1. 替代二值信号量</h3>
            <div class="example-box">
                <p><strong>发送端（生产者）：</strong></p>
                <pre><code>// 发送通知
xTaskNotifyGive(xTaskHandle);</code></pre>
                
                <p><strong>接收端（消费者）：</strong></p>
                <pre><code>// 等待通知
ulTaskNotifyTake(pdTRUE, portMAX_DELAY);</code></pre>
            </div>
            
            <h3>2. 替代事件组</h3>
            <div class="example-box">
                <p><strong>设置事件位：</strong></p>
                <pre><code>// 设置指定事件位
uint32_t ulBitsToSet = 0x01; // 设置位0
xTaskNotify(xTaskHandle, ulBitsToSet, eSetBits);</code></pre>
                
                <p><strong>等待事件位：</strong></p>
                <pre><code>// 等待指定事件位
uint32_t ulBitsToWaitFor = 0x03; // 等待位0和位1
uint32_t ulNotificationValue;
xTaskNotifyWait(0, 0, &ulNotificationValue, portMAX_DELAY);

if ((ulNotificationValue & ulBitsToWaitFor) == ulBitsToWaitFor) {
    // 事件已发生
}</code></pre>
            </div>
            
            <h3>3. 直接传递数据</h3>
            <div class="example-box">
                <p><strong>发送数据：</strong></p>
                <pre><code>// 直接更新通知值
uint32_t ulData = 0x12345678;
xTaskNotify(xTaskHandle, ulData, eSetValueWithOverwrite);</code></pre>
                
                <p><strong>接收数据：</strong></p>
                <pre><code>// 获取通知值
uint32_t ulReceivedData;
xTaskNotifyWait(0, 0, &ulReceivedData, portMAX_DELAY);</code></pre>
            </div>
        </section>

        <section>
            <h2>五、任务通知状态机</h2>
            
            <div class="svg-container">
                <svg width="700" height="400" viewBox="0 0 700 400">
                    <!-- 状态机图 -->
                    <rect x="50" y="50" width="150" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5"/>
                    <text x="125" y="85" text-anchor="middle" fill="#1976d2" font-size="14" font-weight="bold">等待通知</text>
                    
                    <rect x="300" y="50" width="150" height="60" fill="#e8f5e8" stroke="#388e3c" stroke-width="2" rx="5"/>
                    <text x="375" y="85" text-anchor="middle" fill="#388e3c" font-size="14" font-weight="bold">通知到达</text>
                    
                    <rect x="550" y="50" width="150" height="60" fill="#fff3e0" stroke="#f57c00" stroke-width="2" rx="5"/>
                    <text x="625" y="85" text-anchor="middle" fill="#f57c00" font-size="14" font-weight="bold">处理通知</text>
                    
                    <rect x="300" y="200" width="150" height="60" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="5"/>
                    <text x="375" y="235" text-anchor="middle" fill="#c2185b" font-size="14" font-weight="bold">通知超时</text>
                    
                    <!-- 箭头 -->
                    <path d="M200 80 L300 80" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                    <text x="250" y="75" text-anchor="middle" fill="#666" font-size="12">xTaskNotifyGive</text>
                    
                    <path d="M450 80 L550 80" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                    <text x="500" y="75" text-anchor="middle" fill="#666" font-size="12">ulTaskNotifyTake</text>
                    
                    <path d="M625 110 L625 200 L450 200" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                    <text x="535" y="155" text-anchor="middle" fill="#666" font-size="12">处理完成</text>
                    
                    <path d="M375 260 L375 320 L200 320 L200 140" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                    <text x="285" y="290" text-anchor="middle" fill="#666" font-size="12">重新等待</text>
                    
                    <path d="M200 110 L200 200 L300 200" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
                    <text x="250" y="155" text-anchor="middle" fill="#666" font-size="12">超时发生</text>
                    
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>

        <section>
            <h2>六、任务通知的配置</h2>
            
            <p>在FreeRTOSConfig.h中配置任务通知相关参数：</p>
            
            <pre><code>/* 启用任务通知功能 */
#define configUSE_TASK_NOTIFICATIONS 1

/* 任务通知队列长度（如使用） */
#define configTASK_NOTIFICATION_ARRAY_ENTRIES 1

/* 任务通知数据类型 */
typedef uint32_t TaskNotification_t;</code></pre>
            
            <div class="note">
                <p><strong>注意：</strong>任务通知功能在FreeRTOS V8.2.0及更高版本中默认启用。在旧版本中可能需要手动启用。</p>
            </div>
        </section>

        <section>
            <h2>七、完整示例代码</h2>
            
            <div class="example-box">
                <p><strong>使用任务通知实现生产者-消费者模式：</strong></p>
                
                <pre><code>// 生产者任务
void vProducerTask(void *pvParameters) {
    TickType_t xLastWakeTime = xTaskGetTickCount();
    
    for (;;) {
        // 模拟生产数据
        vTaskDelayUntil(&xLastWakeTime, pdMS_TO_TICKS(1000));
        
        // 发送通知给消费者
        xTaskNotifyGive(xConsumerTaskHandle);
        
        printf("生产者：发送通知\n");
    }
}

// 消费者任务
void vConsumerTask(void *pvParameters) {
    for (;;) {
        // 等待生产者通知
        ulTaskNotifyTake(pdTRUE, portMAX_DELAY);
        
        // 处理数据
        printf("消费者：收到通知，处理数据\n");
        
        // 模拟数据处理时间
        vTaskDelay(pdMS_TO_TICKS(100));
    }
}

// 创建任务
xTaskCreate(vProducerTask, "Producer", 1024, NULL, 2, &xProducerTaskHandle);
xTaskCreate(vConsumerTask, "Consumer", 1024, NULL, 1, &xConsumerTaskHandle);</code></pre>
            </div>
        </section>

        <section>
            <h2>八、任务通知的限制</h2>
            
            <ul>
                <li>每个任务只能有一个通知值</li>
                <li>通知值只能被一个任务等待（单接收者）</li>
                <li>不支持广播通知（一对多通信）</li>
                <li>通知值会被新通知覆盖（除非使用递增模式）</li>
                <li>在复杂通信场景中可能不如队列灵活</li>
            </ul>
            
            <div class="note">
                <p><strong>使用建议：</strong>在简单的任务间同步和数据传递场景中优先使用任务通知，在复杂的多对多通信场景中使用队列或事件组。</p>
            </div>
        </section>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>