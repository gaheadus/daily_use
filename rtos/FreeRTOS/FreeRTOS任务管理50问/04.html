<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务管理50问 - 任务删除操作</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f9fbe7 50%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4db6ac;
        }

        .header h1 {
            color: #00695c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            color: #00796b;
            font-size: 1.8rem;
            font-weight: normal;
        }

        .content-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        h3 {
            color: #004d40;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #80cbc4;
            font-size: 1.5rem;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin-left: 25px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #b2dfdb;
        }

        th {
            background-color: #4db6ac;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #e0f2f1;
        }

        tr:hover {
            background-color: #b2dfdb;
        }

        .code-block {
            background-color: #f5f5f5;
            border-left: 4px solid #00796b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .warning-box {
            background-color: #fff8e1;
            border-left: 4px solid #ffa000;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .tip-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .svg-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #4db6ac;
            color: #00796b;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .highlight {
            background-color: #e0f2f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: #00695c;
        }

        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title svg {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FreeRTOS任务管理50问</h1>
            <h2>4、任务删除操作：vTaskDelete函数使用方法和注意事项</h2>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="#00796B"/>
                </svg>
                <h3>vTaskDelete函数概述</h3>
            </div>
            <p><span class="highlight">vTaskDelete</span> 是FreeRTOS中用于删除任务的核心函数。当一个任务完成其工作或不再需要时，可以使用此函数将其从系统中移除，释放其占用的资源。</p>
            <p>函数原型：</p>
            <div class="code-block">
                <pre>void vTaskDelete( TaskHandle_t xTaskToDelete );</pre>
            </div>
            <p>参数说明：</p>
            <ul>
                <li><span class="highlight">xTaskToDelete</span>：要删除的任务句柄。如果传入<span class="highlight">NULL</span>，则删除当前正在执行的任务自身。</li>
            </ul>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z" fill="#00796B"/>
                    <path d="M11 16H13V18H11V16ZM11 7H13V14H11V7Z" fill="#00796B"/>
                </svg>
                <h3>vTaskDelete使用示例</h3>
            </div>
            <p>以下示例展示了如何使用vTaskDelete函数：</p>
            <div class="code-block">
                <pre>// 示例1：删除其他任务
void vTask1( void * pvParameters )
{
    // 任务1的工作代码
    for( ;; )
    {
        // 执行某些操作...
        
        // 当满足某个条件时，删除任务2
        if( condition )
        {
            vTaskDelete( xTask2Handle );
        }
        
        vTaskDelay( pdMS_TO_TICKS( 1000 ) );
    }
}

// 示例2：任务自我删除
void vTask2( void * pvParameters )
{
    // 任务2的工作代码
    for( int i = 0; i < 10; i++ )
    {
        // 执行某些操作...
        vTaskDelay( pdMS_TO_TICKS( 500 ) );
    }
    
    // 完成任务后自我删除
    vTaskDelete( NULL );
}</pre>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="#00796B"/>
                    <path d="M11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill="#00796B"/>
                </svg>
                <h3>任务删除流程</h3>
            </div>
            <div class="svg-container">
                <svg width="500" height="300" viewBox="0 0 500 300" xmlns="http://www.w3.org/2000/svg">
                    <rect x="50" y="50" width="120" height="60" rx="10" fill="#4db6ac" stroke="#00796b" stroke-width="2"/>
                    <text x="110" y="85" text-anchor="middle" fill="white" font-weight="bold">调用vTaskDelete</text>
                    
                    <path d="M170 80 L230 80" stroke="#00796b" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="230" y="50" width="120" height="60" rx="10" fill="#80cbc4" stroke="#00796b" stroke-width="2"/>
                    <text x="290" y="85" text-anchor="middle" fill="white" font-weight="bold">任务移出就绪/阻塞列表</text>
                    
                    <path d="M350 80 L410 80" stroke="#00796b" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="410" y="50" width="120" height="60" rx="10" fill="#b2dfdb" stroke="#00796b" stroke-width="2"/>
                    <text x="470" y="85" text-anchor="middle" fill="#00695c" font-weight="bold">释放任务栈内存</text>
                    
                    <path d="M350 150 L290 150 L290 200 L170 200 L170 150 L110 150" stroke="#00796b" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
                    
                    <rect x="50" y="120" width="120" height="60" rx="10" fill="#e0f2f1" stroke="#00796b" stroke-width="2"/>
                    <text x="110" y="155" text-anchor="middle" fill="#00695c" font-weight="bold">删除任务TCB</text>
                    
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#00796b"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            <p>任务删除过程包括以下步骤：</p>
            <ol>
                <li>将任务从所有状态列表（就绪、阻塞、挂起、事件列表）中移除</li>
                <li>释放任务栈内存（如果栈是动态分配的）</li>
                <li>释放任务控制块（TCB）内存</li>
                <li>如果删除的是当前运行的任务，则触发任务调度</li>
            </ol>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 11H15V13H12V16H9V13H6V11H9V8H12V11Z" fill="#D32F2F"/>
                </svg>
                <h3>重要注意事项</h3>
            </div>
            <div class="warning-box">
                <p><strong>警告：</strong> 使用vTaskDelete时需要特别注意以下几点：</p>
                <ul>
                    <li>删除任务前必须确保该任务没有持有任何互斥锁、信号量等资源，否则可能导致资源泄漏或死锁</li>
                    <li>删除任务不会自动释放任务动态分配的内存，需要在任务删除前手动释放</li>
                    <li>空闲任务负责清理被删除任务的栈和TCB，确保configUSE_IDLE_HOOK设置为1</li>
                    <li>删除任务可能导致任务通信对象（如队列、信号量）失去使用者，需谨慎处理</li>
                </ul>
            </div>
            
            <h3>资源清理最佳实践</h3>
            <table>
                <tr>
                    <th>资源类型</th>
                    <th>清理方法</th>
                    <th>说明</th>
                </tr>
                <tr>
                    <td>动态内存</td>
                    <td>在vTaskDelete调用前使用free()释放</td>
                    <td>任务删除不会自动释放任务内部动态分配的内存</td>
                </tr>
                <tr>
                    <td>互斥锁</td>
                    <td>在删除前确保已释放所有持有的互斥锁</td>
                    <td>否则会导致其他任务永久阻塞</td>
                </tr>
                <tr>
                    <td>信号量</td>
                    <td>删除前释放所有获取的信号量</td>
                    <td>避免资源计数错误</td>
                </tr>
                <tr>
                    <td>文件句柄</td>
                    <td>在删除前关闭所有打开的文件</td>
                    <td>防止文件描述符泄漏</td>
                </tr>
                <tr>
                    <td>硬件资源</td>
                    <td>在删除前释放占用的硬件资源</td>
                    <td>如GPIO、定时器、外设等</td>
                </tr>
            </table>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21C9 21.55 9.45 22 10 22H14C14.55 22 15 21.55 15 21V20H9V21ZM12 2C8.14 2 5 5.14 5 9C5 11.38 6.19 13.47 8 14.74V17C8 17.55 8.45 18 9 18H15C15.55 18 16 17.55 16 17V14.74C17.81 13.47 19 11.38 19 9C19 5.14 15.86 2 12 2ZM14.85 13.1L14 13.7V16H10V13.7L9.15 13.1C7.8 12.16 7 10.63 7 9C7 6.24 9.24 4 12 4C14.76 4 17 6.24 17 9C17 10.63 16.2 12.16 14.85 13.1Z" fill="#4CAF50"/>
                </svg>
                <h3>任务删除与空闲任务</h3>
            </div>
            <p>在FreeRTOS中，<span class="highlight">空闲任务</span>负责清理被删除任务的资源。当任务被删除后，其栈和TCB内存不会立即释放，而是由空闲任务在下次运行时进行清理。</p>
            <div class="tip-box">
                <p><strong>提示：</strong> 如果需要立即释放被删除任务的资源，可以手动调用<span class="highlight">portCLEAN_UP_TCB()</span>宏，但这通常不是必要的。</p>
            </div>
            
            <h3>配置选项</h3>
            <p>以下FreeRTOS配置选项与任务删除相关：</p>
            <ul>
                <li><span class="highlight">INCLUDE_vTaskDelete</span>：必须设置为1才能使用vTaskDelete函数</li>
                <li><span class="highlight">configUSE_IDLE_HOOK</span>：如果设置为1，可以在空闲任务钩子函数中执行额外的清理工作</li>
                <li><span class="highlight">configIDLE_SHOULD_YIELD</span>：影响空闲任务的行为，可能影响资源清理时机</li>
            </ul>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="#FF9800"/>
                </svg>
                <h3>常见问题与解决方案</h3>
            </div>
            <table>
                <tr>
                    <th>问题</th>
                    <th>原因</th>
                    <th>解决方案</th>
                </tr>
                <tr>
                    <td>系统崩溃或重启</td>
                    <td>删除了持有关键资源的任务</td>
                    <td>在删除任务前确保释放所有资源</td>
                </tr>
                <tr>
                    <td>内存泄漏</td>
                    <td>任务内部动态分配的内存未释放</td>
                    <td>在任务删除前添加资源清理代码</td>
                </tr>
                <tr>
                    <td>编译错误</td>
                    <td>未启用INCLUDE_vTaskDelete宏</td>
                    <td>在FreeRTOSConfig.h中设置INCLUDE_vTaskDelete为1</td>
                </tr>
                <tr>
                    <td>任务删除后系统变慢</td>
                    <td>空闲任务忙于清理大量被删除任务</td>
                    <td>减少频繁的任务创建和删除，考虑使用任务挂起</td>
                </tr>
            </table>
        </div>

        <div class="content-section">
            <div class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 12L11 14L15 10M12 2C13.5913 2 15.1174 2.63214 16.2426 3.75736C17.3679 4.88258 18 6.4087 18 8C18 10.5 16.5 12 12 18C7.5 12 6 10.5 6 8C6 6.4087 6.63214 4.88258 7.75736 3.75736C8.88258 2.63214 10.4087 2 12 2Z" stroke="#00796B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
                <h3>最佳实践总结</h3>
            </div>
            <ol>
                <li>在任务设计阶段就考虑好任务的生命周期和删除时机</li>
                <li>为每个任务实现清晰的资源管理策略，确保在删除前释放所有资源</li>
                <li>考虑使用任务状态机而不是频繁创建和删除任务</li>
                <li>对于需要重复执行的工作，考虑使用任务挂起和恢复而不是删除和重新创建</li>
                <li>在删除任务前，确保没有其他任务在等待该任务的通信对象</li>
                <li>使用任务通知或事件标志来优雅地通知任务自我删除</li>
            </ol>
            
            <div class="tip-box">
                <p><strong>专家建议：</strong> 在复杂的嵌入式系统中，建议实现一个任务管理模块，统一管理任务的创建、删除和资源清理，这样可以减少错误并提高代码的可维护性。</p>
            </div>
        </div>

        <div class="footer">
            蓝海资料掘金营
        </div>
    </div>
</body>
</html>