<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS任务调度器状态</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 50%, #f8bbd0 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #4fc3f7;
        }

        h1 {
            color: #0277bd;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #0288d1;
            margin: 25px 0 15px;
            padding-left: 10px;
            border-left: 5px solid #4fc3f7;
        }

        h3 {
            color: #039be5;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .highlight-box {
            background-color: #e1f5fe;
            border-left: 5px solid #0288d1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        th {
            background-color: #4fc3f7;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        tr:hover {
            background-color: #e1f5fe;
        }

        pre {
            background-color: #f5f5f5;
            border-left: 4px solid #4fc3f7;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }

        code {
            background-color: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        .svg-container {
            text-align: center;
            margin: 25px 0;
        }

        .architecture {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #4fc3f7;
            color: #0277bd;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .note {
            background-color: #fff9c4;
            border-left: 5px solid #ffd600;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }

        .function-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .function-card {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .function-card h4 {
            color: #0277bd;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS任务调度器状态</h1>
            <p>第19问：如何获取调度器的运行状态</p>
        </header>

        <section>
            <h2>调度器状态概述</h2>
            <p>在FreeRTOS中，任务调度器是操作系统的核心组件，负责管理和分配CPU时间给各个任务。了解调度器的运行状态对于系统调试、性能优化和资源管理至关重要。</p>
            
            <div class="highlight-box">
                <p><strong>调度器状态</strong>指的是FreeRTOS内核中任务调度器的当前运行模式，它决定了任务如何被调度和执行。</p>
            </div>
            
            <h3>调度器的三种状态</h3>
            <table>
                <thead>
                    <tr>
                        <th>状态</th>
                        <th>描述</th>
                        <th>API函数</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>运行状态</strong></td>
                        <td>调度器正在运行，任务可以正常切换</td>
                        <td><code>taskSCHEDULER_RUNNING</code></td>
                    </tr>
                    <tr>
                        <td><strong>挂起状态</strong></td>
                        <td>调度器被挂起，任务切换被暂停</td>
                        <td><code>taskSCHEDULER_SUSPENDED</code></td>
                    </tr>
                    <tr>
                        <td><strong>未启动状态</strong></td>
                        <td>调度器尚未启动，通常在调用<code>vTaskStartScheduler()</code>之前</td>
                        <td><code>taskSCHEDULER_NOT_STARTED</code></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>获取调度器状态的API函数</h2>
            <p>FreeRTOS提供了专门的API函数来获取调度器的当前状态：</p>
            
            <div class="function-list">
                <div class="function-card">
                    <h4>vTaskGetSchedulerState()</h4>
                    <p>返回调度器的当前状态，返回值是<code>eTaskState</code>枚举类型。</p>
                </div>
            </div>
            
            <h3>函数原型</h3>
            <pre><code>BaseType_t xTaskGetSchedulerState( void );</code></pre>
            
            <h3>返回值</h3>
            <table>
                <thead>
                    <tr>
                        <th>返回值</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>taskSCHEDULER_RUNNING</code></td>
                        <td>调度器正在运行</td>
                    </tr>
                    <tr>
                        <td><code>taskSCHEDULER_SUSPENDED</code></td>
                        <td>调度器被挂起</td>
                    </tr>
                    <tr>
                        <td><code>taskSCHEDULER_NOT_STARTED</code></td>
                        <td>调度器尚未启动</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>使用示例</h2>
            <p>以下代码展示了如何获取和使用调度器状态：</p>
            
            <pre><code>#include "FreeRTOS.h"
#include "task.h"

void vCheckSchedulerState( void )
{
    BaseType_t xSchedulerState;
    
    // 获取调度器状态
    xSchedulerState = xTaskGetSchedulerState();
    
    switch( xSchedulerState )
    {
        case taskSCHEDULER_RUNNING:
            // 调度器正在运行，可以安全执行任务切换相关操作
            printf("调度器正在运行\n");
            break;
            
        case taskSCHEDULER_SUSPENDED:
            // 调度器被挂起，不能执行某些操作
            printf("调度器被挂起\n");
            break;
            
        case taskSCHEDULER_NOT_STARTED:
            // 调度器尚未启动
            printf("调度器未启动\n");
            break;
            
        default:
            // 未知状态
            break;
    }
}</code></pre>
        </section>

        <section>
            <h2>调度器状态转换</h2>
            <div class="svg-container">
                <svg width="600" height="300" viewBox="0 0 600 300">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#0277bd"/>
                        </marker>
                    </defs>
                    
                    <rect x="50" y="50" width="150" height="60" rx="10" ry="10" 
                          fill="#e1f5fe" stroke="#0277bd" stroke-width="2"/>
                    <text x="125" y="85" text-anchor="middle" fill="#0277bd" font-weight="bold">未启动</text>
                    
                    <rect x="250" y="50" width="150" height="60" rx="10" ry="10" 
                          fill="#c8e6c9" stroke="#388e3c" stroke-width="2"/>
                    <text x="325" y="85" text-anchor="middle" fill="#388e3c" font-weight="bold">运行中</text>
                    
                    <rect x="450" y="50" width="150" height="60" rx="10" ry="10" 
                          fill="#ffecb3" stroke="#ffa000" stroke-width="2"/>
                    <text x="525" y="85" text-anchor="middle" fill="#ffa000" font-weight="bold">挂起</text>
                    
                    <!-- 转换箭头 -->
                    <path d="M 200 80 L 250 80" stroke="#0277bd" stroke-width="2" 
                          marker-end="url(#arrowhead)"/>
                    <text x="225" y="75" text-anchor="middle" fill="#0277bd">vTaskStartScheduler()</text>
                    
                    <path d="M 400 80 L 450 80" stroke="#0277bd" stroke-width="2" 
                          marker-end="url(#arrowhead)"/>
                    <text x="425" y="75" text-anchor="middle" fill="#0277bd">vTaskSuspendAll()</text>
                    
                    <path d="M 500 110 L 500 160 L 400 160 L 400 110" stroke="#0277bd" 
                          stroke-width="2" marker-end="url(#arrowhead)" fill="none"/>
                    <text x="450" y="145" text-anchor="middle" fill="#0277bd">xTaskResumeAll()</text>
                </svg>
            </div>
            
            <h3>状态转换说明</h3>
            <ul>
                <li><strong>未启动 → 运行中</strong>：通过调用<code>vTaskStartScheduler()</code>函数启动调度器</li>
                <li><strong>运行中 → 挂起</strong>：通过调用<code>vTaskSuspendAll()</code>函数挂起调度器</li>
                <li><strong>挂起 → 运行中</strong>：通过调用<code>xTaskResumeAll()</code>函数恢复调度器运行</li>
            </ul>
        </section>

        <section>
            <h2>应用场景</h2>
            <div class="function-list">
                <div class="function-card">
                    <h4>调试和诊断</h4>
                    <p>在调试复杂系统时，了解调度器状态有助于定位问题。</p>
                </div>
                <div class="function-card">
                    <h4>临界区保护</h4>
                    <p>在需要禁用调度的代码段前后检查调度器状态。</p>
                </div>
                <div class="function-card">
                    <h4>系统初始化</h4>
                    <p>在系统启动阶段，确保关键初始化在调度器启动前完成。</p>
                </div>
            </div>
        </section>

        <section>
            <h2>注意事项</h2>
            <div class="note">
                <p><strong>重要提示：</strong></p>
                <ul>
                    <li>在调度器挂起状态下，不能调用可能导致任务切换的API函数</li>
                    <li>获取调度器状态的操作本身是线程安全的</li>
                    <li>在中断服务程序中也可以调用<code>xTaskGetSchedulerState()</code></li>
                    <li>调度器状态信息对于系统监控和性能分析非常有用</li>
                </ul>
            </div>
        </section>

        <section class="architecture">
            <h2>FreeRTOS调度器架构简图</h2>
            <div class="svg-container">
                <svg width="500" height="200" viewBox="0 0 500 200">
                    <rect x="50" y="20" width="400" height="40" rx="5" ry="5" 
                          fill="#bbdefb" stroke="#1976d2" stroke-width="2"/>
                    <text x="250" y="45" text-anchor="middle" fill="#0d47a1" font-weight="bold">FreeRTOS内核</text>
                    
                    <rect x="100" y="80" width="120" height="40" rx="5" ry="5" 
                          fill="#c8e6c9" stroke="#388e3c" stroke-width="2"/>
                    <text x="160" y="105" text-anchor="middle" fill="#1b5e20">任务管理</text>
                    
                    <rect x="240" y="80" width="120" height="40" rx="5" ry="5" 
                          fill="#ffecb3" stroke="#ffa000" stroke-width="2"/>
                    <text x="300" y="105" text-anchor="middle" fill="#e65100">调度器</text>
                    
                    <rect x="100" y="140" width="120" height="40" rx="5" ry="5" 
                          fill="#f8bbd0" stroke="#ad1457" stroke-width="2"/>
                    <text x="160" y="165" text-anchor="middle" fill="#880e4f">就绪列表</text>
                    
                    <rect x="240" y="140" width="120" height="40" rx="5" ry="5" 
                          fill="#d1c4e9" stroke="#4527a0" stroke-width="2"/>
                    <text x="300" y="165" text-anchor="middle" fill="#311b92">状态查询</text>
                    
                    <!-- 连接线 -->
                    <path d="M 160 60 L 160 80" stroke="#1976d2" stroke-width="2"/>
                    <path d="M 300 60 L 300 80" stroke="#1976d2" stroke-width="2"/>
                    <path d="M 160 120 L 160 140" stroke="#1976d2" stroke-width="2"/>
                    <path d="M 300 120 L 300 140" stroke="#1976d2" stroke-width="2"/>
                </svg>
            </div>
        </section>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>