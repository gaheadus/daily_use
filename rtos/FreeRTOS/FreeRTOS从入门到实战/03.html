<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeRTOS内核初探 - 《FreeRTOS从入门到实战》</title>
    <style>
        :root {
            --tech-blue: #3498db;
            --vitality-orange: #f39c12;
            --fresh-green: #2ecc71;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: var(--dark-text);
            line-height: 1.6;
            padding-bottom: 60px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(90deg, var(--tech-blue), var(--fresh-green));
            color: white;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: var(--card-shadow);
        }
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--tech-blue);
        }
        h2 {
            color: var(--tech-blue);
            border-bottom: 3px solid var(--vitality-orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: inline-block;
        }
        h3 {
            color: var(--fresh-green);
            margin: 20px 0 10px;
        }
        ul, ol {
            padding-left: 25px;
            margin: 15px 0;
        }
        li {
            margin-bottom: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: var(--tech-blue);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f8ff;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Consolas', monospace;
            border-left: 5px solid var(--vitality-orange);
        }
        code {
            background: #f1f1f1;
            padding: 3px 6px;
            border-radius: 4px;
            color: #d35400;
            font-family: 'Consolas', monospace;
        }
        .svg-container {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }
        .architecture-svg {
            width: 100%;
            max-width: 800px;
            height: auto;
        }
        .color-box {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 8px;
        }
        .blue { background-color: var(--tech-blue); }
        .orange { background-color: var(--vitality-orange); }
        .green { background-color: var(--fresh-green); }
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            background: linear-gradient(90deg, var(--tech-blue), #2980b9);
            color: white;
            border-radius: 16px;
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: var(--card-shadow);
        }
        .tip {
            background: #fff8e1;
            border-left: 5px solid var(--vitality-orange);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .note {
            background: #e8f5e9;
            border-left: 5px solid var(--fresh-green);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FreeRTOS内核初探</h1>
            <p class="subtitle">内核目录结构、核心源文件解析、可裁剪配置、内存管理策略概览</p>
            <p>《FreeRTOS从入门到实战》第三章</p>
        </header>

        <section>
            <h2><span class="color-box blue"></span>一、FreeRTOS内核目录结构</h2>
            <p>FreeRTOS源代码采用模块化设计，目录结构清晰，便于移植和裁剪。典型的内核目录结构如下：</p>
            <ul>
                <li><strong>FreeRTOS/</strong> - 根目录
                    <ul>
                        <li><strong>Source/</strong> - 核心源码目录
                            <ul>
                                <li><code>include/</code> - 公共头文件（API头文件）</li>
                                <li><code>tasks.c</code> - 任务管理核心实现</li>
                                <li><code>queue.c</code> - 队列和信号量实现</li>
                                <li><code>list.c</code> - 内核内部链表实现</li>
                                <li><code>timers.c</code> - 软件定时器实现</li>
                                <li><code>event_groups.c</code> - 事件组实现</li>
                                <li><code>portable/</code> - 移植层代码
                                    <ul>
                                        <li><code>MemMang/</code> - 内存管理方案（heap_1~5.c）</li>
                                        <li><code>GCC/ARM_CM4F/</code> - Cortex-M4F移植示例</li>
                                        <li><code>IAR/ARM_CM3/</code> - Cortex-M3移植示例</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Demo/</strong> - 各种MCU的演示项目</li>
                        <li><strong>License/</strong> - 许可证文件</li>
                    </ul>
                </li>
            </ul>
            <div class="note">
                <strong>提示：</strong> 实际开发中，我们通常只将<code>Source/</code>目录下的核心文件及对应移植层文件加入工程。
            </div>
        </section>

        <section>
            <h2><span class="color-box orange"></span>二、核心源文件解析</h2>
            <p>FreeRTOS内核由几个关键源文件构成，每个文件负责不同的核心功能。</p>
            <table>
                <thead>
                    <tr>
                        <th>源文件</th>
                        <th>主要功能</th>
                        <th>依赖关系</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>tasks.c</code></td>
                        <td>任务创建、删除、调度、优先级管理、任务切换</td>
                        <td>list.c, portable层</td>
                    </tr>
                    <tr>
                        <td><code>queue.c</code></td>
                        <td>队列、信号量、互斥量的实现，任务间通信基础</td>
                        <td>tasks.c</td>
                    </tr>
                    <tr>
                        <td><code>list.c</code></td>
                        <td>内核双向链表实现，为任务、队列等提供数据结构支持</td>
                        <td>独立（无RTOS依赖）</td>
                    </tr>
                    <tr>
                        <td><code>timers.c</code></td>
                        <td>软件定时器服务，基于任务调度实现</td>
                        <td>tasks.c, queue.c</td>
                    </tr>
                    <tr>
                        <td><code>event_groups.c</code></td>
                        <td>事件标志组，用于任务间同步</td>
                        <td>tasks.c</td>
                    </tr>
                    <tr>
                        <td><code>heap_x.c</code></td>
                        <td>内存管理策略（共5种可选）</td>
                        <td>portable层</td>
                    </tr>
                </tbody>
            </table>

            <div class="svg-container">
                <h3>内核核心文件依赖关系图</h3>
                <svg class="architecture-svg" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="800" height="400" fill="#f8fafc" rx="10"/>
                    <!-- Tasks.c -->
                    <rect x="100" y="50" width="120" height="60" rx="8" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
                    <text x="160" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="16">tasks.c</text>
                    <text x="160" y="105" text-anchor="middle" fill="#ecf0f1" font-size="12">任务调度核心</text>
                    
                    <!-- queue.c -->
                    <rect x="300" y="50" width="120" height="60" rx="8" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/>
                    <text x="360" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="16">queue.c</text>
                    <text x="360" y="105" text-anchor="middle" fill="#ecf0f1" font-size="12">通信机制</text>
                    
                    <!-- list.c -->
                    <rect x="500" y="50" width="120" height="60" rx="8" fill="#9b59b6" stroke="#8e44ad" stroke-width="2"/>
                    <text x="560" y="85" text-anchor="middle" fill="white" font-weight="bold" font-size="16">list.c</text>
                    <text x="560" y="105" text-anchor="middle" fill="#ecf0f1" font-size="12">内核链表</text>
                    
                    <!-- 依赖箭头 -->
                    <line x1="220" y1="80" x2="300" y2="80" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                    <line x1="420" y1="80" x2="500" y2="80" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                    
                    <!-- 下层文件 -->
                    <rect x="50" y="200" width="140" height="50" rx="6" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
                    <text x="120" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">timers.c</text>
                    
                    <rect x="230" y="200" width="140" height="50" rx="6" fill="#1abc9c" stroke="#16a085" stroke-width="2"/>
                    <text x="300" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">event_groups.c</text>
                    
                    <rect x="410" y="200" width="140" height="50" rx="6" fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
                    <text x="480" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">heap_x.c</text>
                    
                    <rect x="590" y="200" width="140" height="50" rx="6" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
                    <text x="660" y="230" text-anchor="middle" fill="white" font-weight="bold" font-size="14">port.c</text>
                    
                    <!-- 上层依赖箭头 -->
                    <line x1="160" y1="110" x2="120" y2="200" stroke="#7f8c8d" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="360" y1="110" x2="300" y2="200" stroke="#7f8c8d" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="160" y1="110" x2="480" y2="200" stroke="#7f8c8d" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="160" y1="110" x2="660" y2="200" stroke="#7f8c8d" stroke-width="2" stroke-dasharray="5,5"/>
                    
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>

        <section>
            <h2><span class="color-box green"></span>三、可裁剪配置（FreeRTOSConfig.h）</h2>
            <p><code>FreeRTOSConfig.h</code>是FreeRTOS的配置文件，位于用户项目目录中，用于裁剪内核功能、设置系统参数。</p>
            
            <h3>关键配置选项分类：</h3>
            <ol>
                <li><strong>内核行为配置</strong>
                    <ul>
                        <li><code>configUSE_PREEMPTION</code> - 启用(1)或禁用(0)抢占式调度</li>
                        <li><code>configUSE_TIME_SLICING</code> - 时间片轮转调度开关</li>
                        <li><code>configUSE_IDLE_HOOK</code> - 空闲任务钩子函数</li>
                    </ul>
                </li>
                <li><strong>资源大小配置</strong>
                    <ul>
                        <li><code>configMAX_PRIORITIES</code> - 最大任务优先级数（通常5~32）</li>
                        <li><code>configMINIMAL_STACK_SIZE</code> - 空闲任务栈大小（字为单位）</li>
                        <li><code>configTOTAL_HEAP_SIZE</code> - 内核动态内存总大小</li>
                    </ul>
                </li>
                <li><strong>功能模块开关</strong>
                    <ul>
                        <li><code>configUSE_QUEUE_SETS</code> - 队列集功能</li>
                        <li><code>configUSE_TIMERS</code> - 软件定时器</li>
                        <li><code>configUSE_MUTEXES</code> - 互斥信号量</li>
                    </ul>
                </li>
            </ol>

            <h3>配置示例：</h3>
            <pre>
/* FreeRTOSConfig.h 典型配置片段 */
#define configUSE_PREEMPTION            1   /* 使用抢占式调度 */
#define configUSE_PORT_OPTIMISED_TASK_SELECTION  1   /* 使用硬件优化 */
#define configUSE_TICKLESS_IDLE         0   /* 低功耗模式 */
#define configCPU_CLOCK_HZ              ( SystemCoreClock )  /* CPU频率 */
#define configTICK_RATE_HZ              ( ( TickType_t ) 1000 ) /* 系统节拍1ms */
#define configMAX_PRIORITIES            ( 5 )   /* 最大优先级 */
#define configMINIMAL_STACK_SIZE        ( ( unsigned short ) 128 ) /* 空闲任务栈 */
#define configTOTAL_HEAP_SIZE           ( ( size_t ) ( 10 * 1024 ) ) /* 堆大小10KB */
#define configMAX_TASK_NAME_LEN         ( 16 )  /* 任务名最大长度 */
#define configUSE_16_BIT_TICKS          0   /* 32位Tick计数器 */
#define configIDLE_SHOULD_YIELD         1   /* 空闲任务让步 */
#define configUSE_MUTEXES               1   /* 使用互斥量 */
#define configUSE_RECURSIVE_MUTEXES     1   /* 使用递归互斥量 */
#define configUSE_COUNTING_SEMAPHORES   1   /* 使用计数信号量 */
#define configUSE_ALTERNATIVE_API       0   /* 不使用替代API */
#define configCHECK_FOR_STACK_OVERFLOW  2   /* 栈溢出检测级别 */
            </pre>
            <div class="tip">
                <strong>裁剪建议：</strong> 根据项目需求关闭不必要的功能（如软件定时器、事件组等），可显著减少内核ROM/RAM占用。
            </div>
        </section>

        <section>
            <h2><span class="color-box blue"></span>四、内存管理策略概览</h2>
            <p>FreeRTOS提供了5种内存管理方案（heap_1.c ~ heap_5.c），位于<code>portable/MemMang/</code>目录。</p>
            
            <table>
                <thead>
                    <tr>
                        <th>方案</th>
                        <th>特点</th>
                        <th>适用场景</th>
                        <th>碎片化</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>heap_1.c</strong></td>
                        <td>只分配，不释放。实现简单，确定性好。</td>
                        <td>任务/队列创建后永不删除的简单系统</td>
                        <td>无</td>
                    </tr>
                    <tr>
                        <td><strong>heap_2.c</strong></td>
                        <td>最佳匹配算法，可释放内存但不会合并相邻空闲块。</td>
                        <td>重复创建删除相同大小任务的场景（已过时）</td>
                        <td>可能产生</td>
                    </tr>
                    <tr>
                        <td><strong>heap_3.c</strong></td>
                        <td>封装标准库的malloc/free，增加线程安全性。</td>
                        <td>使用系统自带内存管理的环境</td>
                        <td>依赖库实现</td>
                    </tr>
                    <tr>
                        <td><strong>heap_4.c</strong></td>
                        <td>首次适应算法，合并相邻空闲块，减少碎片。</td>
                        <td>通用场景，最常用推荐方案</td>
                        <td>较少</td>
                    </tr>
                    <tr>
                        <td><strong>heap_5.c</strong></td>
                        <td>在heap_4基础上支持非连续内存块管理。</td>
                        <td>内存分布在多个不连续区域的复杂系统</td>
                        <td>较少</td>
                    </tr>
                </tbody>
            </table>

            <div class="svg-container">
                <h3>内存分配策略示意图（heap_4为例）</h3>
                <svg viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg">
                    <rect x="50" y="50" width="700" height="200" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2" rx="5"/>
                    
                    <!-- 已分配块 -->
                    <rect x="60" y="60" width="100" height="180" fill="#3498db" stroke="#2980b9" stroke-width="1"/>
                    <text x="110" y="150" text-anchor="middle" fill="white" font-size="14">任务1栈</text>
                    
                    <rect x="170" y="60" width="80" height="180" fill="#2ecc71" stroke="#27ae60" stroke-width="1"/>
                    <text x="210" y="150" text-anchor="middle" fill="white" font-size="14">队列</text>
                    
                    <rect x="260" y="60" width="120" height="180" fill="#9b59b6" stroke="#8e44ad" stroke-width="1"/>
                    <text x="320" y="150" text-anchor="middle" fill="white" font-size="14">任务2栈</text>
                    
                    <!-- 空闲块 -->
                    <rect x="390" y="60" width="150" height="180" fill="#f1c40f" stroke="#f39c12" stroke-width="1"/>
                    <text x="465" y="150" text-anchor="middle" fill="black" font-size="14">空闲块（可合并）</text>
                    
                    <rect x="550" y="60" width="90" height="180" fill="#f1c40f" stroke="#f39c12" stroke-width="1"/>
                    <text x="595" y="150" text-anchor="middle" fill="black" font-size="14">空闲块</text>
                    
                    <rect x="650" y="60" width="90" height="180" fill="#e74c3c" stroke="#c0392b" stroke-width="1"/>
                    <text x="695" y="150" text-anchor="middle" fill="white" font-size="14">TCB</text>
                    
                    <!-- 图例 -->
                    <rect x="50" y="270" width="20" height="20" fill="#3498db"/>
                    <text x="80" y="285" font-size="14">已分配内存</text>
                    
                    <rect x="200" y="270" width="20" height="20" fill="#f1c40f"/>
                    <text x="230" y="285" font-size="14">空闲内存</text>
                    
                    <rect x="350" y="270" width="20" height="20" fill="#e74c3c"/>
                    <text x="380" y="285" font-size="14">管理结构</text>
                    
                    <!-- 合并箭头 -->
                    <line x1="540" y1="150" x2="390" y2="150" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow2)"/>
                    <text x="465" y="130" text-anchor="middle" fill="#c0392b" font-size="12">heap_4可合并相邻空闲块</text>
                    
                    <defs>
                        <marker id="arrow2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#e74c3c"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            
            <div class="note">
                <strong>选择建议：</strong> 对于大多数应用，<code>heap_4.c</code>是最佳选择，它在碎片管理和效率之间取得了良好平衡。
            </div>
        </section>

        <section>
            <h2><span class="color-box orange"></span>本章小结</h2>
            <ul>
                <li>FreeRTOS目录结构清晰，核心文件分工明确，便于理解和移植。</li>
                <li><code>FreeRTOSConfig.h</code>是内核裁剪的关键，合理配置可优化系统资源。</li>
                <li>5种内存管理方案各有特点，<code>heap_4.c</code>适用于大多数嵌入式场景。</li>
                <li>掌握内核结构是深入理解FreeRTOS运行机制和进行系统调试的基础。</li>
            </ul>
            <p style="margin-top: 20px; font-style: italic; color: #7f8c8d;">
                下一章我们将深入探讨FreeRTOS的任务管理机制，包括任务创建、调度、状态转换等实战内容。
            </p>
        </section>

        <footer>
            蓝海资料掘金营
        </footer>
    </div>
</body>
</html>